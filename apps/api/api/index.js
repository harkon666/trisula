var Kc=Object.defineProperty;var Vc=(t,e)=>{for(var r in e)Kc(t,r,{get:e[r],enumerable:!0})};var In=t=>e=>t.fetch(e);var Dn=(t,e,r)=>(n,s)=>{let i=-1;return o(0);async function o(a){if(a<=i)throw new Error("next() called multiple times");i=a;let l,c=!1,d;if(t[a]?(d=t[a][0][0],n.req.routeIndex=a):d=a===t.length&&s||void 0,d)try{l=await d(n,()=>o(a+1))}catch(h){if(h instanceof Error&&e)n.error=h,l=await e(h,n),c=!0;else throw h}else n.finalized===!1&&r&&(l=await r(n));return l&&(n.finalized===!1||c)&&(n.res=l),n}};var To=Symbol();var Ao=async(t,e=Object.create(null))=>{let{all:r=!1,dot:n=!1}=e,i=(t instanceof Lr?t.raw.headers:t.headers).get("Content-Type");return i?.startsWith("multipart/form-data")||i?.startsWith("application/x-www-form-urlencoded")?Hc(t,{all:r,dot:n}):{}};async function Hc(t,e){let r=await t.formData();return r?Wc(r,e):{}}function Wc(t,e){let r=Object.create(null);return t.forEach((n,s)=>{e.all||s.endsWith("[]")?Jc(r,s,n):r[s]=n}),e.dot&&Object.entries(r).forEach(([n,s])=>{n.includes(".")&&(Gc(r,n,s),delete r[n])}),r}var Jc=(t,e,r)=>{t[e]!==void 0?Array.isArray(t[e])?t[e].push(r):t[e]=[t[e],r]:e.endsWith("[]")?t[e]=[r]:t[e]=r},Gc=(t,e,r)=>{let n=t,s=e.split(".");s.forEach((i,o)=>{o===s.length-1?n[i]=r:((!n[i]||typeof n[i]!="object"||Array.isArray(n[i])||n[i]instanceof File)&&(n[i]=Object.create(null)),n=n[i])})};var Ln=t=>{let e=t.split("/");return e[0]===""&&e.shift(),e},No=t=>{let{groups:e,path:r}=Yc(t),n=Ln(r);return Xc(n,e)},Yc=t=>{let e=[];return t=t.replace(/\{[^}]+\}/g,(r,n)=>{let s=`@${n}`;return e.push([s,r]),s}),{groups:e,path:t}},Xc=(t,e)=>{for(let r=e.length-1;r>=0;r--){let[n]=e[r];for(let s=t.length-1;s>=0;s--)if(t[s].includes(n)){t[s]=t[s].replace(n,e[r][1]);break}}return t},qr={},Po=(t,e)=>{if(t==="*")return"*";let r=t.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(r){let n=`${t}#${e}`;return qr[n]||(r[2]?qr[n]=e&&e[0]!==":"&&e[0]!=="*"?[n,r[1],new RegExp(`^${r[2]}(?=/${e})`)]:[t,r[1],new RegExp(`^${r[2]}$`)]:qr[n]=[t,r[1],!0]),qr[n]}return null},Fr=(t,e)=>{try{return e(t)}catch{return t.replace(/(?:%[0-9A-Fa-f]{2})+/g,r=>{try{return e(r)}catch{return r}})}},Zc=t=>Fr(t,decodeURI),qn=t=>{let e=t.url,r=e.indexOf("/",e.indexOf(":")+4),n=r;for(;n<e.length;n++){let s=e.charCodeAt(n);if(s===37){let i=e.indexOf("?",n),o=e.slice(r,i===-1?void 0:i);return Zc(o.includes("%25")?o.replace(/%25/g,"%2525"):o)}else if(s===63)break}return e.slice(r,n)};var xo=t=>{let e=qn(t);return e.length>1&&e.at(-1)==="/"?e.slice(0,-1):e},Ct=(t,e,...r)=>(r.length&&(e=Ct(e,...r)),`${t?.[0]==="/"?"":"/"}${t}${e==="/"?"":`${t?.at(-1)==="/"?"":"/"}${e?.[0]==="/"?e.slice(1):e}`}`),zr=t=>{if(t.charCodeAt(t.length-1)!==63||!t.includes(":"))return null;let e=t.split("/"),r=[],n="";return e.forEach(s=>{if(s!==""&&!/\:/.test(s))n+="/"+s;else if(/\:/.test(s))if(/\?/.test(s)){r.length===0&&n===""?r.push("/"):r.push(n);let i=s.replace("?","");n+="/"+i,r.push(n)}else n+="/"+s}),r.filter((s,i,o)=>o.indexOf(s)===i)},Bn=t=>/[%+]/.test(t)?(t.indexOf("+")!==-1&&(t=t.replace(/\+/g," ")),t.indexOf("%")!==-1?Fr(t,Fn):t):t,Eo=(t,e,r)=>{let n;if(!r&&e&&!/[%+]/.test(e)){let o=t.indexOf("?",8);if(o===-1)return;for(t.startsWith(e,o+1)||(o=t.indexOf(`&${e}`,o+1));o!==-1;){let a=t.charCodeAt(o+e.length+1);if(a===61){let l=o+e.length+2,c=t.indexOf("&",l);return Bn(t.slice(l,c===-1?void 0:c))}else if(a==38||isNaN(a))return"";o=t.indexOf(`&${e}`,o+1)}if(n=/[%+]/.test(t),!n)return}let s={};n??=/[%+]/.test(t);let i=t.indexOf("?",8);for(;i!==-1;){let o=t.indexOf("&",i+1),a=t.indexOf("=",i);a>o&&o!==-1&&(a=-1);let l=t.slice(i+1,a===-1?o===-1?void 0:o:a);if(n&&(l=Bn(l)),i=o,l==="")continue;let c;a===-1?c="":(c=t.slice(a+1,o===-1?void 0:o),n&&(c=Bn(c))),r?(s[l]&&Array.isArray(s[l])||(s[l]=[]),s[l].push(c)):s[l]??=c}return e?s[e]:s},$o=Eo,_o=(t,e)=>Eo(t,e,!0),Fn=decodeURIComponent;var Oo=t=>Fr(t,Fn),Lr=class{raw;#t;#e;routeIndex=0;path;bodyCache={};constructor(t,e="/",r=[[]]){this.raw=t,this.path=e,this.#e=r,this.#t={}}param(t){return t?this.#r(t):this.#i()}#r(t){let e=this.#e[0][this.routeIndex][1][t],r=this.#s(e);return r&&/\%/.test(r)?Oo(r):r}#i(){let t={},e=Object.keys(this.#e[0][this.routeIndex][1]);for(let r of e){let n=this.#s(this.#e[0][this.routeIndex][1][r]);n!==void 0&&(t[r]=/\%/.test(n)?Oo(n):n)}return t}#s(t){return this.#e[1]?this.#e[1][t]:t}query(t){return $o(this.url,t)}queries(t){return _o(this.url,t)}header(t){if(t)return this.raw.headers.get(t)??void 0;let e={};return this.raw.headers.forEach((r,n)=>{e[n]=r}),e}async parseBody(t){return this.bodyCache.parsedBody??=await Ao(this,t)}#n=t=>{let{bodyCache:e,raw:r}=this,n=e[t];if(n)return n;let s=Object.keys(e)[0];return s?e[s].then(i=>(s==="json"&&(i=JSON.stringify(i)),new Response(i)[t]())):e[t]=r[t]()};json(){return this.#n("text").then(t=>JSON.parse(t))}text(){return this.#n("text")}arrayBuffer(){return this.#n("arrayBuffer")}blob(){return this.#n("blob")}formData(){return this.#n("formData")}addValidatedData(t,e){this.#t[t]=e}valid(t){return this.#t[t]}get url(){return this.raw.url}get method(){return this.raw.method}get[To](){return this.#e}get matchedRoutes(){return this.#e[0].map(([[,t]])=>t)}get routePath(){return this.#e[0].map(([[,t]])=>t)[this.routeIndex].path}};var Ro={Stringify:1,BeforeStream:2,Stream:3},eu=(t,e)=>{let r=new String(t);return r.isEscaped=!0,r.callbacks=e,r};var zn=async(t,e,r,n,s)=>{typeof t=="object"&&!(t instanceof String)&&(t instanceof Promise||(t=t.toString()),t instanceof Promise&&(t=await t));let i=t.callbacks;if(!i?.length)return Promise.resolve(t);s?s[0]+=t:s=[t];let o=Promise.all(i.map(a=>a({phase:e,buffer:s,context:n}))).then(a=>Promise.all(a.filter(Boolean).map(l=>zn(l,e,!1,n,s))).then(()=>s[0]));return r?eu(await o,i):o};var tu="text/plain; charset=UTF-8",Qn=(t,e)=>({"Content-Type":t,...e}),jo=class{#t;#e;env={};#r;finalized=!1;error;#i;#s;#n;#u;#l;#c;#a;#d;#f;constructor(t,e){this.#t=t,e&&(this.#s=e.executionCtx,this.env=e.env,this.#c=e.notFoundHandler,this.#f=e.path,this.#d=e.matchResult)}get req(){return this.#e??=new Lr(this.#t,this.#f,this.#d),this.#e}get event(){if(this.#s&&"respondWith"in this.#s)return this.#s;throw Error("This context has no FetchEvent")}get executionCtx(){if(this.#s)return this.#s;throw Error("This context has no ExecutionContext")}get res(){return this.#n||=new Response(null,{headers:this.#a??=new Headers})}set res(t){if(this.#n&&t){t=new Response(t.body,t);for(let[e,r]of this.#n.headers.entries())if(e!=="content-type")if(e==="set-cookie"){let n=this.#n.headers.getSetCookie();t.headers.delete("set-cookie");for(let s of n)t.headers.append("set-cookie",s)}else t.headers.set(e,r)}this.#n=t,this.finalized=!0}render=(...t)=>(this.#l??=e=>this.html(e),this.#l(...t));setLayout=t=>this.#u=t;getLayout=()=>this.#u;setRenderer=t=>{this.#l=t};header=(t,e,r)=>{this.finalized&&(this.#n=new Response(this.#n.body,this.#n));let n=this.#n?this.#n.headers:this.#a??=new Headers;e===void 0?n.delete(t):r?.append?n.append(t,e):n.set(t,e)};status=t=>{this.#i=t};set=(t,e)=>{this.#r??=new Map,this.#r.set(t,e)};get=t=>this.#r?this.#r.get(t):void 0;get var(){return this.#r?Object.fromEntries(this.#r):{}}#o(t,e,r){let n=this.#n?new Headers(this.#n.headers):this.#a??new Headers;if(typeof e=="object"&&"headers"in e){let i=e.headers instanceof Headers?e.headers:new Headers(e.headers);for(let[o,a]of i)o.toLowerCase()==="set-cookie"?n.append(o,a):n.set(o,a)}if(r)for(let[i,o]of Object.entries(r))if(typeof o=="string")n.set(i,o);else{n.delete(i);for(let a of o)n.append(i,a)}let s=typeof e=="number"?e:e?.status??this.#i;return new Response(t,{status:s,headers:n})}newResponse=(...t)=>this.#o(...t);body=(t,e,r)=>this.#o(t,e,r);text=(t,e,r)=>!this.#a&&!this.#i&&!e&&!r&&!this.finalized?new Response(t):this.#o(t,e,Qn(tu,r));json=(t,e,r)=>this.#o(JSON.stringify(t),e,Qn("application/json",r));html=(t,e,r)=>{let n=s=>this.#o(s,e,Qn("text/html; charset=UTF-8",r));return typeof t=="object"?zn(t,Ro.Stringify,!1,{}).then(n):n(t)};redirect=(t,e)=>{let r=String(t);return this.header("Location",/[^\x00-\xFF]/.test(r)?encodeURI(r):r),this.newResponse(null,e??302)};notFound=()=>(this.#c??=()=>new Response,this.#c(this))};var ue="ALL",Io="all",Do=["get","post","put","delete","options","patch"],Qr="Can not add a route since the matcher is already built.",kr=class extends Error{};var Bo="__COMPOSED_HANDLER";var ru=t=>t.text("404 Not Found",404),Lo=(t,e)=>{if("getResponse"in t){let r=t.getResponse();return e.newResponse(r.body,r)}return console.error(t),e.text("Internal Server Error",500)},qo=class Fo{get;post;put;delete;options;patch;all;on;use;router;getPath;_basePath="/";#t="/";routes=[];constructor(e={}){[...Do,Io].forEach(i=>{this[i]=(o,...a)=>(typeof o=="string"?this.#t=o:this.#i(i,this.#t,o),a.forEach(l=>{this.#i(i,this.#t,l)}),this)}),this.on=(i,o,...a)=>{for(let l of[o].flat()){this.#t=l;for(let c of[i].flat())a.map(d=>{this.#i(c.toUpperCase(),this.#t,d)})}return this},this.use=(i,...o)=>(typeof i=="string"?this.#t=i:(this.#t="*",o.unshift(i)),o.forEach(a=>{this.#i(ue,this.#t,a)}),this);let{strict:n,...s}=e;Object.assign(this,s),this.getPath=n??!0?e.getPath??qn:xo}#e(){let e=new Fo({router:this.router,getPath:this.getPath});return e.errorHandler=this.errorHandler,e.#r=this.#r,e.routes=this.routes,e}#r=ru;errorHandler=Lo;route(e,r){let n=this.basePath(e);return r.routes.map(s=>{let i;r.errorHandler===Lo?i=s.handler:(i=async(o,a)=>(await Dn([],r.errorHandler)(o,()=>s.handler(o,a))).res,i[Bo]=s.handler),n.#i(s.method,s.path,i)}),this}basePath(e){let r=this.#e();return r._basePath=Ct(this._basePath,e),r}onError=e=>(this.errorHandler=e,this);notFound=e=>(this.#r=e,this);mount(e,r,n){let s,i;n&&(typeof n=="function"?i=n:(i=n.optionHandler,n.replaceRequest===!1?s=l=>l:s=n.replaceRequest));let o=i?l=>{let c=i(l);return Array.isArray(c)?c:[c]}:l=>{let c;try{c=l.executionCtx}catch{}return[l.env,c]};s||=(()=>{let l=Ct(this._basePath,e),c=l==="/"?0:l.length;return d=>{let h=new URL(d.url);return h.pathname=h.pathname.slice(c)||"/",new Request(h,d)}})();let a=async(l,c)=>{let d=await r(s(l.req.raw),...o(l));if(d)return d;await c()};return this.#i(ue,Ct(e,"*"),a),this}#i(e,r,n){e=e.toUpperCase(),r=Ct(this._basePath,r);let s={basePath:this._basePath,path:r,method:e,handler:n};this.router.add(e,r,[n,s]),this.routes.push(s)}#s(e,r){if(e instanceof Error)return this.errorHandler(e,r);throw e}#n(e,r,n,s){if(s==="HEAD")return(async()=>new Response(null,await this.#n(e,r,n,"GET")))();let i=this.getPath(e,{env:n}),o=this.router.match(s,i),a=new jo(e,{path:i,matchResult:o,env:n,executionCtx:r,notFoundHandler:this.#r});if(o[0].length===1){let c;try{c=o[0][0][0][0](a,async()=>{a.res=await this.#r(a)})}catch(d){return this.#s(d,a)}return c instanceof Promise?c.then(d=>d||(a.finalized?a.res:this.#r(a))).catch(d=>this.#s(d,a)):c??this.#r(a)}let l=Dn(o[0],this.errorHandler,this.#r);return(async()=>{try{let c=await l(a);if(!c.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return c.res}catch(c){return this.#s(c,a)}})()}fetch=(e,...r)=>this.#n(e,r[1],r[0],e.method);request=(e,r,n,s)=>e instanceof Request?this.fetch(r?new Request(e,r):e,n,s):(e=e.toString(),this.fetch(new Request(/^https?:\/\//.test(e)?e:`http://localhost${Ct("/",e)}`,r),n,s));fire=()=>{addEventListener("fetch",e=>{e.respondWith(this.#n(e.request,e,void 0,e.request.method))})}};var Ur=[];function kn(t,e){let r=this.buildAllMatchers(),n=((s,i)=>{let o=r[s]||r[ue],a=o[2][i];if(a)return a;let l=i.match(o[0]);if(!l)return[[],Ur];let c=l.indexOf("",1);return[o[1][c],l]});return this.match=n,n(t,e)}var Mr="[^/]+",er=".*",tr="(?:|/.*)",Tt=Symbol(),nu=new Set(".\\+*[^]$()");function su(t,e){return t.length===1?e.length===1?t<e?-1:1:-1:e.length===1||t===er||t===tr?1:e===er||e===tr?-1:t===Mr?1:e===Mr?-1:t.length===e.length?t<e?-1:1:e.length-t.length}var zo=class Un{#t;#e;#r=Object.create(null);insert(e,r,n,s,i){if(e.length===0){if(this.#t!==void 0)throw Tt;if(i)return;this.#t=r;return}let[o,...a]=e,l=o==="*"?a.length===0?["","",er]:["","",Mr]:o==="/*"?["","",tr]:o.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/),c;if(l){let d=l[1],h=l[2]||Mr;if(d&&l[2]&&(h===".*"||(h=h.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(h))))throw Tt;if(c=this.#r[h],!c){if(Object.keys(this.#r).some(y=>y!==er&&y!==tr))throw Tt;if(i)return;c=this.#r[h]=new Un,d!==""&&(c.#e=s.varIndex++)}!i&&d!==""&&n.push([d,c.#e])}else if(c=this.#r[o],!c){if(Object.keys(this.#r).some(d=>d.length>1&&d!==er&&d!==tr))throw Tt;if(i)return;c=this.#r[o]=new Un}c.insert(a,r,n,s,i)}buildRegExpStr(){let r=Object.keys(this.#r).sort(su).map(n=>{let s=this.#r[n];return(typeof s.#e=="number"?`(${n})@${s.#e}`:nu.has(n)?`\\${n}`:n)+s.buildRegExpStr()});return typeof this.#t=="number"&&r.unshift(`#${this.#t}`),r.length===0?"":r.length===1?r[0]:"(?:"+r.join("|")+")"}};var Qo=class{#t={varIndex:0};#e=new zo;insert(t,e,r){let n=[],s=[];for(let o=0;;){let a=!1;if(t=t.replace(/\{[^}]+\}/g,l=>{let c=`@\\${o}`;return s[o]=[c,l],o++,a=!0,c}),!a)break}let i=t.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let o=s.length-1;o>=0;o--){let[a]=s[o];for(let l=i.length-1;l>=0;l--)if(i[l].indexOf(a)!==-1){i[l]=i[l].replace(a,s[o][1]);break}}return this.#e.insert(i,e,n,this.#t,r),n}buildRegExp(){let t=this.#e.buildRegExpStr();if(t==="")return[/^$/,[],[]];let e=0,r=[],n=[];return t=t.replace(/#(\d+)|@(\d+)|\.\*\$/g,(s,i,o)=>i!==void 0?(r[++e]=Number(i),"$()"):(o!==void 0&&(n[Number(o)]=++e),"")),[new RegExp(`^${t}`),r,n]}};var iu=[/^$/,[],Object.create(null)],ko=Object.create(null);function Uo(t){return ko[t]??=new RegExp(t==="*"?"":`^${t.replace(/\/\*$|([.\\+*[^\]$()])/g,(e,r)=>r?`\\${r}`:"(?:|/.*)")}$`)}function ou(){ko=Object.create(null)}function au(t){let e=new Qo,r=[];if(t.length===0)return iu;let n=t.map(c=>[!/\*|\/:/.test(c[0]),...c]).sort(([c,d],[h,y])=>c?1:h?-1:d.length-y.length),s=Object.create(null);for(let c=0,d=-1,h=n.length;c<h;c++){let[y,S,$]=n[c];y?s[S]=[$.map(([E])=>[E,Object.create(null)]),Ur]:d++;let w;try{w=e.insert(S,d,y)}catch(E){throw E===Tt?new kr(S):E}y||(r[d]=$.map(([E,N])=>{let U=Object.create(null);for(N-=1;N>=0;N--){let[V,L]=w[N];U[V]=L}return[E,U]}))}let[i,o,a]=e.buildRegExp();for(let c=0,d=r.length;c<d;c++)for(let h=0,y=r[c].length;h<y;h++){let S=r[c][h]?.[1];if(!S)continue;let $=Object.keys(S);for(let w=0,E=$.length;w<E;w++)S[$[w]]=a[S[$[w]]]}let l=[];for(let c in o)l[c]=r[o[c]];return[i,l,s]}function It(t,e){if(t){for(let r of Object.keys(t).sort((n,s)=>s.length-n.length))if(Uo(r).test(e))return[...t[r]]}}var Kr=class{name="RegExpRouter";#t;#e;constructor(){this.#t={[ue]:Object.create(null)},this.#e={[ue]:Object.create(null)}}add(t,e,r){let n=this.#t,s=this.#e;if(!n||!s)throw new Error(Qr);n[t]||[n,s].forEach(a=>{a[t]=Object.create(null),Object.keys(a[ue]).forEach(l=>{a[t][l]=[...a[ue][l]]})}),e==="/*"&&(e="*");let i=(e.match(/\/:/g)||[]).length;if(/\*$/.test(e)){let a=Uo(e);t===ue?Object.keys(n).forEach(l=>{n[l][e]||=It(n[l],e)||It(n[ue],e)||[]}):n[t][e]||=It(n[t],e)||It(n[ue],e)||[],Object.keys(n).forEach(l=>{(t===ue||t===l)&&Object.keys(n[l]).forEach(c=>{a.test(c)&&n[l][c].push([r,i])})}),Object.keys(s).forEach(l=>{(t===ue||t===l)&&Object.keys(s[l]).forEach(c=>a.test(c)&&s[l][c].push([r,i]))});return}let o=zr(e)||[e];for(let a=0,l=o.length;a<l;a++){let c=o[a];Object.keys(s).forEach(d=>{(t===ue||t===d)&&(s[d][c]||=[...It(n[d],c)||It(n[ue],c)||[]],s[d][c].push([r,i-l+a+1]))})}}match=kn;buildAllMatchers(){let t=Object.create(null);return Object.keys(this.#e).concat(Object.keys(this.#t)).forEach(e=>{t[e]||=this.#r(e)}),this.#t=this.#e=void 0,ou(),t}#r(t){let e=[],r=t===ue;return[this.#t,this.#e].forEach(n=>{let s=n[t]?Object.keys(n[t]).map(i=>[i,n[t][i]]):[];s.length!==0?(r||=!0,e.push(...s)):t!==ue&&e.push(...Object.keys(n[ue]).map(i=>[i,n[ue][i]]))}),r?au(e):null}};var Mn=class{name="SmartRouter";#t=[];#e=[];constructor(t){this.#t=t.routers}add(t,e,r){if(!this.#e)throw new Error(Qr);this.#e.push([t,e,r])}match(t,e){if(!this.#e)throw new Error("Fatal error");let r=this.#t,n=this.#e,s=r.length,i=0,o;for(;i<s;i++){let a=r[i];try{for(let l=0,c=n.length;l<c;l++)a.add(...n[l]);o=a.match(t,e)}catch(l){if(l instanceof kr)continue;throw l}this.match=a.match.bind(a),this.#t=[a],this.#e=void 0;break}if(i===s)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,o}get activeRouter(){if(this.#e||this.#t.length!==1)throw new Error("No active router has been determined yet.");return this.#t[0]}};var rr=Object.create(null),Mo=class Ko{#t;#e;#r;#i=0;#s=rr;constructor(e,r,n){if(this.#e=n||Object.create(null),this.#t=[],e&&r){let s=Object.create(null);s[e]={handler:r,possibleKeys:[],score:0},this.#t=[s]}this.#r=[]}insert(e,r,n){this.#i=++this.#i;let s=this,i=No(r),o=[];for(let a=0,l=i.length;a<l;a++){let c=i[a],d=i[a+1],h=Po(c,d),y=Array.isArray(h)?h[0]:c;if(y in s.#e){s=s.#e[y],h&&o.push(h[1]);continue}s.#e[y]=new Ko,h&&(s.#r.push(h),o.push(h[1])),s=s.#e[y]}return s.#t.push({[e]:{handler:n,possibleKeys:o.filter((a,l,c)=>c.indexOf(a)===l),score:this.#i}}),s}#n(e,r,n,s){let i=[];for(let o=0,a=e.#t.length;o<a;o++){let l=e.#t[o],c=l[r]||l[ue],d={};if(c!==void 0&&(c.params=Object.create(null),i.push(c),n!==rr||s&&s!==rr))for(let h=0,y=c.possibleKeys.length;h<y;h++){let S=c.possibleKeys[h],$=d[c.score];c.params[S]=s?.[S]&&!$?s[S]:n[S]??s?.[S],d[c.score]=!0}}return i}search(e,r){let n=[];this.#s=rr;let i=[this],o=Ln(r),a=[];for(let l=0,c=o.length;l<c;l++){let d=o[l],h=l===c-1,y=[];for(let S=0,$=i.length;S<$;S++){let w=i[S],E=w.#e[d];E&&(E.#s=w.#s,h?(E.#e["*"]&&n.push(...this.#n(E.#e["*"],e,w.#s)),n.push(...this.#n(E,e,w.#s))):y.push(E));for(let N=0,U=w.#r.length;N<U;N++){let V=w.#r[N],L=w.#s===rr?{}:{...w.#s};if(V==="*"){let q=w.#e["*"];q&&(n.push(...this.#n(q,e,w.#s)),q.#s=L,y.push(q));continue}let[z,J,j]=V;if(!d&&!(j instanceof RegExp))continue;let D=w.#e[z],le=o.slice(l).join("/");if(j instanceof RegExp){let q=j.exec(le);if(q){if(L[J]=q[0],n.push(...this.#n(D,e,w.#s,L)),Object.keys(D.#e).length){D.#s=L;let T=q[0].match(/\//)?.length??0;(a[T]||=[]).push(D)}continue}}(j===!0||j.test(d))&&(L[J]=d,h?(n.push(...this.#n(D,e,L,w.#s)),D.#e["*"]&&n.push(...this.#n(D.#e["*"],e,L,w.#s))):(D.#s=L,y.push(D)))}}i=y.concat(a.shift()??[])}return n.length>1&&n.sort((l,c)=>l.score-c.score),[n.map(({handler:l,params:c})=>[l,c])]}};var Kn=class{name="TrieRouter";#t;constructor(){this.#t=new Mo}add(t,e,r){let n=zr(e);if(n){for(let s=0,i=n.length;s<i;s++)this.#t.insert(t,n[s],r);return}this.#t.insert(t,e,r)}match(t,e){return this.#t.search(t,e)}};var Be=class extends qo{constructor(t={}){super(t),this.router=t.router??new Mn({routers:[new Kr,new Kn]})}};function lu(){let{process:t,Deno:e}=globalThis;return!(typeof e?.noColor=="boolean"?e.noColor:t!==void 0?"NO_COLOR"in t?.env:!1)}async function Vo(){let{navigator:t}=globalThis,e="cloudflare:workers";return!(t!==void 0&&t.userAgent==="Cloudflare-Workers"?await(async()=>{try{return"NO_COLOR"in((await import(e)).env??{})}catch{return!1}})():!lu())}var cu=t=>{let[e,r]=[",","."];return t.map(s=>s.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1"+e)).join(r)},uu=t=>{let e=Date.now()-t;return cu([e<1e3?e+"ms":Math.round(e/1e3)+"s"])},du=async t=>{if(await Vo())switch(t/100|0){case 5:return`\x1B[31m${t}\x1B[0m`;case 4:return`\x1B[33m${t}\x1B[0m`;case 3:return`\x1B[36m${t}\x1B[0m`;case 2:return`\x1B[32m${t}\x1B[0m`}return`${t}`};async function Ho(t,e,r,n,s=0,i){let o=e==="<--"?`${e} ${r} ${n}`:`${e} ${r} ${n} ${await du(s)} ${i}`;t(o)}var Wo=(t=console.log)=>async function(r,n){let{method:s,url:i}=r.req,o=i.slice(i.indexOf("/",8));await Ho(t,"<--",s,o);let a=Date.now();await n(),await Ho(t,"-->",s,o,r.res.status,uu(a))};var Jo=t=>{let r={...{origin:"*",allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],allowHeaders:[],exposeHeaders:[]},...t},n=(i=>typeof i=="string"?i==="*"?()=>i:o=>i===o?o:null:typeof i=="function"?i:o=>i.includes(o)?o:null)(r.origin),s=(i=>typeof i=="function"?i:Array.isArray(i)?()=>i:()=>[])(r.allowMethods);return async function(o,a){function l(d,h){o.res.headers.set(d,h)}let c=await n(o.req.header("origin")||"",o);if(c&&l("Access-Control-Allow-Origin",c),r.credentials&&l("Access-Control-Allow-Credentials","true"),r.exposeHeaders?.length&&l("Access-Control-Expose-Headers",r.exposeHeaders.join(",")),o.req.method==="OPTIONS"){r.origin!=="*"&&l("Vary","Origin"),r.maxAge!=null&&l("Access-Control-Max-Age",r.maxAge.toString());let d=await s(o.req.header("origin")||"",o);d.length&&l("Access-Control-Allow-Methods",d.join(","));let h=r.allowHeaders;if(!h?.length){let y=o.req.header("Access-Control-Request-Headers");y&&(h=y.split(/\s*,\s*/))}return h?.length&&(l("Access-Control-Allow-Headers",h.join(",")),o.res.headers.append("Vary","Access-Control-Request-Headers")),o.res.headers.delete("Content-Length"),o.res.headers.delete("Content-Type"),new Response(null,{headers:o.res.headers,status:204,statusText:"No Content"})}await a(),r.origin!=="*"&&o.header("Vary","Origin",{append:!0})}};import kl from"bcryptjs";import{zValidator as bd}from"@hono/zod-validator";import{z as H}from"zod";var fu=H.enum(["user","agent","admin","super_admin"]),mu=H.enum(["pending","active","suspended"]),hu=H.enum(["system","admin","redeem"]),pu=H.enum(["pending","processing","completed","rejected"]),gu=H.object({id:H.uuid(),email:H.string().email("Format email tidak valid"),name:H.string().min(2,"Nama terlalu pendek"),phone:H.string().min(10,"Nomor telepon tidak valid"),city:H.string().optional(),walletAddress:H.string().regex(/^0x[a-fA-F0-9]{40}$/,"Format wallet address Base tidak valid"),role:fu.default("user"),status:mu.default("pending"),createdAt:H.date().optional(),updatedAt:H.date().optional()}),Go=gu.omit({id:!0,status:!0,createdAt:!0,updatedAt:!0,role:!0}).extend({password:H.string().min(8,"Password minimal 8 karakter").optional(),referralCode:H.string().optional()}),im=H.object({id:H.uuid(),userId:H.uuid(),referralCode:H.string().min(3),isActive:H.boolean().default(!0)}),yu=H.object({id:H.uuid(),userId:H.uuid(),amount:H.number().int(),reason:H.string().min(5,"Alasan harus jelas"),source:hu,adminId:H.uuid().nullable(),txHash:H.string().nullable()}),om=yu.pick({userId:!0,amount:!0,reason:!0}).extend({}),am=H.object({id:H.uuid(),userId:H.uuid(),rewardId:H.number().int(),pointsUsed:H.number().int().positive(),whatsappNumber:H.string(),status:pu.default("pending"),txHash:H.string().nullable()});import Qu from"os";import ku from"fs";var Vr=new Map,Vn=new Map,Hn=Symbol("OriginError"),Dt={},ke=class extends Promise{constructor(e,r,n,s,i={}){let o,a;super((l,c)=>{o=l,a=c}),this.tagged=Array.isArray(e.raw),this.strings=e,this.args=r,this.handler=n,this.canceller=s,this.options=i,this.state=null,this.statement=null,this.resolve=l=>(this.active=!1,o(l)),this.reject=l=>(this.active=!1,a(l)),this.active=!1,this.cancelled=null,this.executed=!1,this.signature="",this[Hn]=this.handler.debug?new Error:this.tagged&&wu(this.strings)}get origin(){return(this.handler.debug?this[Hn].stack:this.tagged&&Vn.has(this.strings)?Vn.get(this.strings):Vn.set(this.strings,this[Hn].stack).get(this.strings))||""}static get[Symbol.species](){return Promise}cancel(){return this.canceller&&(this.canceller(this),this.canceller=null)}simple(){return this.options.simple=!0,this.options.prepare=!1,this}async readable(){return this.simple(),this.streaming=!0,this}async writable(){return this.simple(),this.streaming=!0,this}cursor(e=1,r){if(this.options.simple=!1,typeof e=="function"&&(r=e,e=1),this.cursorRows=e,typeof r=="function")return this.cursorFn=r,this;let n;return{[Symbol.asyncIterator]:()=>({next:()=>{if(this.executed&&!this.active)return{done:!0};n&&n();let s=new Promise((i,o)=>{this.cursorFn=a=>(i({value:a,done:!1}),new Promise(l=>n=l)),this.resolve=()=>(this.active=!1,i({done:!0})),this.reject=a=>(this.active=!1,o(a))});return this.execute(),s},return(){return n&&n(Dt),{done:!0}}})}}describe(){return this.options.simple=!1,this.onlyDescribe=this.options.prepare=!0,this}stream(){throw new Error(".stream has been renamed to .forEach")}forEach(e){return this.forEachFn=e,this.handle(),this}raw(){return this.isRaw=!0,this}values(){return this.isRaw="values",this}async handle(){!this.executed&&(this.executed=!0)&&await 1&&this.handler(this)}execute(){return this.handle(),this}then(){return this.handle(),super.then.apply(this,arguments)}catch(){return this.handle(),super.catch.apply(this,arguments)}finally(){return this.handle(),super.finally.apply(this,arguments)}};function wu(t){if(Vr.has(t))return Vr.get(t);let e=Error.stackTraceLimit;return Error.stackTraceLimit=4,Vr.set(t,new Error),Error.stackTraceLimit=e,Vr.get(t)}var At=class extends Error{constructor(e){super(e.message),this.name=this.constructor.name,Object.assign(this,e)}},ye={connection:Yo,postgres:Xo,generic:Zo,notSupported:ea};function Yo(t,e,r){let{host:n,port:s}=r||e,i=Object.assign(new Error("write "+t+" "+(e.path||n+":"+s)),{code:t,errno:t,address:e.path||n},e.path?{}:{port:s});return Error.captureStackTrace(i,Yo),i}function Xo(t){let e=new At(t);return Error.captureStackTrace(e,Xo),e}function Zo(t,e){let r=Object.assign(new Error(t+": "+e),{code:t});return Error.captureStackTrace(r,Zo),r}function ea(t){let e=Object.assign(new Error(t+" (B) is not supported"),{code:"MESSAGE_NOT_SUPPORTED",name:t});return Error.captureStackTrace(e,ea),e}var bu={string:{to:25,from:null,serialize:t=>""+t},number:{to:0,from:[21,23,26,700,701],serialize:t=>""+t,parse:t=>+t},json:{to:114,from:[114,3802],serialize:t=>JSON.stringify(t),parse:t=>JSON.parse(t)},boolean:{to:16,from:16,serialize:t=>t===!0?"t":"f",parse:t=>t==="t"},date:{to:1184,from:[1082,1114,1184],serialize:t=>(t instanceof Date?t:new Date(t)).toISOString(),parse:t=>new Date(t)},bytea:{to:17,from:17,serialize:t=>"\\x"+Buffer.from(t).toString("hex"),parse:t=>Buffer.from(t.slice(2),"hex")}},nr=class{then(){Wn()}catch(){Wn()}finally(){Wn()}},Bt=class extends nr{constructor(e){super(),this.value=Gr(e)}},Ge=class extends nr{constructor(e,r,n){super(),this.value=e,this.type=r,this.array=n}},sr=class extends nr{constructor(e,r){super(),this.first=e,this.rest=r}build(e,r,n,s){let i=Su.map(([o,a])=>({fn:a,i:e.search(o)})).sort((o,a)=>o.i-a.i).pop();return i.i===-1?Zn(this.first,s):i.fn(this.first,this.rest,r,n,s)}};function Jr(t,e,r,n){let s=t instanceof Ge?t.value:t;if(s===void 0&&(t instanceof Ge?t.value=n.transform.undefined:s=t=n.transform.undefined,s===void 0))throw ye.generic("UNDEFINED_VALUE","Undefined values are not allowed");return"$"+r.push(t instanceof Ge?(e.push(t.value),t.array?t.array[t.type||Wr(t.value)]||t.type||sa(t.value):t.type):(e.push(t),Wr(t)))}var ra=oa(bu);function Yn(t,e,r,n,s,i){for(let o=1;o<t.strings.length;o++)e+=Xn(e,r,n,s,i)+t.strings[o],r=t.args[o];return e}function Xn(t,e,r,n,s){return e instanceof sr?e.build(t,r,n,s):e instanceof ke?Gn(e,r,n,s):e instanceof Bt?e.value:e&&e[0]instanceof ke?e.reduce((i,o)=>i+" "+Gn(o,r,n,s),""):Jr(e,r,n,s)}function Gn(t,e,r,n){return t.fragment=!0,Yn(t,t.strings[0],t.args[0],e,r,n)}function na(t,e,r,n,s){return t.map(i=>"("+n.map(o=>Xn("values",i[o],e,r,s)).join(",")+")").join(",")}function ta(t,e,r,n,s){let i=Array.isArray(t[0]),o=e.length?e.flat():Object.keys(i?t[0]:t);return na(i?t:[t],r,n,o,s)}function Hr(t,e,r,n,s){if(typeof t=="string"&&(t=[t].concat(e)),Array.isArray(t))return Zn(t,s);let i;return(e.length?e.flat():Object.keys(t)).map(a=>(i=t[a],(i instanceof ke?Gn(i,r,n,s):i instanceof Bt?i.value:Jr(i,r,n,s))+" as "+Gr(s.transform.column.to?s.transform.column.to(a):a))).join(",")}var Su=Object.entries({values:ta,in:(...t)=>{let e=ta(...t);return e==="()"?"(null)":e},select:Hr,as:Hr,returning:Hr,"\\(":Hr,update(t,e,r,n,s){return(e.length?e.flat():Object.keys(t)).map(i=>Gr(s.transform.column.to?s.transform.column.to(i):i)+"="+Xn("values",t[i],r,n,s))},insert(t,e,r,n,s){let i=e.length?e.flat():Object.keys(Array.isArray(t)?t[0]:t);return"("+Zn(i,s)+")values"+na(Array.isArray(t)?t:[t],r,n,i,s)}}).map(([t,e])=>[new RegExp("((?:^|[\\s(])"+t+"(?:$|[\\s(]))(?![\\s\\S]*\\1)","i"),e]);function Wn(){throw ye.generic("NOT_TAGGED_CALL","Query not called as a tagged template literal")}var vu=ra.serializers,Cu=ra.parsers;function sa(t){return Array.isArray(t)?sa(t[0]):typeof t=="string"?1009:0}var ia=function(t){let e=oa(t||{});return{serializers:Object.assign({},vu,e.serializers),parsers:Object.assign({},Cu,e.parsers)}};function oa(t){return Object.keys(t).reduce((e,r)=>(t[r].from&&[].concat(t[r].from).forEach(n=>e.parsers[n]=t[r].parse),t[r].serialize&&(e.serializers[t[r].to]=t[r].serialize,t[r].from&&[].concat(t[r].from).forEach(n=>e.serializers[n]=t[r].serialize)),e),{parsers:{},serializers:{}})}function Zn(t,{transform:{column:e}}){return t.map(r=>Gr(e.to?e.to(r):r)).join(",")}var Gr=function(e){return'"'+e.replace(/"/g,'""').replace(/\./g,'"."')+'"'},Wr=function t(e){return e instanceof Ge?e.type:e instanceof Date?1184:e instanceof Uint8Array?17:e===!0||e===!1?16:typeof e=="bigint"?20:Array.isArray(e)?t(e[0]):0},Tu=/\\/g,Au=/"/g;function Nu(t){return t.replace(Tu,"\\\\").replace(Au,'\\"')}var aa=function t(e,r,n,s){if(Array.isArray(e)===!1)return e;if(!e.length)return"{}";let i=e[0],o=s===1020?";":",";return Array.isArray(i)&&!i.type?"{"+e.map(a=>t(a,r,n,s)).join(o)+"}":"{"+e.map(a=>{if(a===void 0&&(a=n.transform.undefined,a===void 0))throw ye.generic("UNDEFINED_VALUE","Undefined values are not allowed");return a===null?"null":'"'+Nu(r?r(a.type?a.value:a):""+a)+'"'}).join(o)+"}"},Jn={i:0,char:null,str:"",quoted:!1,last:0},la=function(e,r,n){return Jn.i=Jn.last=0,ca(Jn,e,r,n)};function ca(t,e,r,n){let s=[],i=n===1020?";":",";for(;t.i<e.length;t.i++){if(t.char=e[t.i],t.quoted)t.char==="\\"?t.str+=e[++t.i]:t.char==='"'?(s.push(r?r(t.str):t.str),t.str="",t.quoted=e[t.i+1]==='"',t.last=t.i+2):t.str+=t.char;else if(t.char==='"')t.quoted=!0;else if(t.char==="{")t.last=++t.i,s.push(ca(t,e,r,n));else if(t.char==="}"){t.quoted=!1,t.last<t.i&&s.push(r?r(e.slice(t.last,t.i)):e.slice(t.last,t.i)),t.last=t.i+1;break}else t.char===i&&t.p!=="}"&&t.p!=='"'&&(s.push(r?r(e.slice(t.last,t.i)):e.slice(t.last,t.i)),t.last=t.i+1);t.p=t.char}return t.last<t.i&&s.push(r?r(e.slice(t.last,t.i+1)):e.slice(t.last,t.i+1)),s}var Nt=t=>{let e=t[0];for(let r=1;r<t.length;r++)e+=t[r]==="_"?t[++r].toUpperCase():t[r];return e},Pt=t=>{let e=t[0].toUpperCase();for(let r=1;r<t.length;r++)e+=t[r]==="_"?t[++r].toUpperCase():t[r];return e},xt=t=>t.replace(/_/g,"-"),ir=t=>t.replace(/([A-Z])/g,"_$1").toLowerCase(),or=t=>(t.slice(0,1)+t.slice(1).replace(/([A-Z])/g,"_$1")).toLowerCase(),ar=t=>t.replace(/-/g,"_");function es(t){return function e(r,n){return typeof r=="object"&&r!==null&&(n.type===114||n.type===3802)?Array.isArray(r)?r.map(s=>e(s,n)):Object.entries(r).reduce((s,[i,o])=>Object.assign(s,{[t(i)]:e(o,n)}),{}):r}}Nt.column={from:Nt};Nt.value={from:es(Nt)};ir.column={to:ir};var ts={...Nt};ts.column.to=ir;Pt.column={from:Pt};Pt.value={from:es(Pt)};or.column={to:or};var rs={...Pt};rs.column.to=or;xt.column={from:xt};xt.value={from:es(xt)};ar.column={to:ar};var ns={...xt};ns.column.to=ar;import ua from"net";import $u from"tls";import lr from"crypto";import ss from"stream";import{performance as da}from"perf_hooks";var yt=class extends Array{constructor(){super(),Object.defineProperties(this,{count:{value:null,writable:!0},state:{value:null,writable:!0},command:{value:null,writable:!0},columns:{value:null,writable:!0},statement:{value:null,writable:!0}})}static get[Symbol.species](){return Array}};var Ue=Pu;function Pu(t=[]){let e=t.slice(),r=0;return{get length(){return e.length-r},remove:n=>{let s=e.indexOf(n);return s===-1?null:(e.splice(s,1),n)},push:n=>(e.push(n),n),shift:()=>{let n=e[r++];return r===e.length?(r=0,e=[]):e[r-1]=void 0,n}}}var _e=Buffer.allocUnsafe(256),xu="BCcDdEFfHPpQSX".split("").reduce((t,e)=>{let r=e.charCodeAt(0);return t[e]=()=>(_e[0]=r,Z.i=5,Z),t},{}),Z=Object.assign(Eu,xu,{N:"\0",i:0,inc(t){return Z.i+=t,Z},str(t){let e=Buffer.byteLength(t);return Yr(e),Z.i+=_e.write(t,Z.i,e,"utf8"),Z},i16(t){return Yr(2),_e.writeUInt16BE(t,Z.i),Z.i+=2,Z},i32(t,e){return e||e===0?(_e.writeUInt32BE(t,e),Z):(Yr(4),_e.writeUInt32BE(t,Z.i),Z.i+=4,Z)},z(t){return Yr(t),_e.fill(0,Z.i,Z.i+t),Z.i+=t,Z},raw(t){return _e=Buffer.concat([_e.subarray(0,Z.i),t]),Z.i=_e.length,Z},end(t=1){_e.writeUInt32BE(Z.i-t,t);let e=_e.subarray(0,Z.i);return Z.i=0,_e=Buffer.allocUnsafe(256),e}}),O=Z;function Yr(t){if(_e.length-Z.i<t){let e=_e,r=e.length;_e=Buffer.allocUnsafe(r+(r>>1)+t),e.copy(_e)}}function Eu(){return Z.i=0,Z}var os=ha,_u=1,wt=O().S().end(),fa=O().H().end(),Ou=O().i32(8).i32(80877103).end(8),Ru=Buffer.concat([O().E().str(O.N).i32(0).end(),wt]),ju=O().D().str("S").str(O.N).end(),Lt=()=>{},Iu=new Set(["FetchPreparedStatement","RevalidateCachedQuery","transformAssignedExpr"]),Du={83:"severity_local",86:"severity",67:"code",77:"message",68:"detail",72:"hint",80:"position",112:"internal_position",113:"internal_query",87:"where",115:"schema_name",116:"table_name",99:"column_name",100:"data type_name",110:"constraint_name",70:"file",76:"line",82:"routine"};function ha(t,e={},{onopen:r=Lt,onend:n=Lt,onclose:s=Lt}={}){let{sslnegotiation:i,ssl:o,max:a,user:l,host:c,port:d,database:h,parsers:y,transform:S,onnotice:$,onnotify:w,onparameter:E,max_pipeline:N,keep_alive:U,backoff:V,target_session_attrs:L}=t,z=Ue(),J=_u++,j={pid:null,secret:null},D=is(Rn,t.idle_timeout),le=is(Rn,t.max_lifetime),q=is(sc,t.connect_timeout),T=null,Ne,de=null,F=new yt,ie=Buffer.alloc(0),et=t.fetch_types,Je={},b={},B=Math.random().toString(36).slice(2),oe=1,be=0,pe=0,k=0,G=0,fe=0,me=0,Se=0,Ie=null,re=null,it=!1,tt=null,pt=null,xe=null,ce=null,ne=null,Qe=null,Dr=null,_n=null,A=null,Gt=null,Ee={queue:e.closed,idleTimer:D,connect(u){xe=u,wo()},terminate:Zt,execute:Yt,cancel:ec,end:Rn,count:0,id:J};return e.closed&&e.closed.push(Ee),Ee;async function Zl(){let u;try{u=t.socket?await Promise.resolve(t.socket(t)):new ua.Socket}catch(p){jt(p);return}return u.on("error",jt),u.on("close",bo),u.on("drain",go),u}async function ec({pid:u,secret:p},I,W){try{Ne=O().i32(16).i32(80877102).i32(u).i32(p).end(16),await yo(),T.once("error",W),T.once("close",I)}catch(ge){W(ge)}}function Yt(u){if(it)return Xt(u,ye.connection("CONNECTION_DESTROYED",t));if(ne)return Xt(u,ye.generic("COPY_IN_PROGRESS","You cannot execute queries during copy"));if(!u.cancelled)try{return u.state=j,A?z.push(u):(A=u,A.active=!0),nc(u),Pe(tc(u))&&!u.describeFirst&&!u.cursorFn&&z.length<N&&(!u.options.onexecute||u.options.onexecute(Ee))}catch(p){return z.length===0&&Pe(wt),Ke(p),!0}}function tc(u){if(u.parameters.length>=65534)throw ye.generic("MAX_PARAMETERS_EXCEEDED","Max number of parameters (65534) exceeded");return u.options.simple?O().Q().str(u.statement.string+O.N).end():u.describeFirst?Buffer.concat([mo(u),fa]):u.prepare?u.prepared?Br(u):Buffer.concat([mo(u),Br(u)]):rc(u)}function mo(u){return Buffer.concat([vo(u.statement.string,u.parameters,u.statement.types,u.statement.name),kc("S",u.statement.name)])}function Br(u){return Buffer.concat([Qc(u.parameters,u.statement.types,u.statement.name,u.cursorName),u.cursorFn?Co("",u.cursorRows):Ru])}function rc(u){return Buffer.concat([vo(u.statement.string,u.parameters,u.statement.types),ju,Br(u)])}function nc(u){let p=[],I=[],W=Yn(u,u.strings[0],u.args[0],p,I,t);!u.tagged&&u.args.forEach(ge=>Jr(ge,p,I,t)),u.prepare=t.prepare&&("prepare"in u.options?u.options.prepare:!0),u.string=W,u.signature=u.prepare&&I+W,u.onlyDescribe&&delete b[u.signature],u.parameters=u.parameters||p,u.prepared=u.prepare&&u.signature in b,u.describeFirst=u.onlyDescribe||p.length&&!u.prepared,u.statement=u.prepared?b[u.signature]:{string:W,types:I,name:u.prepare?B+oe++:""},typeof t.debug=="function"&&t.debug(J,W,p,I)}function Pe(u,p){return Qe=Qe?Buffer.concat([Qe,u]):Buffer.from(u),p||Qe.length>=1024?ho(p):(re===null&&(re=setImmediate(ho)),!0)}function ho(u){let p=T.write(Qe,u);return re!==null&&clearImmediate(re),Qe=re=null,p}function sc(){Ke(ye.connection("CONNECT_TIMEOUT",t,T)),T.destroy()}async function po(){if(i!=="direct"&&(Pe(Ou),!await new Promise(I=>T.once("data",W=>I(W[0]===83)))&&o==="prefer"))return Rt();let u={socket:T,servername:ua.isIP(T.host)?void 0:T.host};i==="direct"&&(u.ALPNProtocols=["postgresql"]),o==="require"||o==="allow"||o==="prefer"?u.rejectUnauthorized=!1:typeof o=="object"&&Object.assign(u,o),T.removeAllListeners(),T=$u.connect(u),T.on("secureConnect",Rt),T.on("error",jt),T.on("close",bo),T.on("drain",go)}function go(){!A&&r(Ee)}function On(u){if(!(tt&&(tt.push(u),pe-=u.length,pe>0)))for(ie=tt?Buffer.concat(tt,fe-pe):ie.length===0?u:Buffer.concat([ie,u],ie.length+u.length);ie.length>4;){if(fe=ie.readUInt32BE(1),fe>=ie.length){pe=fe-ie.length,tt=[ie];break}try{ic(ie.subarray(0,fe+1))}catch(p){A&&(A.cursorFn||A.describeFirst)&&Pe(wt),Ke(p)}ie=ie.subarray(fe+1),pe=0,tt=null}}async function yo(){if(it=!1,Je={},T||(T=await Zl()),!!T){if(q.start(),t.socket)return o?po():Rt();if(T.on("connect",o?po:Rt),t.path)return T.connect(t.path);T.ssl=o,T.connect(d[k],c[k]),T.host=c[k],T.port=d[k],k=(k+1)%d.length}}function wo(){setTimeout(yo,be?Math.max(0,be+me-da.now()):0)}function Rt(){try{b={},et=t.fetch_types,B=Math.random().toString(36).slice(2),oe=1,le.start(),T.on("data",On),U&&T.setKeepAlive&&T.setKeepAlive(!0,1e3*U);let u=Mc();Pe(u)}catch(u){jt(u)}}function jt(u){if(!(Ee.queue===e.connecting&&t.host[G+1]))for(Ke(u);z.length;)Xt(z.shift(),u)}function Ke(u){ne&&(ne.destroy(u),ne=null),A&&Xt(A,u),xe&&(Xt(xe,u),xe=null)}function Xt(u,p){if(u.reserve)return u.reject(p);(!p||typeof p!="object")&&(p=new Error(p)),"query"in p||"parameters"in p||Object.defineProperties(p,{stack:{value:p.stack+u.origin.replace(/.*\n/,`
`),enumerable:t.debug},query:{value:u.string,enumerable:t.debug},parameters:{value:u.parameters,enumerable:t.debug},args:{value:u.args,enumerable:t.debug},types:{value:u.statement&&u.statement.types,enumerable:t.debug}}),u.reject(p)}function Rn(){return ce||(!Ee.reserved&&n(Ee),!Ee.reserved&&!xe&&!A&&z.length===0?(Zt(),new Promise(u=>T&&T.readyState!=="closed"?T.once("close",u):u())):ce=new Promise(u=>Dr=u))}function Zt(){it=!0,(ne||A||xe||z.length)&&jt(ye.connection("CONNECTION_DESTROYED",t)),clearImmediate(re),T&&(T.removeListener("data",On),T.removeListener("connect",Rt),T.readyState==="open"&&T.end(O().X().end())),Dr&&(Dr(),ce=Dr=null)}async function bo(u){if(ie=Buffer.alloc(0),pe=0,tt=null,clearImmediate(re),T.removeListener("data",On),T.removeListener("connect",Rt),D.cancel(),le.cancel(),q.cancel(),T.removeAllListeners(),T=null,xe)return wo();!u&&(A||z.length)&&jt(ye.connection("CONNECTION_CLOSED",t,T)),be=da.now(),u&&t.shared.retries++,me=(typeof V=="function"?V(t.shared.retries):V)*1e3,s(Ee,ye.connection("CONNECTION_CLOSED",t,T))}function ic(u,p=u[0]){(p===68?oc:p===100?jc:p===65?xc:p===83?ac:p===90?lc:p===67?cc:p===50?So:p===49?uc:p===116?dc:p===84?fc:p===82?mc:p===110?bc:p===75?Sc:p===69?Nc:p===115?Ec:p===51?$c:p===71?_c:p===78?Dc:p===72?Oc:p===99?Ic:p===73?Bc:p===86?Lc:p===118?qc:p===87?Rc:Fc)(u)}function oc(u){let p=7,I,W,ge,$e=A.isRaw?new Array(A.statement.columns.length):{};for(let De=0;De<A.statement.columns.length;De++)W=A.statement.columns[De],I=u.readInt32BE(p),p+=4,ge=I===-1?null:A.isRaw===!0?u.subarray(p,p+=I):W.parser===void 0?u.toString("utf8",p,p+=I):W.parser.array===!0?W.parser(u.toString("utf8",p+1,p+=I)):W.parser(u.toString("utf8",p,p+=I)),A.isRaw?$e[De]=A.isRaw===!0?ge:S.value.from?S.value.from(ge,W):ge:$e[W.name]=S.value.from?S.value.from(ge,W):ge;A.forEachFn?A.forEachFn(S.row.from?S.row.from($e):$e,F):F[Se++]=S.row.from?S.row.from($e):$e}function ac(u){let[p,I]=u.toString("utf8",5,u.length-1).split(O.N);Je[p]=I,t.parameters[p]!==I&&(t.parameters[p]=I,E&&E(p,I))}function lc(u){if(A?de?A.retried?Ke(A.retried):A.prepared&&Iu.has(de.routine)?Pc(A,de):Ke(de):A.resolve(pt||F):de&&Ke(de),A=pt=de=null,F=new yt,q.cancel(),xe){if(L){if(!Je.in_hot_standby||!Je.default_transaction_read_only)return Ac();if(Tc(L,Je))return Zt()}if(et)return xe.reserve&&(xe=null),vc();xe&&!xe.reserve&&Yt(xe),t.shared.retries=G=0,xe=null;return}for(;z.length&&(A=z.shift())&&(A.active=!0,A.cancelled);)ha(t).cancel(A.state,A.cancelled.resolve,A.cancelled.reject);A||(Ee.reserved?!Ee.reserved.release&&u[5]===73?ce?Zt():(Ee.reserved=null,r(Ee)):Ee.reserved():ce?Zt():r(Ee))}function cc(u){Se=0;for(let p=u.length-1;p>0;p--)if(u[p]===32&&u[p+1]<58&&F.count===null&&(F.count=+u.toString("utf8",p+1,u.length-1)),u[p-1]>=65){F.command=u.toString("utf8",5,p),F.state=j;break}if(Gt&&(Gt(),Gt=null),F.command==="BEGIN"&&a!==1&&!Ee.reserved)return Ke(ye.generic("UNSAFE_TRANSACTION","Only use sql.begin, sql.reserved or max: 1"));if(A.options.simple)return So();A.cursorFn&&(F.count&&A.cursorFn(F),Pe(wt))}function uc(){A.parsing=!1}function So(){!F.statement&&(F.statement=A.statement),F.columns=A.statement.columns}function dc(u){let p=u.readUInt16BE(5);for(let I=0;I<p;++I)!A.statement.types[I]&&(A.statement.types[I]=u.readUInt32BE(7+I*4));A.prepare&&(b[A.signature]=A.statement),A.describeFirst&&!A.onlyDescribe&&(Pe(Br(A)),A.describeFirst=!1)}function fc(u){F.command&&(pt=pt||[F],pt.push(F=new yt),F.count=null,A.statement.columns=null);let p=u.readUInt16BE(5),I=7,W;A.statement.columns=Array(p);for(let ge=0;ge<p;++ge){for(W=I;u[I++]!==0;);let $e=u.readUInt32BE(I),De=u.readUInt16BE(I+4),gt=u.readUInt32BE(I+6);A.statement.columns[ge]={name:S.column.from?S.column.from(u.toString("utf8",W,I-1)):u.toString("utf8",W,I-1),parser:y[gt],table:$e,number:De,type:gt},I+=18}if(F.statement=A.statement,A.onlyDescribe)return A.resolve(A.statement),Pe(wt)}async function mc(u,p=u.readUInt32BE(5)){(p===3?hc:p===5?pc:p===10?gc:p===11?yc:p===12?wc:p!==0?zc:Lt)(u,p)}async function hc(){let u=await jn();Pe(O().p().str(u).z(1).end())}async function pc(u){let p="md5"+await ma(Buffer.concat([Buffer.from(await ma(await jn()+l)),u.subarray(9)]));Pe(O().p().str(p).z(1).end())}async function gc(){_n=(await lr.randomBytes(18)).toString("base64"),O().p().str("SCRAM-SHA-256"+O.N);let u=O.i;Pe(O.inc(4).str("n,,n=*,r="+_n).i32(O.i-u-4,u).end())}async function yc(u){let p=u.toString("utf8",9).split(",").reduce((De,gt)=>(De[gt[0]]=gt.slice(2),De),{}),I=await lr.pbkdf2Sync(await jn(),Buffer.from(p.s,"base64"),parseInt(p.i),32,"sha256"),W=await Zr(I,"Client Key"),ge="n=*,r="+_n+",r="+p.r+",s="+p.s+",i="+p.i+",c=biws,r="+p.r;Ie=(await Zr(await Zr(I,"Server Key"),ge)).toString("base64");let $e="c=biws,r="+p.r+",p="+Lu(W,Buffer.from(await Zr(await Bu(W),ge))).toString("base64");Pe(O().p().str($e).end())}function wc(u){u.toString("utf8",9).split(O.N,1)[0].slice(2)!==Ie&&(Ke(ye.generic("SASL_SIGNATURE_MISMATCH","The server did not return the correct signature")),T.destroy())}function jn(){return Promise.resolve(typeof t.pass=="function"?t.pass():t.pass)}function bc(){if(F.statement=A.statement,F.statement.columns=[],A.onlyDescribe)return A.resolve(A.statement),Pe(wt)}function Sc(u){j.pid=u.readUInt32BE(5),j.secret=u.readUInt32BE(9)}async function vc(){et=!1,(await new ke([`
      select b.oid, b.typarray
      from pg_catalog.pg_type a
      left join pg_catalog.pg_type b on b.oid = a.typelem
      where a.typcategory = 'A'
      group by b.oid, b.typarray
      order by b.oid
    `],[],Yt)).forEach(({oid:p,typarray:I})=>Cc(p,I))}function Cc(u,p){if(t.parsers[p]&&t.serializers[p])return;let I=t.parsers[u];t.shared.typeArrayMap[u]=p,t.parsers[p]=W=>la(W,I,p),t.parsers[p].array=!0,t.serializers[p]=W=>aa(W,t.serializers[u],t,p)}function Tc(u,p){return u==="read-write"&&p.default_transaction_read_only==="on"||u==="read-only"&&p.default_transaction_read_only==="off"||u==="primary"&&p.in_hot_standby==="on"||u==="standby"&&p.in_hot_standby==="off"||u==="prefer-standby"&&p.in_hot_standby==="off"&&t.host[G]}function Ac(){let u=new ke([`
      show transaction_read_only;
      select pg_catalog.pg_is_in_recovery()
    `],[],Yt,null,{simple:!0});u.resolve=([[p],[I]])=>{Je.default_transaction_read_only=p.transaction_read_only,Je.in_hot_standby=I.pg_is_in_recovery?"on":"off"},u.execute()}function Nc(u){A?((A.cursorFn||A.describeFirst)&&Pe(wt),de=ye.postgres(Xr(u))):Ke(ye.postgres(Xr(u)))}function Pc(u,p){delete b[u.signature],u.retried=p,Yt(u)}function xc(u){if(!w)return;let p=9;for(;u[p++]!==0;);w(u.toString("utf8",9,p-1),u.toString("utf8",p,u.length-1))}async function Ec(){try{let u=await Promise.resolve(A.cursorFn(F));Se=0,u===Dt?Pe(Uc(A.portal)):(F=new yt,Pe(Co("",A.cursorRows)))}catch(u){Pe(wt),A.reject(u)}}function $c(){F.count&&A.cursorFn(F),A.resolve(F)}function _c(){ne=new ss.Writable({autoDestroy:!0,write(u,p,I){T.write(O().d().raw(u).end(),I)},destroy(u,p){p(u),T.write(O().f().str(u+O.N).end()),ne=null},final(u){T.write(O().c().end()),Gt=u,ne=null}}),A.resolve(ne)}function Oc(){ne=new ss.Readable({read(){T.resume()}}),A.resolve(ne)}function Rc(){ne=new ss.Duplex({autoDestroy:!0,read(){T.resume()},write(u,p,I){T.write(O().d().raw(u).end(),I)},destroy(u,p){p(u),T.write(O().f().str(u+O.N).end()),ne=null},final(u){T.write(O().c().end()),Gt=u}}),A.resolve(ne)}function jc(u){ne&&(ne.push(u.subarray(5))||T.pause())}function Ic(){ne&&ne.push(null),ne=null}function Dc(u){$?$(Xr(u)):console.log(Xr(u))}function Bc(){}function Lc(){Ke(ye.notSupported("FunctionCallResponse"))}function qc(){Ke(ye.notSupported("NegotiateProtocolVersion"))}function Fc(u){console.error("Postgres.js : Unknown Message:",u[0])}function zc(u,p){console.error("Postgres.js : Unknown Auth:",p)}function Qc(u,p,I="",W=""){let ge,$e;return O().B().str(W+O.N).str(I+O.N).i16(0).i16(u.length),u.forEach((De,gt)=>{if(De===null)return O.i32(4294967295);$e=p[gt],u[gt]=De=$e in t.serializers?t.serializers[$e](De):""+De,ge=O.i,O.inc(4).str(De).i32(O.i-ge-4,ge)}),O.i16(0),O.end()}function vo(u,p,I,W=""){return O().P().str(W+O.N).str(u+O.N).i16(p.length),p.forEach((ge,$e)=>O.i32(I[$e]||0)),O.end()}function kc(u,p=""){return O().D().str(u).str(p+O.N).end()}function Co(u="",p=0){return Buffer.concat([O().E().str(u+O.N).i32(p).end(),fa])}function Uc(u=""){return Buffer.concat([O().C().str("P").str(u+O.N).end(),O().S().end()])}function Mc(){return Ne||O().inc(4).i16(3).z(2).str(Object.entries(Object.assign({user:l,database:h,client_encoding:"UTF8"},t.connection)).filter(([,u])=>u).map(([u,p])=>u+O.N+p).join(O.N)).z(2).end(0)}}function Xr(t){let e={},r=5;for(let n=5;n<t.length-1;n++)t[n]===0&&(e[Du[t[r]]]=t.toString("utf8",r+1,n),r=n+1);return e}function ma(t){return lr.createHash("md5").update(t).digest("hex")}function Zr(t,e){return lr.createHmac("sha256",t).update(e).digest()}function Bu(t){return lr.createHash("sha256").update(t).digest()}function Lu(t,e){let r=Math.max(t.length,e.length),n=Buffer.allocUnsafe(r);for(let s=0;s<r;s++)n[s]=t[s]^e[s];return n}function is(t,e){if(e=typeof e=="function"?e():e,!e)return{cancel:Lt,start:Lt};let r;return{cancel(){r&&(clearTimeout(r),r=null)},start(){r&&clearTimeout(r),r=setTimeout(n,e*1e3,arguments)}};function n(s){t.apply(null,s),r=null}}var pa=()=>{};function as(t,e){let r=new Map,n="postgresjs_"+Math.random().toString(36).slice(2),s={},i,o,a=!1,l=h.sql=t({...e,transform:{column:{},value:{},row:{}},max:1,fetch_types:!1,idle_timeout:null,max_lifetime:null,connection:{...e.connection,replication:"database"},onclose:async function(){a||(o=null,s.pid=s.secret=void 0,y(await S(l,n,e.publications)),r.forEach(w=>w.forEach(({onsubscribe:E})=>E())))},no_subscribe:!0}),c=l.end,d=l.close;return l.end=async()=>(a=!0,o&&await new Promise(w=>(o.once("close",w),o.end())),c()),l.close=async()=>(o&&await new Promise(w=>(o.once("close",w),o.end())),d()),h;async function h(w,E,N=pa,U=pa){w=zu(w),i||(i=S(l,n,e.publications));let V={fn:E,onsubscribe:N},L=r.has(w)?r.get(w).add(V):r.set(w,new Set([V])).get(w),z=()=>{L.delete(V),L.size===0&&r.delete(w)};return i.then(J=>(y(J),N(),o&&o.on("error",U),{unsubscribe:z,state:s,sql:l}))}function y(w){o=w.stream,s.pid=w.state.pid,s.secret=w.state.secret}async function S(w,E,N){if(!N)throw new Error("Missing publication names");let U=await w.unsafe(`CREATE_REPLICATION_SLOT ${E} TEMPORARY LOGICAL pgoutput NOEXPORT_SNAPSHOT`),[V]=U,L=await w.unsafe(`START_REPLICATION SLOT ${E} LOGICAL ${V.consistent_point} (proto_version '1', publication_names '${N}')`).writable(),z={lsn:Buffer.concat(V.consistent_point.split("/").map(q=>Buffer.from(("00000000"+q).slice(-8),"hex")))};return L.on("data",j),L.on("error",J),L.on("close",w.close),{stream:L,state:U.state};function J(q){console.error("Unexpected error during logical streaming - reconnecting",q)}function j(q){q[0]===119?Fu(q.subarray(25),z,w.options.parsers,D,e.transform):q[0]===107&&q[17]&&(z.lsn=q.subarray(1,9),le())}function D(q,T){let Ne=T.relation.schema+"."+T.relation.table;$("*",q,T),$("*:"+Ne,q,T),T.relation.keys.length&&$("*:"+Ne+"="+T.relation.keys.map(de=>q[de.name]),q,T),$(T.command,q,T),$(T.command+":"+Ne,q,T),T.relation.keys.length&&$(T.command+":"+Ne+"="+T.relation.keys.map(de=>q[de.name]),q,T)}function le(){let q=Buffer.alloc(34);q[0]=114,q.fill(z.lsn,1),q.writeBigInt64BE(BigInt(Date.now()-Date.UTC(2e3,0,1))*BigInt(1e3),25),L.write(q)}}function $(w,E,N){r.has(w)&&r.get(w).forEach(({fn:U})=>U(E,N,w))}}function qu(t){return new Date(Date.UTC(2e3,0,1)+Number(t/BigInt(1e3)))}function Fu(t,e,r,n,s){let i=(o,[a,l])=>(o[a.charCodeAt(0)]=l,o);Object.entries({R:o=>{let a=1,l=e[o.readUInt32BE(a)]={schema:o.toString("utf8",a+=4,a=o.indexOf(0,a))||"pg_catalog",table:o.toString("utf8",a+1,a=o.indexOf(0,a+1)),columns:Array(o.readUInt16BE(a+=2)),keys:[]};a+=2;let c=0,d;for(;a<o.length;)d=l.columns[c++]={key:o[a++],name:s.column.from?s.column.from(o.toString("utf8",a,a=o.indexOf(0,a))):o.toString("utf8",a,a=o.indexOf(0,a)),type:o.readUInt32BE(a+=1),parser:r[o.readUInt32BE(a)],atttypmod:o.readUInt32BE(a+=4)},d.key&&l.keys.push(d),a+=4},Y:()=>{},O:()=>{},B:o=>{e.date=qu(o.readBigInt64BE(9)),e.lsn=o.subarray(1,9)},I:o=>{let a=1,l=e[o.readUInt32BE(a)],{row:c}=en(o,l.columns,a+=7,s);n(c,{command:"insert",relation:l})},D:o=>{let a=1,l=e[o.readUInt32BE(a)];a+=4;let c=o[a]===75;n(c||o[a]===79?en(o,l.columns,a+=3,s).row:null,{command:"delete",relation:l,key:c})},U:o=>{let a=1,l=e[o.readUInt32BE(a)];a+=4;let c=o[a]===75,d=c||o[a]===79?en(o,l.columns,a+=3,s):null;d&&(a=d.i);let{row:h}=en(o,l.columns,a+3,s);n(h,{command:"update",relation:l,key:c,old:d&&d.row})},T:()=>{},C:()=>{}}).reduce(i,{})[t[0]](t)}function en(t,e,r,n){let s,i,o,a=n.raw?new Array(e.length):{};for(let l=0;l<e.length;l++)s=t[r++],i=e[l],o=s===110?null:s===117?void 0:i.parser===void 0?t.toString("utf8",r+4,r+=4+t.readUInt32BE(r)):i.parser.array===!0?i.parser(t.toString("utf8",r+5,r+=4+t.readUInt32BE(r))):i.parser(t.toString("utf8",r+4,r+=4+t.readUInt32BE(r))),n.raw?a[l]=n.raw===!0?o:n.value.from?n.value.from(o,i):o:a[i.name]=n.value.from?n.value.from(o,i):o;return{i:r,row:n.row.from?n.row.from(a):a}}function zu(t){let e=t.match(/^(\*|insert|update|delete)?:?([^.]+?\.?[^=]+)?=?(.+)?/i)||[];if(!e)throw new Error("Malformed subscribe pattern: "+t);let[,r,n,s]=e;return(r||"*")+(n?":"+(n.indexOf(".")===-1?"public."+n:n):"")+(s?"="+s:"")}import ga from"stream";function ls(t,e,r=393216){return new Promise(async(n,s)=>{await t.begin(async i=>{let o;!e&&([{oid:e}]=await i`select lo_creat(-1) as oid`);let[{fd:a}]=await i`select lo_open(${e}, ${r}) as fd`,l={writable:d,readable:c,close:()=>i`select lo_close(${a})`.then(o),tell:()=>i`select lo_tell64(${a})`,read:h=>i`select loread(${a}, ${h}) as data`,write:h=>i`select lowrite(${a}, ${h})`,truncate:h=>i`select lo_truncate64(${a}, ${h})`,seek:(h,y=0)=>i`select lo_lseek64(${a}, ${h}, ${y})`,size:()=>i`
          select
            lo_lseek64(${a}, location, 0) as position,
            seek.size
          from (
            select
              lo_lseek64($1, 0, 2) as size,
              tell.location
            from (select lo_tell64($1) as location) tell
          ) seek
        `};return n(l),new Promise(async h=>o=h);async function c({highWaterMark:h=2048*8,start:y=0,end:S=1/0}={}){let $=S-y;return y&&await l.seek(y),new ga.Readable({highWaterMark:h,async read(w){let E=w>$?w-$:w;$-=w;let[{data:N}]=await l.read(E);this.push(N),N.length<w&&this.push(null)}})}async function d({highWaterMark:h=2048*8,start:y=0}={}){return y&&await l.seek(y),new ga.Writable({highWaterMark:h,write(S,$,w){l.write(S).then(()=>w(),w)}})}}).catch(s)})}Object.assign(tn,{PostgresError:At,toPascal:Pt,pascal:rs,toCamel:Nt,camel:ts,toKebab:xt,kebab:ns,fromPascal:or,fromCamel:ir,fromKebab:ar,BigInt:{to:20,from:[20],parse:t=>BigInt(t),serialize:t=>t.toString()}});var qt=tn;function tn(t,e){let r=Uu(t,e),n=r.no_subscribe||as(tn,{...r}),s=!1,i=Ue(),o=Ue(),a=Ue(),l=Ue(),c=Ue(),d=Ue(),h=Ue(),y=Ue(),S={connecting:o,reserved:a,closed:l,ended:c,open:d,busy:h,full:y},$=[...Array(r.max)].map(()=>os(r,S,{onopen:et,onend:ie,onclose:Je})),w=E(D);return Object.assign(w,{get parameters(){return r.parameters},largeObject:ls.bind(null,w),subscribe:n,CLOSE:Dt,END:Dt,PostgresError:At,options:r,reserve:V,listen:N,begin:L,close:Ne,end:T}),w;function E(b){return b.debug=r.debug,Object.entries(r.types).reduce((k,[G,fe])=>(k[G]=me=>new Ge(me,fe.to),k),B),Object.assign(oe,{types:B,typed:B,unsafe:be,notify:U,array:j,json:J,file:pe}),oe;function B(k,G){return new Ge(k,G)}function oe(k,...G){return k&&Array.isArray(k.raw)?new ke(k,G,b,q):typeof k=="string"&&!G.length?new Bt(r.transform.column.to?r.transform.column.to(k):k):new sr(k,G)}function be(k,G=[],fe={}){return arguments.length===2&&!Array.isArray(G)&&(fe=G,G=[]),new ke([k],G,b,q,{prepare:!1,...fe,simple:"simple"in fe?fe.simple:G.length===0})}function pe(k,G=[],fe={}){return arguments.length===2&&!Array.isArray(G)&&(fe=G,G=[]),new ke([],G,Se=>{ku.readFile(k,"utf8",(Ie,re)=>{if(Ie)return Se.reject(Ie);Se.strings=[re],b(Se)})},q,{...fe,simple:"simple"in fe?fe.simple:G.length===0})}}async function N(b,B,oe){let be={fn:B,onlisten:oe},pe=N.sql||(N.sql=tn({...r,max:1,idle_timeout:null,max_lifetime:null,fetch_types:!1,onclose(){Object.entries(N.channels).forEach(([Se,{listeners:Ie}])=>{delete N.channels[Se],Promise.all(Ie.map(re=>N(Se,re.fn,re.onlisten).catch(()=>{})))})},onnotify(Se,Ie){Se in N.channels&&N.channels[Se].listeners.forEach(re=>re.fn(Ie))}})),k=N.channels||(N.channels={});if(b in k){k[b].listeners.push(be);let Se=await k[b].result;return be.onlisten&&be.onlisten(),{state:Se.state,unlisten:me}}k[b]={result:pe`listen ${pe.unsafe('"'+b.replace(/"/g,'""')+'"')}`,listeners:[be]};let fe=await k[b].result;return be.onlisten&&be.onlisten(),{state:fe.state,unlisten:me};async function me(){if(b in k&&(k[b].listeners=k[b].listeners.filter(Se=>Se!==be),!k[b].listeners.length))return delete k[b],pe`unlisten ${pe.unsafe('"'+b.replace(/"/g,'""')+'"')}`}}async function U(b,B){return await w`select pg_notify(${b}, ${""+B})`}async function V(){let b=Ue(),B=d.length?d.shift():await new Promise((pe,k)=>{let G={reserve:pe,reject:k};i.push(G),l.length&&F(l.shift(),G)});z(B,a),B.reserved=()=>b.length?B.execute(b.shift()):z(B,a),B.reserved.release=!0;let oe=E(be);return oe.release=()=>{B.reserved=null,et(B)},oe;function be(pe){B.queue===y?b.push(pe):B.execute(pe)||z(B,y)}}async function L(b,B){!B&&(B=b,b="");let oe=Ue(),be=0,pe,k=null;try{return await w.unsafe("begin "+b.replace(/[^a-z ]/ig,""),[],{onexecute:fe}).execute(),await Promise.race([G(pe,B),new Promise((me,Se)=>pe.onclose=Se)])}catch(me){throw me}async function G(me,Se,Ie){let re=E(xe);re.savepoint=pt,re.prepare=ce=>k=ce.replace(/[^a-z0-9$-_. ]/gi);let it,tt;Ie&&await re`savepoint ${re(Ie)}`;try{if(tt=await new Promise((ce,ne)=>{let Qe=Se(re);Promise.resolve(Array.isArray(Qe)?Promise.all(Qe):Qe).then(ce,ne)}),it)throw it}catch(ce){throw await(Ie?re`rollback to ${re(Ie)}`:re`rollback`),ce instanceof At&&ce.code==="25P02"&&it||ce}return Ie||(k?await re`prepare transaction '${re.unsafe(k)}'`:await re`commit`),tt;function pt(ce,ne){return ce&&Array.isArray(ce.raw)?pt(Qe=>Qe.apply(Qe,arguments)):(arguments.length===1&&(ne=ce,ce=null),G(me,ne,"s"+be+++(ce?"_"+ce:"")))}function xe(ce){ce.catch(ne=>it||(it=ne)),me.queue===y?oe.push(ce):me.execute(ce)||z(me,y)}}function fe(me){pe=me,z(me,a),me.reserved=()=>oe.length?me.execute(oe.shift()):z(me,a)}}function z(b,B){return b.queue.remove(b),B.push(b),b.queue=B,B===d?b.idleTimer.start():b.idleTimer.cancel(),b}function J(b){return new Ge(b,3802)}function j(b,B){return Array.isArray(b)?new Ge(b,B||(b.length?Wr(b)||25:0),r.shared.typeArrayMap):j(Array.from(arguments))}function D(b){if(s)return b.reject(ye.connection("CONNECTION_ENDED",r,r));if(d.length)return le(d.shift(),b);if(l.length)return F(l.shift(),b);h.length?le(h.shift(),b):i.push(b)}function le(b,B){return b.execute(B)?z(b,h):z(b,y)}function q(b){return new Promise((B,oe)=>{b.state?b.active?os(r).cancel(b.state,B,oe):b.cancelled={resolve:B,reject:oe}:(i.remove(b),b.cancelled=!0,b.reject(ye.generic("57014","canceling statement due to user request")),B())})}async function T({timeout:b=null}={}){if(s)return s;await 1;let B;return s=Promise.race([new Promise(oe=>b!==null&&(B=setTimeout(de,b*1e3,oe))),Promise.all($.map(oe=>oe.end()).concat(N.sql?N.sql.end({timeout:0}):[],n.sql?n.sql.end({timeout:0}):[]))]).then(()=>clearTimeout(B))}async function Ne(){await Promise.all($.map(b=>b.end()))}async function de(b){for(await Promise.all($.map(B=>B.terminate()));i.length;)i.shift().reject(ye.connection("CONNECTION_DESTROYED",r));b()}function F(b,B){return z(b,o),b.connect(B),b}function ie(b){z(b,c)}function et(b){if(i.length===0)return z(b,d);let B=Math.ceil(i.length/(o.length+1)),oe=!0;for(;oe&&i.length&&B-- >0;){let be=i.shift();if(be.reserve)return be.reserve(b);oe=b.execute(be)}oe?z(b,h):z(b,y)}function Je(b,B){z(b,l),b.reserved=null,b.onclose&&(b.onclose(B),b.onclose=null),r.onclose&&r.onclose(b.id),i.length&&F(b,i.shift())}}function Uu(t,e){if(t&&t.shared)return t;let r=process.env,n=(!t||typeof t=="string"?e:t)||{},{url:s,multihost:i}=Wu(t),o=[...s.searchParams].reduce((y,[S,$])=>(y[S]=$,y),{}),a=n.hostname||n.host||i||s.hostname||r.PGHOST||"localhost",l=n.port||s.port||r.PGPORT||5432,c=n.user||n.username||s.username||r.PGUSERNAME||r.PGUSER||Ju();n.no_prepare&&(n.prepare=!1),o.sslmode&&(o.ssl=o.sslmode,delete o.sslmode),"timeout"in n&&(console.log("The timeout option is deprecated, use idle_timeout instead"),n.idle_timeout=n.timeout),o.sslrootcert==="system"&&(o.ssl="verify-full");let d=["idle_timeout","connect_timeout","max_lifetime","max_pipeline","backoff","keep_alive"],h={max:globalThis.Cloudflare?3:10,ssl:!1,sslnegotiation:null,idle_timeout:null,connect_timeout:30,max_lifetime:Vu,max_pipeline:100,backoff:Ku,keep_alive:60,prepare:!0,debug:!1,fetch_types:!0,publications:"alltables",target_session_attrs:null};return{host:Array.isArray(a)?a:a.split(",").map(y=>y.split(":")[0]),port:Array.isArray(l)?l:a.split(",").map(y=>parseInt(y.split(":")[1]||l)),path:n.path||a.indexOf("/")>-1&&a+"/.s.PGSQL."+l,database:n.database||n.db||(s.pathname||"").slice(1)||r.PGDATABASE||c,user:c,pass:n.pass||n.password||s.password||r.PGPASSWORD||"",...Object.entries(h).reduce((y,[S,$])=>{let w=S in n?n[S]:S in o?o[S]==="disable"||o[S]==="false"?!1:o[S]:r["PG"+S.toUpperCase()]||$;return y[S]=typeof w=="string"&&d.includes(S)?+w:w,y},{}),connection:{application_name:r.PGAPPNAME||"postgres.js",...n.connection,...Object.entries(o).reduce((y,[S,$])=>(S in h||(y[S]=$),y),{})},types:n.types||{},target_session_attrs:Mu(n,s,r),onnotice:n.onnotice,onnotify:n.onnotify,onclose:n.onclose,onparameter:n.onparameter,socket:n.socket,transform:Hu(n.transform||{undefined:void 0}),parameters:{},shared:{retries:0,typeArrayMap:{}},...ia(n.types)}}function Mu(t,e,r){let n=t.target_session_attrs||e.searchParams.get("target_session_attrs")||r.PGTARGETSESSIONATTRS;if(!n||["read-write","read-only","primary","standby","prefer-standby"].includes(n))return n;throw new Error("target_session_attrs "+n+" is not supported")}function Ku(t){return(.5+Math.random()/2)*Math.min(3**t/100,20)}function Vu(){return 60*(30+Math.random()*30)}function Hu(t){return{undefined:t.undefined,column:{from:typeof t.column=="function"?t.column:t.column&&t.column.from,to:t.column&&t.column.to},value:{from:typeof t.value=="function"?t.value:t.value&&t.value.from,to:t.value&&t.value.to},row:{from:typeof t.row=="function"?t.row:t.row&&t.row.from,to:t.row&&t.row.to}}}function Wu(t){if(!t||typeof t!="string")return{url:{searchParams:new Map}};let e=t;e=e.slice(e.indexOf("://")+3).split(/[?/]/)[0],e=decodeURIComponent(e.slice(e.indexOf("@")+1));let r=new URL(t.replace(e,e.split(",")[0]));return{url:{username:decodeURIComponent(r.username),password:decodeURIComponent(r.password),host:r.host,hostname:r.hostname,port:r.port,pathname:r.pathname,searchParams:r.searchParams},multihost:e.indexOf(",")>-1&&e}}function Ju(){try{return Qu.userInfo().username}catch{return process.env.USERNAME||process.env.USER||process.env.LOGNAME}}var f=Symbol.for("drizzle:entityKind");function g(t,e){if(!t||typeof t!="object")return!1;if(t instanceof e)return!0;if(!Object.prototype.hasOwnProperty.call(e,f))throw new Error(`Class "${e.name??"<unknown>"}" doesn't look like a Drizzle entity. If this is incorrect and the class is provided by Drizzle, please report this as a bug.`);let r=Object.getPrototypeOf(t).constructor;if(r)for(;r;){if(f in r&&r[f]===e[f])return!0;r=Object.getPrototypeOf(r)}return!1}var cs=class{static[f]="ConsoleLogWriter";write(e){console.log(e)}},rn=class{static[f]="DefaultLogger";writer;constructor(e){this.writer=e?.writer??new cs}logQuery(e,r){let n=r.map(i=>{try{return JSON.stringify(i)}catch{return String(i)}}),s=n.length?` -- params: [${n.join(", ")}]`:"";this.writer.write(`Query: ${e}${s}`)}},nn=class{static[f]="NoopLogger";logQuery(){}};var Oe=class{static[f]="QueryPromise";[Symbol.toStringTag]="QueryPromise";catch(e){return this.then(void 0,e)}finally(e){return this.then(r=>(e?.(),r),r=>{throw e?.(),r})}then(e,r){return this.execute().then(e,r)}};var X=class{constructor(e,r){this.table=e,this.config=r,this.name=r.name,this.keyAsName=r.keyAsName,this.notNull=r.notNull,this.default=r.default,this.defaultFn=r.defaultFn,this.onUpdateFn=r.onUpdateFn,this.hasDefault=r.hasDefault,this.primary=r.primaryKey,this.isUnique=r.isUnique,this.uniqueName=r.uniqueName,this.uniqueType=r.uniqueType,this.dataType=r.dataType,this.columnType=r.columnType,this.generated=r.generated,this.generatedIdentity=r.generatedIdentity}static[f]="Column";name;keyAsName;primary;notNull;default;defaultFn;onUpdateFn;hasDefault;isUnique;uniqueName;uniqueType;dataType;columnType;enumValues=void 0;generated=void 0;generatedIdentity=void 0;config;mapFromDriverValue(e){return e}mapToDriverValue(e){return e}shouldDisableInsert(){return this.config.generated!==void 0&&this.config.generated.type!=="byDefault"}};var sn=class{static[f]="ColumnBuilder";config;constructor(e,r,n){this.config={name:e,keyAsName:e==="",notNull:!1,default:void 0,hasDefault:!1,primaryKey:!1,isUnique:!1,uniqueName:void 0,uniqueType:void 0,dataType:r,columnType:n,generated:void 0}}$type(){return this}notNull(){return this.config.notNull=!0,this}default(e){return this.config.default=e,this.config.hasDefault=!0,this}$defaultFn(e){return this.config.defaultFn=e,this.config.hasDefault=!0,this}$default=this.$defaultFn;$onUpdateFn(e){return this.config.onUpdateFn=e,this.config.hasDefault=!0,this}$onUpdate=this.$onUpdateFn;primaryKey(){return this.config.primaryKey=!0,this.config.notNull=!0,this}setName(e){this.config.name===""&&(this.config.name=e)}};var Ye=Symbol.for("drizzle:Name");var on=class{static[f]="PgForeignKeyBuilder";reference;_onUpdate="no action";_onDelete="no action";constructor(e,r){this.reference=()=>{let{name:n,columns:s,foreignColumns:i}=e();return{name:n,columns:s,foreignTable:i[0].table,foreignColumns:i}},r&&(this._onUpdate=r.onUpdate,this._onDelete=r.onDelete)}onUpdate(e){return this._onUpdate=e===void 0?"no action":e,this}onDelete(e){return this._onDelete=e===void 0?"no action":e,this}build(e){return new us(e,this)}},us=class{constructor(e,r){this.table=e,this.reference=r.reference,this.onUpdate=r._onUpdate,this.onDelete=r._onDelete}static[f]="PgForeignKey";reference;onUpdate;onDelete;getName(){let{name:e,columns:r,foreignColumns:n}=this.reference(),s=r.map(a=>a.name),i=n.map(a=>a.name),o=[this.table[Ye],...s,n[0].table[Ye],...i];return e??`${o.join("_")}_fk`}};function an(t,...e){return t(...e)}function ms(t,e){return`${t[Ye]}_${e.join("_")}_unique`}var ds=class{constructor(e,r){this.name=r,this.columns=e}static[f]="PgUniqueConstraintBuilder";columns;nullsNotDistinctConfig=!1;nullsNotDistinct(){return this.nullsNotDistinctConfig=!0,this}build(e){return new fs(e,this.columns,this.nullsNotDistinctConfig,this.name)}},ya=class{static[f]="PgUniqueOnConstraintBuilder";name;constructor(e){this.name=e}on(...e){return new ds(e,this.name)}},fs=class{constructor(e,r,n,s){this.table=e,this.columns=r,this.name=s??ms(this.table,this.columns.map(i=>i.name)),this.nullsNotDistinct=n}static[f]="PgUniqueConstraint";columns;name;nullsNotDistinct=!1;getName(){return this.name}};function wa(t,e,r){for(let n=e;n<t.length;n++){let s=t[n];if(s==="\\"){n++;continue}if(s==='"')return[t.slice(e,n).replace(/\\/g,""),n+1];if(!r&&(s===","||s==="}"))return[t.slice(e,n).replace(/\\/g,""),n]}return[t.slice(e).replace(/\\/g,""),t.length]}function ba(t,e=0){let r=[],n=e,s=!1;for(;n<t.length;){let i=t[n];if(i===","){(s||n===e)&&r.push(""),s=!0,n++;continue}if(s=!1,i==="\\"){n+=2;continue}if(i==='"'){let[l,c]=wa(t,n+1,!0);r.push(l),n=c;continue}if(i==="}")return[r,n+1];if(i==="{"){let[l,c]=ba(t,n+1);r.push(l),n=c;continue}let[o,a]=wa(t,n,!1);r.push(o),n=a}return[r,n]}function Sa(t){let[e]=ba(t,1);return e}function hs(t){return`{${t.map(e=>Array.isArray(e)?hs(e):typeof e=="string"?`"${e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`:`${e}`).join(",")}}`}var P=class extends sn{foreignKeyConfigs=[];static[f]="PgColumnBuilder";array(e){return new gs(this.config.name,this,e)}references(e,r={}){return this.foreignKeyConfigs.push({ref:e,actions:r}),this}unique(e,r){return this.config.isUnique=!0,this.config.uniqueName=e,this.config.uniqueType=r?.nulls,this}generatedAlwaysAs(e){return this.config.generated={as:e,type:"always",mode:"stored"},this}buildForeignKeys(e,r){return this.foreignKeyConfigs.map(({ref:n,actions:s})=>an((i,o)=>{let a=new on(()=>{let l=i();return{columns:[e],foreignColumns:[l]}});return o.onUpdate&&a.onUpdate(o.onUpdate),o.onDelete&&a.onDelete(o.onDelete),a.build(r)},n,s))}buildExtraConfigColumn(e){return new ps(e,this.config)}},v=class extends X{constructor(e,r){r.uniqueName||(r.uniqueName=ms(e,[r.name])),super(e,r),this.table=e}static[f]="PgColumn"},ps=class extends v{static[f]="ExtraConfigColumn";getSQLType(){return this.getSQLType()}indexConfig={order:this.config.order??"asc",nulls:this.config.nulls??"last",opClass:this.config.opClass};defaultConfig={order:"asc",nulls:"last",opClass:void 0};asc(){return this.indexConfig.order="asc",this}desc(){return this.indexConfig.order="desc",this}nullsFirst(){return this.indexConfig.nulls="first",this}nullsLast(){return this.indexConfig.nulls="last",this}op(e){return this.indexConfig.opClass=e,this}},va=class{static[f]="IndexedColumn";constructor(e,r,n,s){this.name=e,this.keyAsName=r,this.type=n,this.indexConfig=s}name;keyAsName;type;indexConfig},gs=class extends P{static[f]="PgArrayBuilder";constructor(e,r,n){super(e,"array","PgArray"),this.config.baseBuilder=r,this.config.size=n}build(e){let r=this.config.baseBuilder.build(e);return new ys(e,this.config,r)}},ys=class t extends v{constructor(e,r,n,s){super(e,r),this.baseColumn=n,this.range=s,this.size=r.size}size;static[f]="PgArray";getSQLType(){return`${this.baseColumn.getSQLType()}[${typeof this.size=="number"?this.size:""}]`}mapFromDriverValue(e){return typeof e=="string"&&(e=Sa(e)),e.map(r=>this.baseColumn.mapFromDriverValue(r))}mapToDriverValue(e,r=!1){let n=e.map(s=>s===null?null:g(this.baseColumn,t)?this.baseColumn.mapToDriverValue(s,!0):this.baseColumn.mapToDriverValue(s));return r?n:hs(n)}};var ws=class extends P{static[f]="PgEnumObjectColumnBuilder";constructor(e,r){super(e,"string","PgEnumObjectColumn"),this.config.enum=r}build(e){return new bs(e,this.config)}},bs=class extends v{static[f]="PgEnumObjectColumn";enum;enumValues=this.config.enum.enumValues;constructor(e,r){super(e,r),this.enum=r.enum}getSQLType(){return this.enum.enumName}},ln=Symbol.for("drizzle:isPgEnum");function Ca(t){return!!t&&typeof t=="function"&&ln in t&&t[ln]===!0}var Ss=class extends P{static[f]="PgEnumColumnBuilder";constructor(e,r){super(e,"string","PgEnumColumn"),this.config.enum=r}build(e){return new vs(e,this.config)}},vs=class extends v{static[f]="PgEnumColumn";enum=this.config.enum;enumValues=this.config.enum.enumValues;constructor(e,r){super(e,r),this.enum=r.enum}getSQLType(){return this.enum.enumName}};function Ft(t,e){return Array.isArray(e)?Gu(t,[...e],void 0):Yu(t,e,void 0)}function Gu(t,e,r){let n=Object.assign(s=>new Ss(s??"",n),{enumName:t,enumValues:e,schema:r,[ln]:!0});return n}function Yu(t,e,r){let n=Object.assign(s=>new ws(s??"",n),{enumName:t,enumValues:Object.values(e),schema:r,[ln]:!0});return n}var ae=class{static[f]="Subquery";constructor(e,r,n,s=!1,i=[]){this._={brand:"Subquery",sql:e,selectedFields:r,alias:n,isWith:s,usedTables:i}}},zt=class extends ae{static[f]="WithSubquery"};var Ta="0.45.1";var Cs,Ts,te={startActiveSpan(t,e){return Cs?(Ts||(Ts=Cs.trace.getTracer("drizzle-orm",Ta)),an((r,n)=>n.startActiveSpan(t,s=>{try{return e(s)}catch(i){throw s.setStatus({code:r.SpanStatusCode.ERROR,message:i instanceof Error?i.message:"Unknown error"}),i}finally{s.end()}}),Cs,Ts)):e()}};var se=Symbol.for("drizzle:ViewBaseConfig");var Et=Symbol.for("drizzle:Schema"),cn=Symbol.for("drizzle:Columns"),Aa=Symbol.for("drizzle:ExtraConfigColumns"),As=Symbol.for("drizzle:OriginalName"),Ns=Symbol.for("drizzle:BaseName"),cr=Symbol.for("drizzle:IsAlias"),Na=Symbol.for("drizzle:ExtraConfigBuilder"),Xu=Symbol.for("drizzle:IsDrizzleTable"),C=class{static[f]="Table";static Symbol={Name:Ye,Schema:Et,OriginalName:As,Columns:cn,ExtraConfigColumns:Aa,BaseName:Ns,IsAlias:cr,ExtraConfigBuilder:Na};[Ye];[As];[Et];[cn];[Aa];[Ns];[cr]=!1;[Xu]=!0;[Na]=void 0;constructor(e,r,n){this[Ye]=this[As]=e,this[Et]=r,this[Ns]=n}};function qe(t){return t[Ye]}function $t(t){return`${t[Et]??"public"}.${t[Ye]}`}var Pa=class{static[f]="FakePrimitiveParam"};function Ps(t){return t!=null&&typeof t.getSQL=="function"}function Zu(t){let e={sql:"",params:[]};for(let r of t)e.sql+=r.sql,e.params.push(...r.params),r.typings?.length&&(e.typings||(e.typings=[]),e.typings.push(...r.typings));return e}var Ce=class{static[f]="StringChunk";value;constructor(e){this.value=Array.isArray(e)?e:[e]}getSQL(){return new x([this])}},x=class t{constructor(e){this.queryChunks=e;for(let r of e)if(g(r,C)){let n=r[C.Symbol.Schema];this.usedTables.push(n===void 0?r[C.Symbol.Name]:n+"."+r[C.Symbol.Name])}}static[f]="SQL";decoder=Ea;shouldInlineParams=!1;usedTables=[];append(e){return this.queryChunks.push(...e.queryChunks),this}toQuery(e){return te.startActiveSpan("drizzle.buildSQL",r=>{let n=this.buildQueryFromSourceParams(this.queryChunks,e);return r?.setAttributes({"drizzle.query.text":n.sql,"drizzle.query.params":JSON.stringify(n.params)}),n})}buildQueryFromSourceParams(e,r){let n=Object.assign({},r,{inlineParams:r.inlineParams||this.shouldInlineParams,paramStartIndex:r.paramStartIndex||{value:0}}),{casing:s,escapeName:i,escapeParam:o,prepareTyping:a,inlineParams:l,paramStartIndex:c}=n;return Zu(e.map(d=>{if(g(d,Ce))return{sql:d.value.join(""),params:[]};if(g(d,ur))return{sql:i(d.value),params:[]};if(d===void 0)return{sql:"",params:[]};if(Array.isArray(d)){let h=[new Ce("(")];for(let[y,S]of d.entries())h.push(S),y<d.length-1&&h.push(new Ce(", "));return h.push(new Ce(")")),this.buildQueryFromSourceParams(h,n)}if(g(d,t))return this.buildQueryFromSourceParams(d.queryChunks,{...n,inlineParams:l||d.shouldInlineParams});if(g(d,C)){let h=d[C.Symbol.Schema],y=d[C.Symbol.Name];return{sql:h===void 0||d[cr]?i(y):i(h)+"."+i(y),params:[]}}if(g(d,X)){let h=s.getColumnCasing(d);if(r.invokeSource==="indexes")return{sql:i(h),params:[]};let y=d.table[C.Symbol.Schema];return{sql:d.table[cr]||y===void 0?i(d.table[C.Symbol.Name])+"."+i(h):i(y)+"."+i(d.table[C.Symbol.Name])+"."+i(h),params:[]}}if(g(d,Le)){let h=d[se].schema,y=d[se].name;return{sql:h===void 0||d[se].isAlias?i(y):i(h)+"."+i(y),params:[]}}if(g(d,Fe)){if(g(d.value,ot))return{sql:o(c.value++,d),params:[d],typings:["none"]};let h=d.value===null?null:d.encoder.mapToDriverValue(d.value);if(g(h,t))return this.buildQueryFromSourceParams([h],n);if(l)return{sql:this.mapInlineParam(h,n),params:[]};let y=["none"];return a&&(y=[a(d.encoder)]),{sql:o(c.value++,h),params:[h],typings:y}}return g(d,ot)?{sql:o(c.value++,d),params:[d],typings:["none"]}:g(d,t.Aliased)&&d.fieldAlias!==void 0?{sql:i(d.fieldAlias),params:[]}:g(d,ae)?d._.isWith?{sql:i(d._.alias),params:[]}:this.buildQueryFromSourceParams([new Ce("("),d._.sql,new Ce(") "),new ur(d._.alias)],n):Ca(d)?d.schema?{sql:i(d.schema)+"."+i(d.enumName),params:[]}:{sql:i(d.enumName),params:[]}:Ps(d)?d.shouldOmitSQLParens?.()?this.buildQueryFromSourceParams([d.getSQL()],n):this.buildQueryFromSourceParams([new Ce("("),d.getSQL(),new Ce(")")],n):l?{sql:this.mapInlineParam(d,n),params:[]}:{sql:o(c.value++,d),params:[d],typings:["none"]}}))}mapInlineParam(e,{escapeString:r}){if(e===null)return"null";if(typeof e=="number"||typeof e=="boolean")return e.toString();if(typeof e=="string")return r(e);if(typeof e=="object"){let n=e.toString();return r(n==="[object Object]"?JSON.stringify(e):n)}throw new Error("Unexpected param value: "+e)}getSQL(){return this}as(e){return e===void 0?this:new t.Aliased(this,e)}mapWith(e){return this.decoder=typeof e=="function"?{mapFromDriverValue:e}:e,this}inlineParams(){return this.shouldInlineParams=!0,this}if(e){return e?this:void 0}},ur=class{constructor(e){this.value=e}static[f]="Name";brand;getSQL(){return new x([this])}};function xa(t){return typeof t=="object"&&t!==null&&"mapToDriverValue"in t&&typeof t.mapToDriverValue=="function"}var Ea={mapFromDriverValue:t=>t},$a={mapToDriverValue:t=>t},Ih={...Ea,...$a},Fe=class{constructor(e,r=$a){this.value=e,this.encoder=r}static[f]="Param";brand;getSQL(){return new x([this])}};function m(t,...e){let r=[];(e.length>0||t.length>0&&t[0]!=="")&&r.push(new Ce(t[0]));for(let[n,s]of e.entries())r.push(s,new Ce(t[n+1]));return new x(r)}(t=>{function e(){return new x([])}t.empty=e;function r(l){return new x(l)}t.fromList=r;function n(l){return new x([new Ce(l)])}t.raw=n;function s(l,c){let d=[];for(let[h,y]of l.entries())h>0&&c!==void 0&&d.push(c),d.push(y);return new x(d)}t.join=s;function i(l){return new ur(l)}t.identifier=i;function o(l){return new ot(l)}t.placeholder=o;function a(l,c){return new Fe(l,c)}t.param=a})(m||(m={}));(t=>{class e{constructor(n,s){this.sql=n,this.fieldAlias=s}static[f]="SQL.Aliased";isSelectionField=!1;getSQL(){return this.sql}clone(){return new e(this.sql,this.fieldAlias)}}t.Aliased=e})(x||(x={}));var ot=class{constructor(e){this.name=e}static[f]="Placeholder";getSQL(){return new x([this])}};function xs(t,e){return t.map(r=>{if(g(r,ot)){if(!(r.name in e))throw new Error(`No value for placeholder "${r.name}" was provided`);return e[r.name]}if(g(r,Fe)&&g(r.value,ot)){if(!(r.value.name in e))throw new Error(`No value for placeholder "${r.value.name}" was provided`);return r.encoder.mapToDriverValue(e[r.value.name])}return r})}var ed=Symbol.for("drizzle:IsDrizzleView"),Le=class{static[f]="View";[se];[ed]=!0;constructor({name:e,schema:r,selectedFields:n,query:s}){this[se]={name:e,originalName:e,schema:r,selectedFields:n,query:s,isExisting:!s,isAlias:!1}}getSQL(){return new x([this])}};X.prototype.getSQL=function(){return new x([this])};C.prototype.getSQL=function(){return new x([this])};ae.prototype.getSQL=function(){return new x([this])};var _t=class{constructor(e){this.table=e}static[f]="ColumnAliasProxyHandler";get(e,r){return r==="table"?this.table:e[r]}},Qt=class{constructor(e,r){this.alias=e,this.replaceOriginalName=r}static[f]="TableAliasProxyHandler";get(e,r){if(r===C.Symbol.IsAlias)return!0;if(r===C.Symbol.Name)return this.alias;if(this.replaceOriginalName&&r===C.Symbol.OriginalName)return this.alias;if(r===se)return{...e[se],name:this.alias,isAlias:!0};if(r===C.Symbol.Columns){let s=e[C.Symbol.Columns];if(!s)return s;let i={};return Object.keys(s).map(o=>{i[o]=new Proxy(s[o],new _t(new Proxy(e,this)))}),i}let n=e[r];return g(n,X)?new Proxy(n,new _t(new Proxy(e,this))):n}},_a=class{constructor(e){this.alias=e}static[f]="RelationTableAliasProxyHandler";get(e,r){return r==="sourceTable"?dr(e.sourceTable,this.alias):e[r]}};function dr(t,e){return new Proxy(t,new Qt(e,!1))}function rt(t,e){return new Proxy(t,new _t(new Proxy(t.table,new Qt(e,!1))))}function Es(t,e){return new x.Aliased(fr(t.sql,e),t.fieldAlias)}function fr(t,e){return m.join(t.queryChunks.map(r=>g(r,X)?rt(r,e):g(r,x)?fr(r,e):g(r,x.Aliased)?Es(r,e):r))}var we=class t{static[f]="SelectionProxyHandler";config;constructor(e){this.config={...e}}get(e,r){if(r==="_")return{...e._,selectedFields:new Proxy(e._.selectedFields,this)};if(r===se)return{...e[se],selectedFields:new Proxy(e[se].selectedFields,this)};if(typeof r=="symbol")return e[r];let s=(g(e,ae)?e._.selectedFields:g(e,Le)?e[se].selectedFields:e)[r];if(g(s,x.Aliased)){if(this.config.sqlAliasedBehavior==="sql"&&!s.isSelectionField)return s.sql;let i=s.clone();return i.isSelectionField=!0,i}if(g(s,x)){if(this.config.sqlBehavior==="sql")return s;throw new Error(`You tried to reference "${r}" field from a subquery, which is a raw SQL field, but it doesn't have an alias declared. Please add an alias to the field using ".as('alias')" method.`)}return g(s,X)?this.config.alias?new Proxy(s,new _t(new Proxy(s.table,new Qt(this.config.alias,this.config.replaceOriginalName??!1)))):s:typeof s!="object"||s===null?s:new Proxy(s,new t(this.config))}};function Oa(t,e,r){let n={},s=t.reduce((i,{path:o,field:a},l)=>{let c;g(a,X)?c=a:g(a,x)?c=a.decoder:g(a,ae)?c=a._.sql.decoder:c=a.sql.decoder;let d=i;for(let[h,y]of o.entries())if(h<o.length-1)y in d||(d[y]={}),d=d[y];else{let S=e[l],$=d[y]=S===null?null:c.mapFromDriverValue(S);if(r&&g(a,X)&&o.length===2){let w=o[0];w in n?typeof n[w]=="string"&&n[w]!==qe(a.table)&&(n[w]=!1):n[w]=$===null?qe(a.table):!1}}return i},{});if(r&&Object.keys(n).length>0)for(let[i,o]of Object.entries(n))typeof o=="string"&&!r[o]&&(s[i]=null);return s}function Ve(t,e){return Object.entries(t).reduce((r,[n,s])=>{if(typeof n!="string")return r;let i=e?[...e,n]:[n];return g(s,X)||g(s,x)||g(s,x.Aliased)||g(s,ae)?r.push({path:i,field:s}):g(s,C)?r.push(...Ve(s[C.Symbol.Columns],i)):r.push(...Ve(s,i)),r},[])}function mr(t,e){let r=Object.keys(t),n=Object.keys(e);if(r.length!==n.length)return!1;for(let[s,i]of r.entries())if(i!==n[s])return!1;return!0}function un(t,e){let r=Object.entries(e).filter(([,n])=>n!==void 0).map(([n,s])=>g(s,x)||g(s,X)?[n,s]:[n,new Fe(s,t[C.Symbol.Columns][n])]);if(r.length===0)throw new Error("No values to set");return Object.fromEntries(r)}function Ra(t,e){for(let r of e)for(let n of Object.getOwnPropertyNames(r.prototype))n!=="constructor"&&Object.defineProperty(t.prototype,n,Object.getOwnPropertyDescriptor(r.prototype,n)||Object.create(null))}function ja(t){return t[C.Symbol.Columns]}function at(t){return g(t,ae)?t._.alias:g(t,Le)?t[se].name:g(t,x)?void 0:t[C.Symbol.IsAlias]?t[C.Symbol.Name]:t[C.Symbol.BaseName]}function K(t,e){return{name:typeof t=="string"&&t.length>0?t:"",config:typeof t=="object"?t:e}}function Ia(t){if(typeof t!="object"||t===null||t.constructor.name!=="Object")return!1;if("logger"in t){let e=typeof t.logger;return!(e!=="boolean"&&(e!=="object"||typeof t.logger.logQuery!="function")&&e!=="undefined")}if("schema"in t){let e=typeof t.schema;return!(e!=="object"&&e!=="undefined")}if("casing"in t){let e=typeof t.casing;return!(e!=="string"&&e!=="undefined")}if("mode"in t)return!(t.mode!=="default"||t.mode!=="planetscale"||t.mode!==void 0);if("connection"in t){let e=typeof t.connection;return!(e!=="string"&&e!=="object"&&e!=="undefined")}if("client"in t){let e=typeof t.client;return!(e!=="object"&&e!=="function"&&e!=="undefined")}return Object.keys(t).length===0}var tp=typeof TextDecoder>"u"?null:new TextDecoder;var lt=class extends P{static[f]="PgIntColumnBaseBuilder";generatedAlwaysAsIdentity(e){if(e){let{name:r,...n}=e;this.config.generatedIdentity={type:"always",sequenceName:r,sequenceOptions:n}}else this.config.generatedIdentity={type:"always"};return this.config.hasDefault=!0,this.config.notNull=!0,this}generatedByDefaultAsIdentity(e){if(e){let{name:r,...n}=e;this.config.generatedIdentity={type:"byDefault",sequenceName:r,sequenceOptions:n}}else this.config.generatedIdentity={type:"byDefault"};return this.config.hasDefault=!0,this.config.notNull=!0,this}};var $s=class extends lt{static[f]="PgBigInt53Builder";constructor(e){super(e,"number","PgBigInt53")}build(e){return new _s(e,this.config)}},_s=class extends v{static[f]="PgBigInt53";getSQLType(){return"bigint"}mapFromDriverValue(e){return typeof e=="number"?e:Number(e)}},Os=class extends lt{static[f]="PgBigInt64Builder";constructor(e){super(e,"bigint","PgBigInt64")}build(e){return new Rs(e,this.config)}},Rs=class extends v{static[f]="PgBigInt64";getSQLType(){return"bigint"}mapFromDriverValue(e){return BigInt(e)}};function Da(t,e){let{name:r,config:n}=K(t,e);return n.mode==="number"?new $s(r):new Os(r)}var js=class extends P{static[f]="PgBigSerial53Builder";constructor(e){super(e,"number","PgBigSerial53"),this.config.hasDefault=!0,this.config.notNull=!0}build(e){return new Is(e,this.config)}},Is=class extends v{static[f]="PgBigSerial53";getSQLType(){return"bigserial"}mapFromDriverValue(e){return typeof e=="number"?e:Number(e)}},Ds=class extends P{static[f]="PgBigSerial64Builder";constructor(e){super(e,"bigint","PgBigSerial64"),this.config.hasDefault=!0}build(e){return new Bs(e,this.config)}},Bs=class extends v{static[f]="PgBigSerial64";getSQLType(){return"bigserial"}mapFromDriverValue(e){return BigInt(e)}};function Ba(t,e){let{name:r,config:n}=K(t,e);return n.mode==="number"?new js(r):new Ds(r)}var Ls=class extends P{static[f]="PgBooleanBuilder";constructor(e){super(e,"boolean","PgBoolean")}build(e){return new qs(e,this.config)}},qs=class extends v{static[f]="PgBoolean";getSQLType(){return"boolean"}};function hr(t){return new Ls(t??"")}var Fs=class extends P{static[f]="PgCharBuilder";constructor(e,r){super(e,"string","PgChar"),this.config.length=r.length,this.config.enumValues=r.enum}build(e){return new zs(e,this.config)}},zs=class extends v{static[f]="PgChar";length=this.config.length;enumValues=this.config.enumValues;getSQLType(){return this.length===void 0?"char":`char(${this.length})`}};function La(t,e={}){let{name:r,config:n}=K(t,e);return new Fs(r,n)}var Qs=class extends P{static[f]="PgCidrBuilder";constructor(e){super(e,"string","PgCidr")}build(e){return new ks(e,this.config)}},ks=class extends v{static[f]="PgCidr";getSQLType(){return"cidr"}};function qa(t){return new Qs(t??"")}var Us=class extends P{static[f]="PgCustomColumnBuilder";constructor(e,r,n){super(e,"custom","PgCustomColumn"),this.config.fieldConfig=r,this.config.customTypeParams=n}build(e){return new Ms(e,this.config)}},Ms=class extends v{static[f]="PgCustomColumn";sqlName;mapTo;mapFrom;constructor(e,r){super(e,r),this.sqlName=r.customTypeParams.dataType(r.fieldConfig),this.mapTo=r.customTypeParams.toDriver,this.mapFrom=r.customTypeParams.fromDriver}getSQLType(){return this.sqlName}mapFromDriverValue(e){return typeof this.mapFrom=="function"?this.mapFrom(e):e}mapToDriverValue(e){return typeof this.mapTo=="function"?this.mapTo(e):e}};function Fa(t){return(e,r)=>{let{name:n,config:s}=K(e,r);return new Us(n,s,t)}}var nt=class extends P{static[f]="PgDateColumnBaseBuilder";defaultNow(){return this.default(m`now()`)}};var Ks=class extends nt{static[f]="PgDateBuilder";constructor(e){super(e,"date","PgDate")}build(e){return new pr(e,this.config)}},pr=class extends v{static[f]="PgDate";getSQLType(){return"date"}mapFromDriverValue(e){return typeof e=="string"?new Date(e):e}mapToDriverValue(e){return e.toISOString()}},Vs=class extends nt{static[f]="PgDateStringBuilder";constructor(e){super(e,"string","PgDateString")}build(e){return new gr(e,this.config)}},gr=class extends v{static[f]="PgDateString";getSQLType(){return"date"}mapFromDriverValue(e){return typeof e=="string"?e:e.toISOString().slice(0,-14)}};function za(t,e){let{name:r,config:n}=K(t,e);return n?.mode==="date"?new Ks(r):new Vs(r)}var Hs=class extends P{static[f]="PgDoublePrecisionBuilder";constructor(e){super(e,"number","PgDoublePrecision")}build(e){return new Ws(e,this.config)}},Ws=class extends v{static[f]="PgDoublePrecision";getSQLType(){return"double precision"}mapFromDriverValue(e){return typeof e=="string"?Number.parseFloat(e):e}};function Qa(t){return new Hs(t??"")}var Js=class extends P{static[f]="PgInetBuilder";constructor(e){super(e,"string","PgInet")}build(e){return new Gs(e,this.config)}},Gs=class extends v{static[f]="PgInet";getSQLType(){return"inet"}};function ka(t){return new Js(t??"")}var Ys=class extends lt{static[f]="PgIntegerBuilder";constructor(e){super(e,"number","PgInteger")}build(e){return new Xs(e,this.config)}},Xs=class extends v{static[f]="PgInteger";getSQLType(){return"integer"}mapFromDriverValue(e){return typeof e=="string"?Number.parseInt(e):e}};function He(t){return new Ys(t??"")}var Zs=class extends P{static[f]="PgIntervalBuilder";constructor(e,r){super(e,"string","PgInterval"),this.config.intervalConfig=r}build(e){return new ei(e,this.config)}},ei=class extends v{static[f]="PgInterval";fields=this.config.intervalConfig.fields;precision=this.config.intervalConfig.precision;getSQLType(){let e=this.fields?` ${this.fields}`:"",r=this.precision?`(${this.precision})`:"";return`interval${e}${r}`}};function Ua(t,e={}){let{name:r,config:n}=K(t,e);return new Zs(r,n)}var ti=class extends P{static[f]="PgJsonBuilder";constructor(e){super(e,"json","PgJson")}build(e){return new yr(e,this.config)}},yr=class extends v{static[f]="PgJson";constructor(e,r){super(e,r)}getSQLType(){return"json"}mapToDriverValue(e){return JSON.stringify(e)}mapFromDriverValue(e){if(typeof e=="string")try{return JSON.parse(e)}catch{return e}return e}};function Ma(t){return new ti(t??"")}var ri=class extends P{static[f]="PgJsonbBuilder";constructor(e){super(e,"json","PgJsonb")}build(e){return new wr(e,this.config)}},wr=class extends v{static[f]="PgJsonb";constructor(e,r){super(e,r)}getSQLType(){return"jsonb"}mapToDriverValue(e){return JSON.stringify(e)}mapFromDriverValue(e){if(typeof e=="string")try{return JSON.parse(e)}catch{return e}return e}};function br(t){return new ri(t??"")}var ni=class extends P{static[f]="PgLineBuilder";constructor(e){super(e,"array","PgLine")}build(e){return new si(e,this.config)}},si=class extends v{static[f]="PgLine";getSQLType(){return"line"}mapFromDriverValue(e){let[r,n,s]=e.slice(1,-1).split(",");return[Number.parseFloat(r),Number.parseFloat(n),Number.parseFloat(s)]}mapToDriverValue(e){return`{${e[0]},${e[1]},${e[2]}}`}},ii=class extends P{static[f]="PgLineABCBuilder";constructor(e){super(e,"json","PgLineABC")}build(e){return new oi(e,this.config)}},oi=class extends v{static[f]="PgLineABC";getSQLType(){return"line"}mapFromDriverValue(e){let[r,n,s]=e.slice(1,-1).split(",");return{a:Number.parseFloat(r),b:Number.parseFloat(n),c:Number.parseFloat(s)}}mapToDriverValue(e){return`{${e.a},${e.b},${e.c}}`}};function Ka(t,e){let{name:r,config:n}=K(t,e);return!n?.mode||n.mode==="tuple"?new ni(r):new ii(r)}var ai=class extends P{static[f]="PgMacaddrBuilder";constructor(e){super(e,"string","PgMacaddr")}build(e){return new li(e,this.config)}},li=class extends v{static[f]="PgMacaddr";getSQLType(){return"macaddr"}};function Va(t){return new ai(t??"")}var ci=class extends P{static[f]="PgMacaddr8Builder";constructor(e){super(e,"string","PgMacaddr8")}build(e){return new ui(e,this.config)}},ui=class extends v{static[f]="PgMacaddr8";getSQLType(){return"macaddr8"}};function Ha(t){return new ci(t??"")}var di=class extends P{static[f]="PgNumericBuilder";constructor(e,r,n){super(e,"string","PgNumeric"),this.config.precision=r,this.config.scale=n}build(e){return new Sr(e,this.config)}},Sr=class extends v{static[f]="PgNumeric";precision;scale;constructor(e,r){super(e,r),this.precision=r.precision,this.scale=r.scale}mapFromDriverValue(e){return typeof e=="string"?e:String(e)}getSQLType(){return this.precision!==void 0&&this.scale!==void 0?`numeric(${this.precision}, ${this.scale})`:this.precision===void 0?"numeric":`numeric(${this.precision})`}},fi=class extends P{static[f]="PgNumericNumberBuilder";constructor(e,r,n){super(e,"number","PgNumericNumber"),this.config.precision=r,this.config.scale=n}build(e){return new mi(e,this.config)}},mi=class extends v{static[f]="PgNumericNumber";precision;scale;constructor(e,r){super(e,r),this.precision=r.precision,this.scale=r.scale}mapFromDriverValue(e){return typeof e=="number"?e:Number(e)}mapToDriverValue=String;getSQLType(){return this.precision!==void 0&&this.scale!==void 0?`numeric(${this.precision}, ${this.scale})`:this.precision===void 0?"numeric":`numeric(${this.precision})`}},hi=class extends P{static[f]="PgNumericBigIntBuilder";constructor(e,r,n){super(e,"bigint","PgNumericBigInt"),this.config.precision=r,this.config.scale=n}build(e){return new pi(e,this.config)}},pi=class extends v{static[f]="PgNumericBigInt";precision;scale;constructor(e,r){super(e,r),this.precision=r.precision,this.scale=r.scale}mapFromDriverValue=BigInt;mapToDriverValue=String;getSQLType(){return this.precision!==void 0&&this.scale!==void 0?`numeric(${this.precision}, ${this.scale})`:this.precision===void 0?"numeric":`numeric(${this.precision})`}};function Ot(t,e){let{name:r,config:n}=K(t,e),s=n?.mode;return s==="number"?new fi(r,n?.precision,n?.scale):s==="bigint"?new hi(r,n?.precision,n?.scale):new di(r,n?.precision,n?.scale)}var gi=class extends P{static[f]="PgPointTupleBuilder";constructor(e){super(e,"array","PgPointTuple")}build(e){return new yi(e,this.config)}},yi=class extends v{static[f]="PgPointTuple";getSQLType(){return"point"}mapFromDriverValue(e){if(typeof e=="string"){let[r,n]=e.slice(1,-1).split(",");return[Number.parseFloat(r),Number.parseFloat(n)]}return[e.x,e.y]}mapToDriverValue(e){return`(${e[0]},${e[1]})`}},wi=class extends P{static[f]="PgPointObjectBuilder";constructor(e){super(e,"json","PgPointObject")}build(e){return new bi(e,this.config)}},bi=class extends v{static[f]="PgPointObject";getSQLType(){return"point"}mapFromDriverValue(e){if(typeof e=="string"){let[r,n]=e.slice(1,-1).split(",");return{x:Number.parseFloat(r),y:Number.parseFloat(n)}}return e}mapToDriverValue(e){return`(${e.x},${e.y})`}};function Wa(t,e){let{name:r,config:n}=K(t,e);return!n?.mode||n.mode==="tuple"?new gi(r):new wi(r)}function td(t){let e=[];for(let r=0;r<t.length;r+=2)e.push(Number.parseInt(t.slice(r,r+2),16));return new Uint8Array(e)}function Ja(t,e){let r=new ArrayBuffer(8),n=new DataView(r);for(let s=0;s<8;s++)n.setUint8(s,t[e+s]);return n.getFloat64(0,!0)}function Si(t){let e=td(t),r=0,n=e[r];r+=1;let s=new DataView(e.buffer),i=s.getUint32(r,n===1);r+=4;let o;if(i&536870912&&(o=s.getUint32(r,n===1),r+=4),(i&65535)===1){let a=Ja(e,r);r+=8;let l=Ja(e,r);return r+=8,[a,l]}throw new Error("Unsupported geometry type")}var vi=class extends P{static[f]="PgGeometryBuilder";constructor(e){super(e,"array","PgGeometry")}build(e){return new Ci(e,this.config)}},Ci=class extends v{static[f]="PgGeometry";getSQLType(){return"geometry(point)"}mapFromDriverValue(e){return Si(e)}mapToDriverValue(e){return`point(${e[0]} ${e[1]})`}},Ti=class extends P{static[f]="PgGeometryObjectBuilder";constructor(e){super(e,"json","PgGeometryObject")}build(e){return new Ai(e,this.config)}},Ai=class extends v{static[f]="PgGeometryObject";getSQLType(){return"geometry(point)"}mapFromDriverValue(e){let r=Si(e);return{x:r[0],y:r[1]}}mapToDriverValue(e){return`point(${e.x} ${e.y})`}};function Ga(t,e){let{name:r,config:n}=K(t,e);return!n?.mode||n.mode==="tuple"?new vi(r):new Ti(r)}var Ni=class extends P{static[f]="PgRealBuilder";constructor(e,r){super(e,"number","PgReal"),this.config.length=r}build(e){return new Pi(e,this.config)}},Pi=class extends v{static[f]="PgReal";constructor(e,r){super(e,r)}getSQLType(){return"real"}mapFromDriverValue=e=>typeof e=="string"?Number.parseFloat(e):e};function Ya(t){return new Ni(t??"")}var xi=class extends P{static[f]="PgSerialBuilder";constructor(e){super(e,"number","PgSerial"),this.config.hasDefault=!0,this.config.notNull=!0}build(e){return new Ei(e,this.config)}},Ei=class extends v{static[f]="PgSerial";getSQLType(){return"serial"}};function Xa(t){return new xi(t??"")}var $i=class extends lt{static[f]="PgSmallIntBuilder";constructor(e){super(e,"number","PgSmallInt")}build(e){return new _i(e,this.config)}},_i=class extends v{static[f]="PgSmallInt";getSQLType(){return"smallint"}mapFromDriverValue=e=>typeof e=="string"?Number(e):e};function Za(t){return new $i(t??"")}var Oi=class extends P{static[f]="PgSmallSerialBuilder";constructor(e){super(e,"number","PgSmallSerial"),this.config.hasDefault=!0,this.config.notNull=!0}build(e){return new Ri(e,this.config)}},Ri=class extends v{static[f]="PgSmallSerial";getSQLType(){return"smallserial"}};function el(t){return new Oi(t??"")}var ji=class extends P{static[f]="PgTextBuilder";constructor(e,r){super(e,"string","PgText"),this.config.enumValues=r.enum}build(e){return new Ii(e,this.config)}},Ii=class extends v{static[f]="PgText";enumValues=this.config.enumValues;getSQLType(){return"text"}};function ct(t,e={}){let{name:r,config:n}=K(t,e);return new ji(r,n)}var Di=class extends nt{constructor(e,r,n){super(e,"string","PgTime"),this.withTimezone=r,this.precision=n,this.config.withTimezone=r,this.config.precision=n}static[f]="PgTimeBuilder";build(e){return new vr(e,this.config)}},vr=class extends v{static[f]="PgTime";withTimezone;precision;constructor(e,r){super(e,r),this.withTimezone=r.withTimezone,this.precision=r.precision}getSQLType(){return`time${this.precision===void 0?"":`(${this.precision})`}${this.withTimezone?" with time zone":""}`}};function tl(t,e={}){let{name:r,config:n}=K(t,e);return new Di(r,n.withTimezone??!1,n.precision)}var Bi=class extends nt{static[f]="PgTimestampBuilder";constructor(e,r,n){super(e,"date","PgTimestamp"),this.config.withTimezone=r,this.config.precision=n}build(e){return new Cr(e,this.config)}},Cr=class extends v{static[f]="PgTimestamp";withTimezone;precision;constructor(e,r){super(e,r),this.withTimezone=r.withTimezone,this.precision=r.precision}getSQLType(){return`timestamp${this.precision===void 0?"":` (${this.precision})`}${this.withTimezone?" with time zone":""}`}mapFromDriverValue(e){return typeof e=="string"?new Date(this.withTimezone?e:e+"+0000"):e}mapToDriverValue=e=>e.toISOString()},Li=class extends nt{static[f]="PgTimestampStringBuilder";constructor(e,r,n){super(e,"string","PgTimestampString"),this.config.withTimezone=r,this.config.precision=n}build(e){return new Tr(e,this.config)}},Tr=class extends v{static[f]="PgTimestampString";withTimezone;precision;constructor(e,r){super(e,r),this.withTimezone=r.withTimezone,this.precision=r.precision}getSQLType(){return`timestamp${this.precision===void 0?"":`(${this.precision})`}${this.withTimezone?" with time zone":""}`}mapFromDriverValue(e){if(typeof e=="string")return e;let r=e.toISOString().slice(0,-1).replace("T"," ");if(this.withTimezone){let n=e.getTimezoneOffset(),s=n<=0?"+":"-";return`${r}${s}${Math.floor(Math.abs(n)/60).toString().padStart(2,"0")}`}return r}};function Re(t,e={}){let{name:r,config:n}=K(t,e);return n?.mode==="string"?new Li(r,n.withTimezone??!1,n.precision):new Bi(r,n?.withTimezone??!1,n?.precision)}var qi=class extends P{static[f]="PgUUIDBuilder";constructor(e){super(e,"string","PgUUID")}defaultRandom(){return this.default(m`gen_random_uuid()`)}build(e){return new Ar(e,this.config)}},Ar=class extends v{static[f]="PgUUID";getSQLType(){return"uuid"}};function he(t){return new qi(t??"")}var Fi=class extends P{static[f]="PgVarcharBuilder";constructor(e,r){super(e,"string","PgVarchar"),this.config.length=r.length,this.config.enumValues=r.enum}build(e){return new zi(e,this.config)}},zi=class extends v{static[f]="PgVarchar";length=this.config.length;enumValues=this.config.enumValues;getSQLType(){return this.length===void 0?"varchar":`varchar(${this.length})`}};function ve(t,e={}){let{name:r,config:n}=K(t,e);return new Fi(r,n)}var Qi=class extends P{static[f]="PgBinaryVectorBuilder";constructor(e,r){super(e,"string","PgBinaryVector"),this.config.dimensions=r.dimensions}build(e){return new ki(e,this.config)}},ki=class extends v{static[f]="PgBinaryVector";dimensions=this.config.dimensions;getSQLType(){return`bit(${this.dimensions})`}};function rl(t,e){let{name:r,config:n}=K(t,e);return new Qi(r,n)}var Ui=class extends P{static[f]="PgHalfVectorBuilder";constructor(e,r){super(e,"array","PgHalfVector"),this.config.dimensions=r.dimensions}build(e){return new Mi(e,this.config)}},Mi=class extends v{static[f]="PgHalfVector";dimensions=this.config.dimensions;getSQLType(){return`halfvec(${this.dimensions})`}mapToDriverValue(e){return JSON.stringify(e)}mapFromDriverValue(e){return e.slice(1,-1).split(",").map(r=>Number.parseFloat(r))}};function nl(t,e){let{name:r,config:n}=K(t,e);return new Ui(r,n)}var Ki=class extends P{static[f]="PgSparseVectorBuilder";constructor(e,r){super(e,"string","PgSparseVector"),this.config.dimensions=r.dimensions}build(e){return new Vi(e,this.config)}},Vi=class extends v{static[f]="PgSparseVector";dimensions=this.config.dimensions;getSQLType(){return`sparsevec(${this.dimensions})`}};function sl(t,e){let{name:r,config:n}=K(t,e);return new Ki(r,n)}var Hi=class extends P{static[f]="PgVectorBuilder";constructor(e,r){super(e,"array","PgVector"),this.config.dimensions=r.dimensions}build(e){return new Wi(e,this.config)}},Wi=class extends v{static[f]="PgVector";dimensions=this.config.dimensions;getSQLType(){return`vector(${this.dimensions})`}mapToDriverValue(e){return JSON.stringify(e)}mapFromDriverValue(e){return e.slice(1,-1).split(",").map(r=>Number.parseFloat(r))}};function il(t,e){let{name:r,config:n}=K(t,e);return new Hi(r,n)}function ol(){return{bigint:Da,bigserial:Ba,boolean:hr,char:La,cidr:qa,customType:Fa,date:za,doublePrecision:Qa,inet:ka,integer:He,interval:Ua,json:Ma,jsonb:br,line:Ka,macaddr:Va,macaddr8:Ha,numeric:Ot,point:Wa,geometry:Ga,real:Ya,serial:Xa,smallint:Za,smallserial:el,text:ct,time:tl,timestamp:Re,uuid:he,varchar:ve,bit:rl,halfvec:nl,sparsevec:sl,vector:il}}var Ji=Symbol.for("drizzle:PgInlineForeignKeys"),al=Symbol.for("drizzle:EnableRLS"),Te=class extends C{static[f]="PgTable";static Symbol=Object.assign({},C.Symbol,{InlineForeignKeys:Ji,EnableRLS:al});[Ji]=[];[al]=!1;[C.Symbol.ExtraConfigBuilder]=void 0;[C.Symbol.ExtraConfigColumns]={}};function rd(t,e,r,n,s=t){let i=new Te(t,n,s),o=typeof e=="function"?e(ol()):e,a=Object.fromEntries(Object.entries(o).map(([d,h])=>{let y=h;y.setName(d);let S=y.build(i);return i[Ji].push(...y.buildForeignKeys(S,i)),[d,S]})),l=Object.fromEntries(Object.entries(o).map(([d,h])=>{let y=h;y.setName(d);let S=y.buildExtraConfigColumn(i);return[d,S]})),c=Object.assign(i,a);return c[C.Symbol.Columns]=a,c[C.Symbol.ExtraConfigColumns]=l,r&&(c[Te.Symbol.ExtraConfigBuilder]=r),Object.assign(c,{enableRLS:()=>(c[Te.Symbol.EnableRLS]=!0,c)})}var Me=(t,e,r)=>rd(t,e,r,void 0);var dn=class{static[f]="PgPrimaryKeyBuilder";columns;name;constructor(e,r){this.columns=e,this.name=r}build(e){return new Gi(e,this.columns,this.name)}},Gi=class{constructor(e,r,n){this.table=e,this.columns=r,this.name=n}static[f]="PgPrimaryKey";columns;name;getName(){return this.name??`${this.table[Te.Symbol.Name]}_${this.columns.map(e=>e.name).join("_")}_pk`}};function nd(t){return(t.replace(/['\u2019]/g,"").match(/[\da-z]+|[A-Z]+(?![a-z])|[A-Z][\da-z]+/g)??[]).map(r=>r.toLowerCase()).join("_")}function sd(t){return(t.replace(/['\u2019]/g,"").match(/[\da-z]+|[A-Z]+(?![a-z])|[A-Z][\da-z]+/g)??[]).reduce((r,n,s)=>{let i=s===0?n.toLowerCase():`${n[0].toUpperCase()}${n.slice(1)}`;return r+i},"")}function id(t){return t}var fn=class{static[f]="CasingCache";cache={};cachedTables={};convert;constructor(e){this.convert=e==="snake_case"?nd:e==="camelCase"?sd:id}getColumnCasing(e){if(!e.keyAsName)return e.name;let r=e.table[C.Symbol.Schema]??"public",n=e.table[C.Symbol.OriginalName],s=`${r}.${n}.${e.name}`;return this.cache[s]||this.cacheTable(e.table),this.cache[s]}cacheTable(e){let r=e[C.Symbol.Schema]??"public",n=e[C.Symbol.OriginalName],s=`${r}.${n}`;if(!this.cachedTables[s]){for(let i of Object.values(e[C.Symbol.Columns])){let o=`${s}.${i.name}`;this.cache[o]=this.convert(i.name)}this.cachedTables[s]=!0}}clearCache(){this.cache={},this.cachedTables={}}};var Nr=class extends Error{static[f]="DrizzleError";constructor({message:e,cause:r}){super(e),this.name="DrizzleError",this.cause=r}},ut=class t extends Error{constructor(e,r,n){super(`Failed query: ${e}
params: ${r}`),this.query=e,this.params=r,this.cause=n,Error.captureStackTrace(this,t),n&&(this.cause=n)}},mn=class extends Nr{static[f]="TransactionRollbackError";constructor(){super({message:"Rollback"})}};function ze(t,e){return xa(e)&&!Ps(t)&&!g(t,Fe)&&!g(t,ot)&&!g(t,X)&&!g(t,C)&&!g(t,Le)?new Fe(t,e):t}var _=(t,e)=>m`${t} = ${ze(e,t)}`,ll=(t,e)=>m`${t} <> ${ze(e,t)}`;function dt(...t){let e=t.filter(r=>r!==void 0);if(e.length!==0)return e.length===1?new x(e):new x([new Ce("("),m.join(e,new Ce(" and ")),new Ce(")")])}function cl(...t){let e=t.filter(r=>r!==void 0);if(e.length!==0)return e.length===1?new x(e):new x([new Ce("("),m.join(e,new Ce(" or ")),new Ce(")")])}function ul(t){return m`not ${t}`}var dl=(t,e)=>m`${t} > ${ze(e,t)}`,fl=(t,e)=>m`${t} >= ${ze(e,t)}`,ml=(t,e)=>m`${t} < ${ze(e,t)}`,hl=(t,e)=>m`${t} <= ${ze(e,t)}`;function pl(t,e){return Array.isArray(e)?e.length===0?m`false`:m`${t} in ${e.map(r=>ze(r,t))}`:m`${t} in ${ze(e,t)}`}function gl(t,e){return Array.isArray(e)?e.length===0?m`true`:m`${t} not in ${e.map(r=>ze(r,t))}`:m`${t} not in ${ze(e,t)}`}function yl(t){return m`${t} is null`}function wl(t){return m`${t} is not null`}function bl(t){return m`exists ${t}`}function Sl(t){return m`not exists ${t}`}function vl(t,e,r){return m`${t} between ${ze(e,t)} and ${ze(r,t)}`}function Cl(t,e,r){return m`${t} not between ${ze(e,t)} and ${ze(r,t)}`}function Tl(t,e){return m`${t} like ${e}`}function Al(t,e){return m`${t} not like ${e}`}function Nl(t,e){return m`${t} ilike ${e}`}function Pl(t,e){return m`${t} not ilike ${e}`}function xl(t){return m`${t} asc`}function kt(t){return m`${t} desc`}var hn=class{constructor(e,r,n){this.sourceTable=e,this.referencedTable=r,this.relationName=n,this.referencedTableName=r[C.Symbol.Name]}static[f]="Relation";referencedTableName;fieldName},Yi=class{constructor(e,r){this.table=e,this.config=r}static[f]="Relations"},bt=class t extends hn{constructor(e,r,n,s){super(e,r,n?.relationName),this.config=n,this.isNullable=s}static[f]="One";withFieldName(e){let r=new t(this.sourceTable,this.referencedTable,this.config,this.isNullable);return r.fieldName=e,r}},Pr=class t extends hn{constructor(e,r,n){super(e,r,n?.relationName),this.config=n}static[f]="Many";withFieldName(e){let r=new t(this.sourceTable,this.referencedTable,this.config);return r.fieldName=e,r}};function El(){return{and:dt,between:vl,eq:_,exists:bl,gt:dl,gte:fl,ilike:Nl,inArray:pl,isNull:yl,isNotNull:wl,like:Tl,lt:ml,lte:hl,ne:ll,not:ul,notBetween:Cl,notExists:Sl,notLike:Al,notIlike:Pl,notInArray:gl,or:cl,sql:m}}function $l(){return{sql:m,asc:xl,desc:kt}}function _l(t,e){Object.keys(t).length===1&&"default"in t&&!g(t.default,C)&&(t=t.default);let r={},n={},s={};for(let[i,o]of Object.entries(t))if(g(o,C)){let a=$t(o),l=n[a];r[a]=i,s[i]={tsName:i,dbName:o[C.Symbol.Name],schema:o[C.Symbol.Schema],columns:o[C.Symbol.Columns],relations:l?.relations??{},primaryKey:l?.primaryKey??[]};for(let d of Object.values(o[C.Symbol.Columns]))d.primary&&s[i].primaryKey.push(d);let c=o[C.Symbol.ExtraConfigBuilder]?.(o[C.Symbol.ExtraConfigColumns]);if(c)for(let d of Object.values(c))g(d,dn)&&s[i].primaryKey.push(...d.columns)}else if(g(o,Yi)){let a=$t(o.table),l=r[a],c=o.config(e(o.table)),d;for(let[h,y]of Object.entries(c))if(l){let S=s[l];S.relations[h]=y,d&&S.primaryKey.push(...d)}else a in n||(n[a]={relations:{},primaryKey:d}),n[a].relations[h]=y}return{tables:s,tableNamesMap:r}}function od(t){return function(r,n){return new bt(t,r,n,n?.fields.reduce((s,i)=>s&&i.notNull,!0)??!1)}}function ad(t){return function(r,n){return new Pr(t,r,n)}}function Ol(t,e,r){if(g(r,bt)&&r.config)return{fields:r.config.fields,references:r.config.references};let n=e[$t(r.referencedTable)];if(!n)throw new Error(`Table "${r.referencedTable[C.Symbol.Name]}" not found in schema`);let s=t[n];if(!s)throw new Error(`Table "${n}" not found in schema`);let i=r.sourceTable,o=e[$t(i)];if(!o)throw new Error(`Table "${i[C.Symbol.Name]}" not found in schema`);let a=[];for(let l of Object.values(s.relations))(r.relationName&&r!==l&&l.relationName===r.relationName||!r.relationName&&l.referencedTable===r.sourceTable)&&a.push(l);if(a.length>1)throw r.relationName?new Error(`There are multiple relations with name "${r.relationName}" in table "${n}"`):new Error(`There are multiple relations between "${n}" and "${r.sourceTable[C.Symbol.Name]}". Please specify relation name`);if(a[0]&&g(a[0],bt)&&a[0].config)return{fields:a[0].config.references,references:a[0].config.fields};throw new Error(`There is not enough information to infer relation "${o}.${r.fieldName}"`)}function Rl(t){return{one:od(t),many:ad(t)}}function pn(t,e,r,n,s=i=>i){let i={};for(let[o,a]of n.entries())if(a.isJson){let l=e.relations[a.tsKey],c=r[o],d=typeof c=="string"?JSON.parse(c):c;i[a.tsKey]=g(l,bt)?d&&pn(t,t[a.relationTableTsKey],d,a.selection,s):d.map(h=>pn(t,t[a.relationTableTsKey],h,a.selection,s))}else{let l=s(r[o]),c=a.field,d;g(c,X)?d=c:g(c,x)?d=c.decoder:d=c.sql.decoder,i[a.tsKey]=l===null?null:d.mapFromDriverValue(l)}return i}var Ut=class extends Le{static[f]="PgViewBase"};var St=class{static[f]="PgDialect";casing;constructor(e){this.casing=new fn(e?.casing)}async migrate(e,r,n){let s=typeof n=="string"?"__drizzle_migrations":n.migrationsTable??"__drizzle_migrations",i=typeof n=="string"?"drizzle":n.migrationsSchema??"drizzle",o=m`
			CREATE TABLE IF NOT EXISTS ${m.identifier(i)}.${m.identifier(s)} (
				id SERIAL PRIMARY KEY,
				hash text NOT NULL,
				created_at bigint
			)
		`;await r.execute(m`CREATE SCHEMA IF NOT EXISTS ${m.identifier(i)}`),await r.execute(o);let l=(await r.all(m`select id, hash, created_at from ${m.identifier(i)}.${m.identifier(s)} order by created_at desc limit 1`))[0];await r.transaction(async c=>{for await(let d of e)if(!l||Number(l.created_at)<d.folderMillis){for(let h of d.sql)await c.execute(m.raw(h));await c.execute(m`insert into ${m.identifier(i)}.${m.identifier(s)} ("hash", "created_at") values(${d.hash}, ${d.folderMillis})`)}})}escapeName(e){return`"${e}"`}escapeParam(e){return`$${e+1}`}escapeString(e){return`'${e.replace(/'/g,"''")}'`}buildWithCTE(e){if(!e?.length)return;let r=[m`with `];for(let[n,s]of e.entries())r.push(m`${m.identifier(s._.alias)} as (${s._.sql})`),n<e.length-1&&r.push(m`, `);return r.push(m` `),m.join(r)}buildDeleteQuery({table:e,where:r,returning:n,withList:s}){let i=this.buildWithCTE(s),o=n?m` returning ${this.buildSelection(n,{isSingleTable:!0})}`:void 0,a=r?m` where ${r}`:void 0;return m`${i}delete from ${e}${a}${o}`}buildUpdateSet(e,r){let n=e[C.Symbol.Columns],s=Object.keys(n).filter(o=>r[o]!==void 0||n[o]?.onUpdateFn!==void 0),i=s.length;return m.join(s.flatMap((o,a)=>{let l=n[o],c=l.onUpdateFn?.(),d=r[o]??(g(c,x)?c:m.param(c,l)),h=m`${m.identifier(this.casing.getColumnCasing(l))} = ${d}`;return a<i-1?[h,m.raw(", ")]:[h]}))}buildUpdateQuery({table:e,set:r,where:n,returning:s,withList:i,from:o,joins:a}){let l=this.buildWithCTE(i),c=e[Te.Symbol.Name],d=e[Te.Symbol.Schema],h=e[Te.Symbol.OriginalName],y=c===h?void 0:c,S=m`${d?m`${m.identifier(d)}.`:void 0}${m.identifier(h)}${y&&m` ${m.identifier(y)}`}`,$=this.buildUpdateSet(e,r),w=o&&m.join([m.raw(" from "),this.buildFromTable(o)]),E=this.buildJoins(a),N=s?m` returning ${this.buildSelection(s,{isSingleTable:!o})}`:void 0,U=n?m` where ${n}`:void 0;return m`${l}update ${S} set ${$}${w}${E}${U}${N}`}buildSelection(e,{isSingleTable:r=!1}={}){let n=e.length,s=e.flatMap(({field:i},o)=>{let a=[];if(g(i,x.Aliased)&&i.isSelectionField)a.push(m.identifier(i.fieldAlias));else if(g(i,x.Aliased)||g(i,x)){let l=g(i,x.Aliased)?i.sql:i;r?a.push(new x(l.queryChunks.map(c=>g(c,v)?m.identifier(this.casing.getColumnCasing(c)):c))):a.push(l),g(i,x.Aliased)&&a.push(m` as ${m.identifier(i.fieldAlias)}`)}else if(g(i,X))r?a.push(m.identifier(this.casing.getColumnCasing(i))):a.push(i);else if(g(i,ae)){let l=Object.entries(i._.selectedFields);if(l.length===1){let c=l[0][1],d=g(c,x)?c.decoder:g(c,X)?{mapFromDriverValue:h=>c.mapFromDriverValue(h)}:c.sql.decoder;d&&(i._.sql.decoder=d)}a.push(i)}return o<n-1&&a.push(m`, `),a});return m.join(s)}buildJoins(e){if(!e||e.length===0)return;let r=[];for(let[n,s]of e.entries()){n===0&&r.push(m` `);let i=s.table,o=s.lateral?m` lateral`:void 0,a=s.on?m` on ${s.on}`:void 0;if(g(i,Te)){let l=i[Te.Symbol.Name],c=i[Te.Symbol.Schema],d=i[Te.Symbol.OriginalName],h=l===d?void 0:s.alias;r.push(m`${m.raw(s.joinType)} join${o} ${c?m`${m.identifier(c)}.`:void 0}${m.identifier(d)}${h&&m` ${m.identifier(h)}`}${a}`)}else if(g(i,Le)){let l=i[se].name,c=i[se].schema,d=i[se].originalName,h=l===d?void 0:s.alias;r.push(m`${m.raw(s.joinType)} join${o} ${c?m`${m.identifier(c)}.`:void 0}${m.identifier(d)}${h&&m` ${m.identifier(h)}`}${a}`)}else r.push(m`${m.raw(s.joinType)} join${o} ${i}${a}`);n<e.length-1&&r.push(m` `)}return m.join(r)}buildFromTable(e){if(g(e,C)&&e[C.Symbol.IsAlias]){let r=m`${m.identifier(e[C.Symbol.OriginalName])}`;return e[C.Symbol.Schema]&&(r=m`${m.identifier(e[C.Symbol.Schema])}.${r}`),m`${r} ${m.identifier(e[C.Symbol.Name])}`}return e}buildSelectQuery({withList:e,fields:r,fieldsFlat:n,where:s,having:i,table:o,joins:a,orderBy:l,groupBy:c,limit:d,offset:h,lockingClause:y,distinct:S,setOperators:$}){let w=n??Ve(r);for(let F of w)if(g(F.field,X)&&qe(F.field.table)!==(g(o,ae)?o._.alias:g(o,Ut)?o[se].name:g(o,x)?void 0:qe(o))&&!(ie=>a?.some(({alias:et})=>et===(ie[C.Symbol.IsAlias]?qe(ie):ie[C.Symbol.BaseName])))(F.field.table)){let ie=qe(F.field.table);throw new Error(`Your "${F.path.join("->")}" field references a column "${ie}"."${F.field.name}", but the table "${ie}" is not part of the query! Did you forget to join it?`)}let E=!a||a.length===0,N=this.buildWithCTE(e),U;S&&(U=S===!0?m` distinct`:m` distinct on (${m.join(S.on,m`, `)})`);let V=this.buildSelection(w,{isSingleTable:E}),L=this.buildFromTable(o),z=this.buildJoins(a),J=s?m` where ${s}`:void 0,j=i?m` having ${i}`:void 0,D;l&&l.length>0&&(D=m` order by ${m.join(l,m`, `)}`);let le;c&&c.length>0&&(le=m` group by ${m.join(c,m`, `)}`);let q=typeof d=="object"||typeof d=="number"&&d>=0?m` limit ${d}`:void 0,T=h?m` offset ${h}`:void 0,Ne=m.empty();if(y){let F=m` for ${m.raw(y.strength)}`;y.config.of&&F.append(m` of ${m.join(Array.isArray(y.config.of)?y.config.of:[y.config.of],m`, `)}`),y.config.noWait?F.append(m` nowait`):y.config.skipLocked&&F.append(m` skip locked`),Ne.append(F)}let de=m`${N}select${U} ${V} from ${L}${z}${J}${le}${j}${D}${q}${T}${Ne}`;return $.length>0?this.buildSetOperations(de,$):de}buildSetOperations(e,r){let[n,...s]=r;if(!n)throw new Error("Cannot pass undefined values to any set operator");return s.length===0?this.buildSetOperationQuery({leftSelect:e,setOperator:n}):this.buildSetOperations(this.buildSetOperationQuery({leftSelect:e,setOperator:n}),s)}buildSetOperationQuery({leftSelect:e,setOperator:{type:r,isAll:n,rightSelect:s,limit:i,orderBy:o,offset:a}}){let l=m`(${e.getSQL()}) `,c=m`(${s.getSQL()})`,d;if(o&&o.length>0){let $=[];for(let w of o)if(g(w,v))$.push(m.identifier(w.name));else if(g(w,x)){for(let E=0;E<w.queryChunks.length;E++){let N=w.queryChunks[E];g(N,v)&&(w.queryChunks[E]=m.identifier(N.name))}$.push(m`${w}`)}else $.push(m`${w}`);d=m` order by ${m.join($,m`, `)} `}let h=typeof i=="object"||typeof i=="number"&&i>=0?m` limit ${i}`:void 0,y=m.raw(`${r} ${n?"all ":""}`),S=a?m` offset ${a}`:void 0;return m`${l}${y}${c}${d}${h}${S}`}buildInsertQuery({table:e,values:r,onConflict:n,returning:s,withList:i,select:o,overridingSystemValue_:a}){let l=[],c=e[C.Symbol.Columns],d=Object.entries(c).filter(([N,U])=>!U.shouldDisableInsert()),h=d.map(([,N])=>m.identifier(this.casing.getColumnCasing(N)));if(o){let N=r;g(N,x)?l.push(N):l.push(N.getSQL())}else{let N=r;l.push(m.raw("values "));for(let[U,V]of N.entries()){let L=[];for(let[z,J]of d){let j=V[z];if(j===void 0||g(j,Fe)&&j.value===void 0)if(J.defaultFn!==void 0){let D=J.defaultFn(),le=g(D,x)?D:m.param(D,J);L.push(le)}else if(!J.default&&J.onUpdateFn!==void 0){let D=J.onUpdateFn(),le=g(D,x)?D:m.param(D,J);L.push(le)}else L.push(m`default`);else L.push(j)}l.push(L),U<N.length-1&&l.push(m`, `)}}let y=this.buildWithCTE(i),S=m.join(l),$=s?m` returning ${this.buildSelection(s,{isSingleTable:!0})}`:void 0,w=n?m` on conflict ${n}`:void 0,E=a===!0?m`overriding system value `:void 0;return m`${y}insert into ${e} ${h} ${E}${S}${w}${$}`}buildRefreshMaterializedViewQuery({view:e,concurrently:r,withNoData:n}){let s=r?m` concurrently`:void 0,i=n?m` with no data`:void 0;return m`refresh materialized view${s} ${e}${i}`}prepareTyping(e){return g(e,wr)||g(e,yr)?"json":g(e,Sr)?"decimal":g(e,vr)?"time":g(e,Cr)||g(e,Tr)?"timestamp":g(e,pr)||g(e,gr)?"date":g(e,Ar)?"uuid":"none"}sqlToQuery(e,r){return e.toQuery({casing:this.casing,escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString,prepareTyping:this.prepareTyping,invokeSource:r})}buildRelationalQueryWithoutPK({fullSchema:e,schema:r,tableNamesMap:n,table:s,tableConfig:i,queryConfig:o,tableAlias:a,nestedQueryRelation:l,joinOn:c}){let d=[],h,y,S=[],$,w=[];if(o===!0)d=Object.entries(i.columns).map(([U,V])=>({dbKey:V.name,tsKey:U,field:rt(V,a),relationTableTsKey:void 0,isJson:!1,selection:[]}));else{let N=Object.fromEntries(Object.entries(i.columns).map(([j,D])=>[j,rt(D,a)]));if(o.where){let j=typeof o.where=="function"?o.where(N,El()):o.where;$=j&&fr(j,a)}let U=[],V=[];if(o.columns){let j=!1;for(let[D,le]of Object.entries(o.columns))le!==void 0&&D in i.columns&&(!j&&le===!0&&(j=!0),V.push(D));V.length>0&&(V=j?V.filter(D=>o.columns?.[D]===!0):Object.keys(i.columns).filter(D=>!V.includes(D)))}else V=Object.keys(i.columns);for(let j of V){let D=i.columns[j];U.push({tsKey:j,value:D})}let L=[];o.with&&(L=Object.entries(o.with).filter(j=>!!j[1]).map(([j,D])=>({tsKey:j,queryConfig:D,relation:i.relations[j]})));let z;if(o.extras){z=typeof o.extras=="function"?o.extras(N,{sql:m}):o.extras;for(let[j,D]of Object.entries(z))U.push({tsKey:j,value:Es(D,a)})}for(let{tsKey:j,value:D}of U)d.push({dbKey:g(D,x.Aliased)?D.fieldAlias:i.columns[j].name,tsKey:j,field:g(D,X)?rt(D,a):D,relationTableTsKey:void 0,isJson:!1,selection:[]});let J=typeof o.orderBy=="function"?o.orderBy(N,$l()):o.orderBy??[];Array.isArray(J)||(J=[J]),S=J.map(j=>g(j,X)?rt(j,a):fr(j,a)),h=o.limit,y=o.offset;for(let{tsKey:j,queryConfig:D,relation:le}of L){let q=Ol(r,n,le),T=$t(le.referencedTable),Ne=n[T],de=`${a}_${j}`,F=dt(...q.fields.map((Je,b)=>_(rt(q.references[b],de),rt(Je,a)))),ie=this.buildRelationalQueryWithoutPK({fullSchema:e,schema:r,tableNamesMap:n,table:e[Ne],tableConfig:r[Ne],queryConfig:g(le,bt)?D===!0?{limit:1}:{...D,limit:1}:D,tableAlias:de,joinOn:F,nestedQueryRelation:le}),et=m`${m.identifier(de)}.${m.identifier("data")}`.as(j);w.push({on:m`true`,table:new ae(ie.sql,{},de),alias:de,joinType:"left",lateral:!0}),d.push({dbKey:j,tsKey:j,field:et,relationTableTsKey:Ne,isJson:!0,selection:ie.selection})}}if(d.length===0)throw new Nr({message:`No fields selected for table "${i.tsName}" ("${a}")`});let E;if($=dt(c,$),l){let N=m`json_build_array(${m.join(d.map(({field:L,tsKey:z,isJson:J})=>J?m`${m.identifier(`${a}_${z}`)}.${m.identifier("data")}`:g(L,x.Aliased)?L.sql:L),m`, `)})`;g(l,Pr)&&(N=m`coalesce(json_agg(${N}${S.length>0?m` order by ${m.join(S,m`, `)}`:void 0}), '[]'::json)`);let U=[{dbKey:"data",tsKey:"data",field:N.as("data"),isJson:!0,relationTableTsKey:i.tsName,selection:d}];h!==void 0||y!==void 0||S.length>0?(E=this.buildSelectQuery({table:dr(s,a),fields:{},fieldsFlat:[{path:[],field:m.raw("*")}],where:$,limit:h,offset:y,orderBy:S,setOperators:[]}),$=void 0,h=void 0,y=void 0,S=[]):E=dr(s,a),E=this.buildSelectQuery({table:g(E,Te)?E:new ae(E,{},a),fields:{},fieldsFlat:U.map(({field:L})=>({path:[],field:g(L,X)?rt(L,a):L})),joins:w,where:$,limit:h,offset:y,orderBy:S,setOperators:[]})}else E=this.buildSelectQuery({table:dr(s,a),fields:{},fieldsFlat:d.map(({field:N})=>({path:[],field:g(N,X)?rt(N,a):N})),joins:w,where:$,limit:h,offset:y,orderBy:S,setOperators:[]});return{tableTsKey:i.tsName,sql:E,selection:d}}};var gn=class{static[f]="TypedQueryBuilder";getSelectedFields(){return this._.selectedFields}};var je=class{static[f]="PgSelectBuilder";fields;session;dialect;withList=[];distinct;constructor(e){this.fields=e.fields,this.session=e.session,this.dialect=e.dialect,e.withList&&(this.withList=e.withList),this.distinct=e.distinct}authToken;setToken(e){return this.authToken=e,this}from(e){let r=!!this.fields,n=e,s;return this.fields?s=this.fields:g(n,ae)?s=Object.fromEntries(Object.keys(n._.selectedFields).map(i=>[i,n[i]])):g(n,Ut)?s=n[se].selectedFields:g(n,x)?s={}:s=ja(n),new yn({table:n,fields:s,isPartialSelect:r,session:this.session,dialect:this.dialect,withList:this.withList,distinct:this.distinct}).setToken(this.authToken)}},Xi=class extends gn{static[f]="PgSelectQueryBuilder";_;config;joinsNotNullableMap;tableName;isPartialSelect;session;dialect;cacheConfig=void 0;usedTables=new Set;constructor({table:e,fields:r,isPartialSelect:n,session:s,dialect:i,withList:o,distinct:a}){super(),this.config={withList:o,table:e,fields:{...r},distinct:a,setOperators:[]},this.isPartialSelect=n,this.session=s,this.dialect=i,this._={selectedFields:r,config:this.config},this.tableName=at(e),this.joinsNotNullableMap=typeof this.tableName=="string"?{[this.tableName]:!0}:{};for(let l of Xe(e))this.usedTables.add(l)}getUsedTables(){return[...this.usedTables]}createJoin(e,r){return(n,s)=>{let i=this.tableName,o=at(n);for(let a of Xe(n))this.usedTables.add(a);if(typeof o=="string"&&this.config.joins?.some(a=>a.alias===o))throw new Error(`Alias "${o}" is already used in this query`);if(!this.isPartialSelect&&(Object.keys(this.joinsNotNullableMap).length===1&&typeof i=="string"&&(this.config.fields={[i]:this.config.fields}),typeof o=="string"&&!g(n,x))){let a=g(n,ae)?n._.selectedFields:g(n,Le)?n[se].selectedFields:n[C.Symbol.Columns];this.config.fields[o]=a}if(typeof s=="function"&&(s=s(new Proxy(this.config.fields,new we({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.joins||(this.config.joins=[]),this.config.joins.push({on:s,table:n,joinType:e,alias:o,lateral:r}),typeof o=="string")switch(e){case"left":{this.joinsNotNullableMap[o]=!1;break}case"right":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([a])=>[a,!1])),this.joinsNotNullableMap[o]=!0;break}case"cross":case"inner":{this.joinsNotNullableMap[o]=!0;break}case"full":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([a])=>[a,!1])),this.joinsNotNullableMap[o]=!1;break}}return this}}leftJoin=this.createJoin("left",!1);leftJoinLateral=this.createJoin("left",!0);rightJoin=this.createJoin("right",!1);innerJoin=this.createJoin("inner",!1);innerJoinLateral=this.createJoin("inner",!0);fullJoin=this.createJoin("full",!1);crossJoin=this.createJoin("cross",!1);crossJoinLateral=this.createJoin("cross",!0);createSetOperator(e,r){return n=>{let s=typeof n=="function"?n(ld()):n;if(!mr(this.getSelectedFields(),s.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return this.config.setOperators.push({type:e,isAll:r,rightSelect:s}),this}}union=this.createSetOperator("union",!1);unionAll=this.createSetOperator("union",!0);intersect=this.createSetOperator("intersect",!1);intersectAll=this.createSetOperator("intersect",!0);except=this.createSetOperator("except",!1);exceptAll=this.createSetOperator("except",!0);addSetOperators(e){return this.config.setOperators.push(...e),this}where(e){return typeof e=="function"&&(e=e(new Proxy(this.config.fields,new we({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.where=e,this}having(e){return typeof e=="function"&&(e=e(new Proxy(this.config.fields,new we({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.having=e,this}groupBy(...e){if(typeof e[0]=="function"){let r=e[0](new Proxy(this.config.fields,new we({sqlAliasedBehavior:"alias",sqlBehavior:"sql"})));this.config.groupBy=Array.isArray(r)?r:[r]}else this.config.groupBy=e;return this}orderBy(...e){if(typeof e[0]=="function"){let r=e[0](new Proxy(this.config.fields,new we({sqlAliasedBehavior:"alias",sqlBehavior:"sql"}))),n=Array.isArray(r)?r:[r];this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=n:this.config.orderBy=n}else{let r=e;this.config.setOperators.length>0?this.config.setOperators.at(-1).orderBy=r:this.config.orderBy=r}return this}limit(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).limit=e:this.config.limit=e,this}offset(e){return this.config.setOperators.length>0?this.config.setOperators.at(-1).offset=e:this.config.offset=e,this}for(e,r={}){return this.config.lockingClause={strength:e,config:r},this}getSQL(){return this.dialect.buildSelectQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}as(e){let r=[];if(r.push(...Xe(this.config.table)),this.config.joins)for(let n of this.config.joins)r.push(...Xe(n.table));return new Proxy(new ae(this.getSQL(),this.config.fields,e,!1,[...new Set(r)]),new we({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}getSelectedFields(){return new Proxy(this.config.fields,new we({alias:this.tableName,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}$dynamic(){return this}$withCache(e){return this.cacheConfig=e===void 0?{config:{},enable:!0,autoInvalidate:!0}:e===!1?{enable:!1}:{enable:!0,autoInvalidate:!0,...e},this}},yn=class extends Xi{static[f]="PgSelect";_prepare(e){let{session:r,config:n,dialect:s,joinsNotNullableMap:i,authToken:o,cacheConfig:a,usedTables:l}=this;if(!r)throw new Error("Cannot execute a query on a query builder. Please use a database instance instead.");let{fields:c}=n;return te.startActiveSpan("drizzle.prepareQuery",()=>{let d=Ve(c),h=r.prepareQuery(s.sqlToQuery(this.getSQL()),d,e,!0,void 0,{type:"select",tables:[...l]},a);return h.joinsNotNullableMap=i,h.setToken(o)})}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>te.startActiveSpan("drizzle.operation",()=>this._prepare().execute(e,this.authToken))};Ra(yn,[Oe]);function Mt(t,e){return(r,n,...s)=>{let i=[n,...s].map(o=>({type:t,isAll:e,rightSelect:o}));for(let o of i)if(!mr(r.getSelectedFields(),o.rightSelect.getSelectedFields()))throw new Error("Set operator error (union / intersect / except): selected fields are not the same or are in a different order");return r.addSetOperators(i)}}var ld=()=>({union:cd,unionAll:ud,intersect:dd,intersectAll:fd,except:md,exceptAll:hd}),cd=Mt("union",!1),ud=Mt("union",!0),dd=Mt("intersect",!1),fd=Mt("intersect",!0),md=Mt("except",!1),hd=Mt("except",!0);var Kt=class{static[f]="PgQueryBuilder";dialect;dialectConfig;constructor(e){this.dialect=g(e,St)?e:void 0,this.dialectConfig=g(e,St)?void 0:e}$with=(e,r)=>{let n=this;return{as:i=>(typeof i=="function"&&(i=i(n)),new Proxy(new zt(i.getSQL(),r??("getSelectedFields"in i?i.getSelectedFields()??{}:{}),e,!0),new we({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"})))}};with(...e){let r=this;function n(o){return new je({fields:o??void 0,session:void 0,dialect:r.getDialect(),withList:e})}function s(o){return new je({fields:o??void 0,session:void 0,dialect:r.getDialect(),distinct:!0})}function i(o,a){return new je({fields:a??void 0,session:void 0,dialect:r.getDialect(),distinct:{on:o}})}return{select:n,selectDistinct:s,selectDistinctOn:i}}select(e){return new je({fields:e??void 0,session:void 0,dialect:this.getDialect()})}selectDistinct(e){return new je({fields:e??void 0,session:void 0,dialect:this.getDialect(),distinct:!0})}selectDistinctOn(e,r){return new je({fields:r??void 0,session:void 0,dialect:this.getDialect(),distinct:{on:e}})}getDialect(){return this.dialect||(this.dialect=new St(this.dialectConfig)),this.dialect}};function Xe(t){return g(t,Te)?[t[Et]?`${t[Et]}.${t[C.Symbol.BaseName]}`:t[C.Symbol.BaseName]]:g(t,ae)?t._.usedTables??[]:g(t,x)?t.usedTables??[]:[]}var xr=class extends Oe{constructor(e,r,n,s){super(),this.session=r,this.dialect=n,this.config={table:e,withList:s}}static[f]="PgDelete";config;cacheConfig;where(e){return this.config.where=e,this}returning(e=this.config.table[C.Symbol.Columns]){return this.config.returningFields=e,this.config.returning=Ve(e),this}getSQL(){return this.dialect.buildDeleteQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){return te.startActiveSpan("drizzle.prepareQuery",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0,void 0,{type:"delete",tables:Xe(this.config.table)},this.cacheConfig))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>te.startActiveSpan("drizzle.operation",()=>this._prepare().execute(e,this.authToken));getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new we({alias:qe(this.config.table),sqlAliasedBehavior:"alias",sqlBehavior:"error"})):void 0}$dynamic(){return this}};var Er=class{constructor(e,r,n,s,i){this.table=e,this.session=r,this.dialect=n,this.withList=s,this.overridingSystemValue_=i}static[f]="PgInsertBuilder";authToken;setToken(e){return this.authToken=e,this}overridingSystemValue(){return this.overridingSystemValue_=!0,this}values(e){if(e=Array.isArray(e)?e:[e],e.length===0)throw new Error("values() must be called with at least one value");let r=e.map(n=>{let s={},i=this.table[C.Symbol.Columns];for(let o of Object.keys(n)){let a=n[o];s[o]=g(a,x)?a:new Fe(a,i[o])}return s});return new wn(this.table,r,this.session,this.dialect,this.withList,!1,this.overridingSystemValue_).setToken(this.authToken)}select(e){let r=typeof e=="function"?e(new Kt):e;if(!g(r,x)&&!mr(this.table[cn],r._.selectedFields))throw new Error("Insert select error: selected fields are not the same or are in a different order compared to the table definition");return new wn(this.table,r,this.session,this.dialect,this.withList,!0)}},wn=class extends Oe{constructor(e,r,n,s,i,o,a){super(),this.session=n,this.dialect=s,this.config={table:e,values:r,withList:i,select:o,overridingSystemValue_:a}}static[f]="PgInsert";config;cacheConfig;returning(e=this.config.table[C.Symbol.Columns]){return this.config.returningFields=e,this.config.returning=Ve(e),this}onConflictDoNothing(e={}){if(e.target===void 0)this.config.onConflict=m`do nothing`;else{let r="";r=Array.isArray(e.target)?e.target.map(s=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(s))).join(","):this.dialect.escapeName(this.dialect.casing.getColumnCasing(e.target));let n=e.where?m` where ${e.where}`:void 0;this.config.onConflict=m`(${m.raw(r)})${n} do nothing`}return this}onConflictDoUpdate(e){if(e.where&&(e.targetWhere||e.setWhere))throw new Error('You cannot use both "where" and "targetWhere"/"setWhere" at the same time - "where" is deprecated, use "targetWhere" or "setWhere" instead.');let r=e.where?m` where ${e.where}`:void 0,n=e.targetWhere?m` where ${e.targetWhere}`:void 0,s=e.setWhere?m` where ${e.setWhere}`:void 0,i=this.dialect.buildUpdateSet(this.config.table,un(this.config.table,e.set)),o="";return o=Array.isArray(e.target)?e.target.map(a=>this.dialect.escapeName(this.dialect.casing.getColumnCasing(a))).join(","):this.dialect.escapeName(this.dialect.casing.getColumnCasing(e.target)),this.config.onConflict=m`(${m.raw(o)})${n} do update set ${i}${r}${s}`,this}getSQL(){return this.dialect.buildInsertQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){return te.startActiveSpan("drizzle.prepareQuery",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0,void 0,{type:"insert",tables:Xe(this.config.table)},this.cacheConfig))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>te.startActiveSpan("drizzle.operation",()=>this._prepare().execute(e,this.authToken));getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new we({alias:qe(this.config.table),sqlAliasedBehavior:"alias",sqlBehavior:"error"})):void 0}$dynamic(){return this}};var bn=class extends Oe{constructor(e,r,n){super(),this.session=r,this.dialect=n,this.config={view:e}}static[f]="PgRefreshMaterializedView";config;concurrently(){if(this.config.withNoData!==void 0)throw new Error("Cannot use concurrently and withNoData together");return this.config.concurrently=!0,this}withNoData(){if(this.config.concurrently!==void 0)throw new Error("Cannot use concurrently and withNoData together");return this.config.withNoData=!0,this}getSQL(){return this.dialect.buildRefreshMaterializedViewQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){return te.startActiveSpan("drizzle.prepareQuery",()=>this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),void 0,e,!0))}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>te.startActiveSpan("drizzle.operation",()=>this._prepare().execute(e,this.authToken))};var $r=class{constructor(e,r,n,s){this.table=e,this.session=r,this.dialect=n,this.withList=s}static[f]="PgUpdateBuilder";authToken;setToken(e){return this.authToken=e,this}set(e){return new Zi(this.table,un(this.table,e),this.session,this.dialect,this.withList).setToken(this.authToken)}},Zi=class extends Oe{constructor(e,r,n,s,i){super(),this.session=n,this.dialect=s,this.config={set:r,table:e,withList:i,joins:[]},this.tableName=at(e),this.joinsNotNullableMap=typeof this.tableName=="string"?{[this.tableName]:!0}:{}}static[f]="PgUpdate";config;tableName;joinsNotNullableMap;cacheConfig;from(e){let r=e,n=at(r);return typeof n=="string"&&(this.joinsNotNullableMap[n]=!0),this.config.from=r,this}getTableLikeFields(e){return g(e,Te)?e[C.Symbol.Columns]:g(e,ae)?e._.selectedFields:e[se].selectedFields}createJoin(e){return(r,n)=>{let s=at(r);if(typeof s=="string"&&this.config.joins.some(i=>i.alias===s))throw new Error(`Alias "${s}" is already used in this query`);if(typeof n=="function"){let i=this.config.from&&!g(this.config.from,x)?this.getTableLikeFields(this.config.from):void 0;n=n(new Proxy(this.config.table[C.Symbol.Columns],new we({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})),i&&new Proxy(i,new we({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))}if(this.config.joins.push({on:n,table:r,joinType:e,alias:s}),typeof s=="string")switch(e){case"left":{this.joinsNotNullableMap[s]=!1;break}case"right":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([i])=>[i,!1])),this.joinsNotNullableMap[s]=!0;break}case"inner":{this.joinsNotNullableMap[s]=!0;break}case"full":{this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map(([i])=>[i,!1])),this.joinsNotNullableMap[s]=!1;break}}return this}}leftJoin=this.createJoin("left");rightJoin=this.createJoin("right");innerJoin=this.createJoin("inner");fullJoin=this.createJoin("full");where(e){return this.config.where=e,this}returning(e){if(!e&&(e=Object.assign({},this.config.table[C.Symbol.Columns]),this.config.from)){let r=at(this.config.from);if(typeof r=="string"&&this.config.from&&!g(this.config.from,x)){let n=this.getTableLikeFields(this.config.from);e[r]=n}for(let n of this.config.joins){let s=at(n.table);if(typeof s=="string"&&!g(n.table,x)){let i=this.getTableLikeFields(n.table);e[s]=i}}}return this.config.returningFields=e,this.config.returning=Ve(e),this}getSQL(){return this.dialect.buildUpdateQuery(this.config)}toSQL(){let{typings:e,...r}=this.dialect.sqlToQuery(this.getSQL());return r}_prepare(e){let r=this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning,e,!0,void 0,{type:"insert",tables:Xe(this.config.table)},this.cacheConfig);return r.joinsNotNullableMap=this.joinsNotNullableMap,r}prepare(e){return this._prepare(e)}authToken;setToken(e){return this.authToken=e,this}execute=e=>this._prepare().execute(e,this.authToken);getSelectedFields(){return this.config.returningFields?new Proxy(this.config.returningFields,new we({alias:qe(this.config.table),sqlAliasedBehavior:"alias",sqlBehavior:"error"})):void 0}$dynamic(){return this}};var Sn=class t extends x{constructor(e){super(t.buildEmbeddedCount(e.source,e.filters).queryChunks),this.params=e,this.mapWith(Number),this.session=e.session,this.sql=t.buildCount(e.source,e.filters)}sql;token;static[f]="PgCountBuilder";[Symbol.toStringTag]="PgCountBuilder";session;static buildEmbeddedCount(e,r){return m`(select count(*) from ${e}${m.raw(" where ").if(r)}${r})`}static buildCount(e,r){return m`select count(*) as count from ${e}${m.raw(" where ").if(r)}${r};`}setToken(e){return this.token=e,this}then(e,r){return Promise.resolve(this.session.count(this.sql,this.token)).then(e,r)}catch(e){return this.then(void 0,e)}finally(e){return this.then(r=>(e?.(),r),r=>{throw e?.(),r})}};var vn=class{constructor(e,r,n,s,i,o,a){this.fullSchema=e,this.schema=r,this.tableNamesMap=n,this.table=s,this.tableConfig=i,this.dialect=o,this.session=a}static[f]="PgRelationalQueryBuilder";findMany(e){return new Cn(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e||{},"many")}findFirst(e){return new Cn(this.fullSchema,this.schema,this.tableNamesMap,this.table,this.tableConfig,this.dialect,this.session,e?{...e,limit:1}:{limit:1},"first")}},Cn=class extends Oe{constructor(e,r,n,s,i,o,a,l,c){super(),this.fullSchema=e,this.schema=r,this.tableNamesMap=n,this.table=s,this.tableConfig=i,this.dialect=o,this.session=a,this.config=l,this.mode=c}static[f]="PgRelationalQuery";_prepare(e){return te.startActiveSpan("drizzle.prepareQuery",()=>{let{query:r,builtQuery:n}=this._toSQL();return this.session.prepareQuery(n,void 0,e,!0,(s,i)=>{let o=s.map(a=>pn(this.schema,this.tableConfig,a,r.selection,i));return this.mode==="first"?o[0]:o})})}prepare(e){return this._prepare(e)}_getQuery(){return this.dialect.buildRelationalQueryWithoutPK({fullSchema:this.fullSchema,schema:this.schema,tableNamesMap:this.tableNamesMap,table:this.table,tableConfig:this.tableConfig,queryConfig:this.config,tableAlias:this.tableConfig.tsName})}getSQL(){return this._getQuery().sql}_toSQL(){let e=this._getQuery(),r=this.dialect.sqlToQuery(e.sql);return{query:e,builtQuery:r}}toSQL(){return this._toSQL().builtQuery}authToken;setToken(e){return this.authToken=e,this}execute(){return te.startActiveSpan("drizzle.operation",()=>this._prepare().execute(void 0,this.authToken))}};var Tn=class extends Oe{constructor(e,r,n,s){super(),this.execute=e,this.sql=r,this.query=n,this.mapBatchResult=s}static[f]="PgRaw";getSQL(){return this.sql}getQuery(){return this.query}mapResult(e,r){return r?this.mapBatchResult(e):e}_prepare(){return this}isResponseInArrayMode(){return!1}};var Vt=class{constructor(e,r,n){if(this.dialect=e,this.session=r,this._=n?{schema:n.schema,fullSchema:n.fullSchema,tableNamesMap:n.tableNamesMap,session:r}:{schema:void 0,fullSchema:{},tableNamesMap:{},session:r},this.query={},this._.schema)for(let[s,i]of Object.entries(this._.schema))this.query[s]=new vn(n.fullSchema,this._.schema,this._.tableNamesMap,n.fullSchema[s],i,e,r);this.$cache={invalidate:async s=>{}}}static[f]="PgDatabase";query;$with=(e,r)=>{let n=this;return{as:i=>(typeof i=="function"&&(i=i(new Kt(n.dialect))),new Proxy(new zt(i.getSQL(),r??("getSelectedFields"in i?i.getSelectedFields()??{}:{}),e,!0),new we({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"})))}};$count(e,r){return new Sn({source:e,filters:r,session:this.session})}$cache;with(...e){let r=this;function n(c){return new je({fields:c??void 0,session:r.session,dialect:r.dialect,withList:e})}function s(c){return new je({fields:c??void 0,session:r.session,dialect:r.dialect,withList:e,distinct:!0})}function i(c,d){return new je({fields:d??void 0,session:r.session,dialect:r.dialect,withList:e,distinct:{on:c}})}function o(c){return new $r(c,r.session,r.dialect,e)}function a(c){return new Er(c,r.session,r.dialect,e)}function l(c){return new xr(c,r.session,r.dialect,e)}return{select:n,selectDistinct:s,selectDistinctOn:i,update:o,insert:a,delete:l}}select(e){return new je({fields:e??void 0,session:this.session,dialect:this.dialect})}selectDistinct(e){return new je({fields:e??void 0,session:this.session,dialect:this.dialect,distinct:!0})}selectDistinctOn(e,r){return new je({fields:r??void 0,session:this.session,dialect:this.dialect,distinct:{on:e}})}update(e){return new $r(e,this.session,this.dialect)}insert(e){return new Er(e,this.session,this.dialect)}delete(e){return new xr(e,this.session,this.dialect)}refreshMaterializedView(e){return new bn(e,this.session,this.dialect)}authToken;execute(e){let r=typeof e=="string"?m.raw(e):e.getSQL(),n=this.dialect.sqlToQuery(r),s=this.session.prepareQuery(n,void 0,void 0,!1);return new Tn(()=>s.execute(void 0,this.authToken),r,n,i=>s.mapResult(i,!0))}transaction(e,r){return this.session.transaction(e,r)}};var eo=class{static[f]="Cache"},Ht=class extends eo{strategy(){return"all"}static[f]="NoopCache";async get(e){}async put(e,r,n,s){}async onMutate(e){}};async function to(t,e){let r=`${t}-${JSON.stringify(e)}`,s=new TextEncoder().encode(r),i=await crypto.subtle.digest("SHA-256",s);return[...new Uint8Array(i)].map(l=>l.toString(16).padStart(2,"0")).join("")}var An=class{constructor(e,r,n,s){this.query=e,this.cache=r,this.queryMetadata=n,this.cacheConfig=s,r&&r.strategy()==="all"&&s===void 0&&(this.cacheConfig={enable:!0,autoInvalidate:!0}),this.cacheConfig?.enable||(this.cacheConfig=void 0)}authToken;getQuery(){return this.query}mapResult(e,r){return e}setToken(e){return this.authToken=e,this}static[f]="PgPreparedQuery";joinsNotNullableMap;async queryWithCache(e,r,n){if(this.cache===void 0||g(this.cache,Ht)||this.queryMetadata===void 0)try{return await n()}catch(s){throw new ut(e,r,s)}if(this.cacheConfig&&!this.cacheConfig.enable)try{return await n()}catch(s){throw new ut(e,r,s)}if((this.queryMetadata.type==="insert"||this.queryMetadata.type==="update"||this.queryMetadata.type==="delete")&&this.queryMetadata.tables.length>0)try{let[s]=await Promise.all([n(),this.cache.onMutate({tables:this.queryMetadata.tables})]);return s}catch(s){throw new ut(e,r,s)}if(!this.cacheConfig)try{return await n()}catch(s){throw new ut(e,r,s)}if(this.queryMetadata.type==="select"){let s=await this.cache.get(this.cacheConfig.tag??await to(e,r),this.queryMetadata.tables,this.cacheConfig.tag!==void 0,this.cacheConfig.autoInvalidate);if(s===void 0){let i;try{i=await n()}catch(o){throw new ut(e,r,o)}return await this.cache.put(this.cacheConfig.tag??await to(e,r),i,this.cacheConfig.autoInvalidate?this.queryMetadata.tables:[],this.cacheConfig.tag!==void 0,this.cacheConfig.config),i}return s}try{return await n()}catch(s){throw new ut(e,r,s)}}},Nn=class{constructor(e){this.dialect=e}static[f]="PgSession";execute(e,r){return te.startActiveSpan("drizzle.operation",()=>te.startActiveSpan("drizzle.prepareQuery",()=>this.prepareQuery(this.dialect.sqlToQuery(e),void 0,void 0,!1)).setToken(r).execute(void 0,r))}all(e){return this.prepareQuery(this.dialect.sqlToQuery(e),void 0,void 0,!1).all()}async count(e,r){let n=await this.execute(e,r);return Number(n[0].count)}},Pn=class extends Vt{constructor(e,r,n,s=0){super(e,r,n),this.schema=n,this.nestedIndex=s}static[f]="PgTransaction";rollback(){throw new mn}getTransactionConfigSQL(e){let r=[];return e.isolationLevel&&r.push(`isolation level ${e.isolationLevel}`),e.accessMode&&r.push(e.accessMode),typeof e.deferrable=="boolean"&&r.push(e.deferrable?"deferrable":"not deferrable"),m.raw(r.join(" "))}setTransaction(e){return this.session.execute(m`set transaction ${this.getTransactionConfigSQL(e)}`)}};var ro=class extends An{constructor(e,r,n,s,i,o,a,l,c,d){super({sql:r,params:n},i,o,a),this.client=e,this.queryString=r,this.params=n,this.logger=s,this.fields=l,this._isResponseInArrayMode=c,this.customResultMapper=d}static[f]="PostgresJsPreparedQuery";async execute(e={}){return te.startActiveSpan("drizzle.execute",async r=>{let n=xs(this.params,e);r?.setAttributes({"drizzle.query.text":this.queryString,"drizzle.query.params":JSON.stringify(n)}),this.logger.logQuery(this.queryString,n);let{fields:s,queryString:i,client:o,joinsNotNullableMap:a,customResultMapper:l}=this;if(!s&&!l)return te.startActiveSpan("drizzle.driver.execute",()=>this.queryWithCache(i,n,async()=>await o.unsafe(i,n)));let c=await te.startActiveSpan("drizzle.driver.execute",()=>(r?.setAttributes({"drizzle.query.text":i,"drizzle.query.params":JSON.stringify(n)}),this.queryWithCache(i,n,async()=>await o.unsafe(i,n).values())));return te.startActiveSpan("drizzle.mapResponse",()=>l?l(c):c.map(d=>Oa(s,d,a)))})}all(e={}){return te.startActiveSpan("drizzle.execute",async r=>{let n=xs(this.params,e);return r?.setAttributes({"drizzle.query.text":this.queryString,"drizzle.query.params":JSON.stringify(n)}),this.logger.logQuery(this.queryString,n),te.startActiveSpan("drizzle.driver.execute",()=>(r?.setAttributes({"drizzle.query.text":this.queryString,"drizzle.query.params":JSON.stringify(n)}),this.queryWithCache(this.queryString,n,async()=>this.client.unsafe(this.queryString,n))))})}isResponseInArrayMode(){return this._isResponseInArrayMode}},_r=class t extends Nn{constructor(e,r,n,s={}){super(r),this.client=e,this.schema=n,this.options=s,this.logger=s.logger??new nn,this.cache=s.cache??new Ht}static[f]="PostgresJsSession";logger;cache;prepareQuery(e,r,n,s,i,o,a){return new ro(this.client,e.sql,e.params,this.logger,this.cache,o,a,r,s,i)}query(e,r){return this.logger.logQuery(e,r),this.client.unsafe(e,r).values()}queryObjects(e,r){return this.client.unsafe(e,r)}transaction(e,r){return this.client.begin(async n=>{let s=new t(n,this.dialect,this.schema,this.options),i=new no(this.dialect,s,this.schema);return r&&await i.setTransaction(r),e(i)})}},no=class t extends Pn{constructor(e,r,n,s=0){super(e,r,n,s),this.session=r}static[f]="PostgresJsTransaction";transaction(e){return this.session.client.savepoint(r=>{let n=new _r(r,this.dialect,this.schema,this.session.options),s=new t(this.dialect,n,this.schema);return e(s)})}};var so=class extends Vt{static[f]="PostgresJsDatabase"};function Wt(t,e={}){let r=l=>l;for(let l of["1184","1082","1083","1114","1182","1185","1115","1231"])t.options.parsers[l]=r,t.options.serializers[l]=r;t.options.serializers[114]=r,t.options.serializers[3802]=r;let n=new St({casing:e.casing}),s;e.logger===!0?s=new rn:e.logger!==!1&&(s=e.logger);let i;if(e.schema){let l=_l(e.schema,Rl);i={fullSchema:e.schema,schema:l.tables,tableNamesMap:l.tableNamesMap}}let o=new _r(t,n,i,{logger:s,cache:e.cache}),a=new so(n,o,i);return a.$client=t,a.$cache=e.cache,a.$cache&&(a.$cache.invalidate=e.cache?.onMutate),a}function xn(...t){if(typeof t[0]=="string"){let e=qt(t[0]);return Wt(e,t[1])}if(Ia(t[0])){let{connection:e,client:r,...n}=t[0];if(r)return Wt(r,n);if(typeof e=="object"&&e.url!==void 0){let{url:i,...o}=e,a=qt(i,o);return Wt(a,n)}let s=qt(e);return Wt(s,n)}return Wt(t[0],t[1])}(t=>{function e(r){return Wt({options:{parsers:{},serializers:{}}},r)}t.mock=e})(xn||(xn={}));var oo={};Vc(oo,{adminActions:()=>gd,agents:()=>We,contentPosts:()=>yd,contentTypeEnum:()=>Ll,dailyYieldLogs:()=>ft,fiatAccounts:()=>vt,loyaltyTiers:()=>pd,pointsBalance:()=>ee,pointsLedger:()=>Y,pointsSourceEnum:()=>Dl,redeemCatalog:()=>Ae,redeemRequests:()=>Q,redeemStatusEnum:()=>Bl,referrals:()=>io,roleEnum:()=>jl,statusEnum:()=>Il,users:()=>R});var jl=Ft("user_role",["user","agent","admin","super_admin"]),Il=Ft("user_status",["pending","active","suspended"]),Dl=Ft("points_source",["system","admin","redeem","yield","transaction"]),Bl=Ft("redeem_status",["pending","processing","ready","completed","cancelled","rejected"]),Ll=Ft("content_type",["news","promo","testimonial"]),R=Me("users",{id:he("id").primaryKey().defaultRandom(),email:ve("email",{length:255}).notNull().unique(),passwordHash:ct("password_hash").notNull(),name:ve("name",{length:255}).notNull(),phone:ve("phone",{length:20}),city:ve("city",{length:100}),walletAddress:ve("wallet_address",{length:42}),role:jl("role").default("user").notNull(),status:Il("status").default("pending").notNull(),createdAt:Re("created_at").defaultNow().notNull(),updatedAt:Re("updated_at").defaultNow().notNull()}),We=Me("agents",{id:he("id").primaryKey().defaultRandom(),userId:he("user_id").references(()=>R.id).notNull(),referralCode:ve("referral_code",{length:50}).notNull().unique(),isActive:hr("is_active").default(!0).notNull(),createdAt:Re("created_at").defaultNow().notNull()}),io=Me("referrals",{id:he("id").primaryKey().defaultRandom(),userId:he("user_id").references(()=>R.id).notNull(),agentId:he("agent_id").references(()=>We.id).notNull(),txHash:ve("tx_hash",{length:100}).notNull(),blockNumber:He("block_number"),createdAt:Re("created_at").defaultNow().notNull()}),ee=Me("points_balance",{userId:he("user_id").primaryKey().references(()=>R.id).notNull(),balance:He("balance").default(0).notNull(),updatedAt:Re("updated_at").defaultNow().notNull()}),Y=Me("points_ledger",{id:he("id").primaryKey().defaultRandom(),userId:he("user_id").references(()=>R.id).notNull(),amount:He("amount").notNull(),reason:ct("reason").notNull(),source:Dl("source").notNull(),adminId:he("admin_id").references(()=>R.id),txHash:ve("tx_hash",{length:100}),createdAt:Re("created_at").defaultNow().notNull()}),vt=Me("fiat_accounts",{id:he("id").primaryKey().defaultRandom(),userId:he("user_id").references(()=>R.id).notNull().unique(),balance:Ot("balance",{precision:20,scale:2}).default("0").notNull(),currency:ve("currency",{length:10}).default("IDR").notNull(),updatedAt:Re("updated_at").defaultNow().notNull()}),pd=Me("loyalty_tiers",{id:He("id").primaryKey().generatedAlwaysAsIdentity(),name:ve("name",{length:50}).notNull(),minAum:Ot("min_aum",{precision:20,scale:2}).notNull(),yieldMultiplier:Ot("yield_multiplier",{precision:5,scale:2}).notNull(),description:ct("description")}),ft=Me("daily_yield_logs",{id:he("id").primaryKey().defaultRandom(),userId:he("user_id").references(()=>R.id).notNull(),date:ve("date",{length:10}).notNull(),totalAum:Ot("total_aum",{precision:20,scale:2}).notNull(),yieldEarned:He("yield_earned").notNull(),tierAtTime:ve("tier_at_time",{length:50}).notNull(),createdAt:Re("created_at").defaultNow().notNull()}),Ae=Me("redeem_catalog",{id:He("id").primaryKey().generatedAlwaysAsIdentity(),name:ve("name",{length:255}).notNull(),pointsRequired:He("points_required").notNull(),description:ct("description"),isActive:hr("is_active").default(!0).notNull()}),Q=Me("redeem_requests",{id:he("id").primaryKey().defaultRandom(),userId:he("user_id").references(()=>R.id).notNull(),rewardId:He("reward_id").references(()=>Ae.id).notNull(),pointsUsed:He("points_used").notNull(),whatsappNumber:ve("whatsapp_number",{length:20}).notNull(),status:Bl("status").default("pending").notNull(),txHash:ve("tx_hash",{length:100}),metadata:br("metadata"),createdAt:Re("created_at").defaultNow().notNull(),updatedAt:Re("updated_at").defaultNow().notNull()}),gd=Me("admin_actions",{id:he("id").primaryKey().defaultRandom(),adminId:he("admin_id").references(()=>R.id).notNull(),actionType:ve("action_type",{length:100}).notNull(),entity:ve("entity",{length:50}).notNull(),entityId:he("entity_id").notNull(),payload:br("payload"),createdAt:Re("created_at").defaultNow().notNull()}),yd=Me("content_posts",{id:he("id").primaryKey().defaultRandom(),title:ve("title",{length:255}).notNull(),type:Ll("type").notNull(),content:ct("content").notNull(),mediaUrl:ct("media_url"),publishedAt:Re("published_at"),createdAt:Re("created_at").defaultNow().notNull()});var ql=process.env.DATABASE_URL;if(!ql)throw new Error("DATABASE_URL is not configured");var Fl=globalThis,zl=Fl.conn??qt(ql,{prepare:!1});process.env.NODE_ENV!=="production"&&(Fl.conn=zl,console.log("\u{1F4E6} (Re)using database connection..."));var M=xn(zl,{schema:oo});import{ethers as Or}from"ethers";var Ql=()=>{let t=process.env.CONTRACT_REGISTRY,e=process.env.CONTRACT_LEDGER,r=process.env.CONTRACT_REDEEM;return!t||!e||!r?(console.warn("\u26A0\uFE0F Contract addresses not fully configured in environment variables."),console.warn(`   CONTRACT_REGISTRY: ${t||"NOT SET"}`),console.warn(`   CONTRACT_LEDGER: ${e||"NOT SET"}`),console.warn(`   CONTRACT_REDEEM: ${r||"NOT SET"}`),null):(console.log("\u{1F4E6} Contract Addresses Loaded from Environment:"),console.log(`   Registry: ${t}`),console.log(`   Ledger: ${e}`),console.log(`   Redeem: ${r}`),{registry:t,ledger:e,redeem:r})};console.log("\u{1F4E6} Initializing BlockchainService...");console.log(`   RPC: ${process.env.RPC_URL||"Hardhat local"}`);var st=Ql();st?console.log(`   Contracts: Registry=${st.registry}, Ledger=${st.ledger}, Redeem=${st.redeem}`):console.error("   \u274C Failed to load contract addresses!");var Rr=process.env.PRIVATE_KEY_OPERATOR||"";Rr?console.log(`   DEBUG: PK Profile - Length: ${Rr.length}, Starts with: ${Rr.substring(0,6)}...`):console.error("   \u274C FATAL: PRIVATE_KEY_OPERATOR is missing in .env!");var wd=new Or.JsonRpcProvider(process.env.RPC_URL||"http://127.0.0.1:8545"),mt=null;try{Rr&&(mt=new Or.Wallet(Rr,wd),console.log(`   Operator Wallet Address: ${mt.address}`))}catch(t){console.error(`   \u274C Invalid Private Key: ${t.message}`)}var ht={async bindReferral(t,e){if(!st?.registry)throw new Error("Contract address not found");if(!mt)throw new Error("Operator wallet not initialized");return await(await new Or.Contract(st.registry,["function bindReferral(address _user, address _agent) external"],mt).bindReferral(t,e)).wait()},async logPointsAdded(t,e,r){if(!st?.ledger)throw new Error("Contract address not found");if(!mt)throw new Error("Operator wallet not initialized");let n=new Or.Contract(st.ledger,["function addPoints(address _user, uint256 _amount, string calldata _reason) external"],mt),s=await mt.getNonce("pending");return await n.addPoints(t,e,r,{nonce:s})},async logRedemption(t,e,r){if(!st?.redeem)throw new Error("Contract address not found for RedeemLog");if(!mt)throw new Error("Operator wallet not initialized");let n=new Or.Contract(st.redeem,["function logRedeem(address _user, uint256 _serviceId, uint256 _pointsUsed) external"],mt),s=15e3;try{let i=n.logRedeem(t,e,r),o=await Promise.race([i,new Promise((a,l)=>setTimeout(()=>l(new Error("Transaction submission timeout")),s))]);return console.log(`   \u23F1\uFE0F Tx submitted: ${o.hash} (not waiting for confirmation)`),o}catch(i){throw console.error(`   \u274C Blockchain submission failed: ${i.message}`),i}}};var Ul=new Be;Ul.post("/register",bd("json",Go),async t=>{let{name:e,email:r,password:n,phone:s,city:i,walletAddress:o,referralCode:a}=t.req.valid("json");try{let l="0x0000000000000000000000000000000000000000",c;if(a){let[E]=await M.select({id:We.id,userId:We.userId,walletAddress:R.walletAddress}).from(We).leftJoin(R,_(We.userId,R.id)).where(_(We.referralCode,a)).limit(1);c=E,c&&c.walletAddress?l=c.walletAddress:console.warn(`Referral code ${a} not found or agent has no wallet.`)}let d=n||crypto.randomUUID(),h=await kl.genSalt(12),y=await kl.hash(d,h),S=await M.transaction(async E=>{let[N]=await E.insert(R).values({name:e,email:r,passwordHash:y,phone:s,city:i,walletAddress:o,role:"user",status:"active"}).returning();if(!N)throw new Error("Failed to create user");if(c&&c.id&&l!=="0x0000000000000000000000000000000000000000")try{let U=ht.bindReferral(o,l),V=new Promise((z,J)=>setTimeout(()=>J(new Error("Blockchain timeout")),5e3)),L=await Promise.race([U,V]);L&&await E.insert(io).values({userId:N.id,agentId:c.id,txHash:L.hash,blockNumber:L.blockNumber})}catch(U){console.error("Blockchain binding passed/failed (Non-blocking):",U)}return c&&c.userId&&(console.log(`[Auth] Distributing Referral Reward to Agent: ${c.userId}`),await E.update(ee).set({balance:m`${ee.balance} + 50`}).where(_(ee.userId,c.userId)),await E.insert(Y).values({userId:c.userId,amount:50,source:"system",reason:`Referral Reward: ${N.name}`,createdAt:new Date})),console.log("[Auth] Initializing Points with Welcome Bonus..."),await E.insert(ee).values({userId:N.id,balance:10}),await E.insert(Y).values({userId:N.id,amount:10,source:"system",reason:"Welcome Bonus",createdAt:new Date}),N}),{passwordHash:$,...w}=S;return t.json({success:!0,message:"Nasabah berhasil terdaftar",data:w},201)}catch(l){return console.error("Auth Error:",l),l.message?.includes("users_email_unique")?t.json({success:!1,message:"Email sudah terdaftar"},400):t.json({success:!1,message:"Gagal memproses pendaftaran"},500)}});var Ml=Ul;var Sd=15500,vd=4e7,jr=[{name:"Bronze",minAum:0,multiplier:1},{name:"Silver",minAum:5e7,multiplier:1.2},{name:"Gold",minAum:25e7,multiplier:1.5},{name:"Platinum",minAum:1e9,multiplier:2}],En={async getFiatBalance(t){let e=await M.query.fiatAccounts.findFirst({where:_(vt.userId,t)});return e?parseFloat(e.balance):0},async getCryptoBalance(t){return 100*Sd+.01*vd},async calculateWealthProfile(t){let e=await M.query.users.findFirst({where:_(R.id,t)});if(!e)throw new Error("User not found");if(e.walletAddress)return this.calculateWealthProfileByWallet(e.walletAddress);let r=await this.getFiatBalance(t),n=0,s=r+n,i=jr[0];if(!i)throw new Error("Default tiers configuration error");let o=i;for(let a of jr)s>=a.minAum&&(o=a);return{userId:t,walletAddress:null,fiatBalance:r,cryptoBalance:n,totalAum:s,tier:o.name,multiplier:o.multiplier,nextTier:this.getNextTier(s)}},async calculateWealthProfileByWallet(t){let e=await M.query.users.findFirst({where:_(R.walletAddress,t)});if(!e)throw new Error("User not found for this wallet address");let r=await this.getFiatBalance(e.id),n=await this.getCryptoBalance(t),s=r+n,i=jr[0];if(!i)throw new Error("Default tiers configuration error");let o=i;for(let a of jr)s>=a.minAum&&(o=a);return{userId:e.id,walletAddress:t,fiatBalance:r,cryptoBalance:n,totalAum:s,tier:o.name,multiplier:o.multiplier,nextTier:this.getNextTier(s)}},getNextTier(t){for(let e of jr)if(e.minAum>t)return{name:e.name,needed:e.minAum-t};return null}};var Cd=5e5,ao={async calculateDailyYield(t){let e=await En.calculateWealthProfile(t),r=Math.floor(e.totalAum/Cd),n=Math.floor(r*e.multiplier);return{userId:t,totalAum:e.totalAum,tier:e.tier,multiplier:e.multiplier,basePoints:r,finalPoints:n}},async checkAndClaimYield(t){let e=new Date().toISOString().split("T")[0]??"";if(await M.query.dailyYieldLogs.findFirst({where:dt(_(ft.userId,t),_(ft.date,e))}))return{claimed:!1,reason:"Already claimed today"};let n=await this.calculateDailyYield(t);if(n.finalPoints<=0)return{claimed:!1,reason:"Zero points earned"};let s=await M.query.users.findFirst({where:_(R.id,t),columns:{walletAddress:!0}}),i=null;if(s?.walletAddress)try{i=(await ht.logPointsAdded(s.walletAddress,BigInt(n.finalPoints),"Daily Yield")).hash,console.log(`\u26D3\uFE0F On-chain Tx Sent: ${i}`)}catch(o){console.error(`\u26A0\uFE0F On-chain Log Failed for ${t}:`,o)}return await M.transaction(async o=>{await o.insert(ee).values({userId:t,balance:n.finalPoints}).onConflictDoUpdate({target:ee.userId,set:{balance:m`${ee.balance} + ${n.finalPoints}`}}),await o.insert(Y).values({userId:t,amount:n.finalPoints,source:"yield",reason:`Daily Yield for ${n.tier} Tier (AUM: ${n.totalAum})`,txHash:i}),await o.insert(ft).values({userId:t,date:e,totalAum:n.totalAum.toString(),yieldEarned:n.finalPoints,tierAtTime:n.tier})}),console.log(`\u2705 Yield Claimed for ${t}: ${n.finalPoints} pts`),{claimed:!0,points:n.finalPoints}}};var lo=new Be;lo.get("/profile",async t=>{let e=t.req.query("walletAddress");if(!e)return t.json({success:!1,message:"Wallet address required"},400);try{let r=await M.query.users.findFirst({where:_(R.walletAddress,e),columns:{id:!0}}),n=null;r&&(n=await ao.checkAndClaimYield(r.id));let[s]=await M.select({id:R.id,name:R.name,email:R.email,walletAddress:R.walletAddress,role:R.role,status:R.status,referralCode:We.referralCode,points:ee.balance}).from(R).leftJoin(ee,_(R.id,ee.userId)).leftJoin(We,_(R.id,We.userId)).where(_(R.walletAddress,e)).limit(1);if(!s)return t.json({success:!1,message:"User not found"},404);let i=await ao.calculateDailyYield(s.id);return t.json({success:!0,data:{...s,points:s.points||0,dailyYield:n,wealth:{totalAum:i.totalAum,estimatedYield:i.finalPoints,tier:i.tier}}})}catch(r){return console.error("Profile Error:",r),t.json({success:!1,message:"Failed to fetch profile"},500)}});lo.get("/activity",async t=>{let e=t.req.query("walletAddress");if(!e)return t.json({success:!1,message:"Wallet address required"},400);try{let[r]=await M.select({id:R.id}).from(R).where(_(R.walletAddress,e)).limit(1);if(!r)return t.json({success:!1,message:"User not found"},404);let n=await M.select({id:Y.id,amount:Y.amount,reason:Y.reason,source:Y.source,txHash:Y.txHash,createdAt:Y.createdAt,status:m`NULL`}).from(Y).where(_(Y.userId,r.id)).orderBy(kt(Y.createdAt)).limit(30),s=await M.select({reason:m`CONCAT('Redeem: ', ${Ae.name})`,status:Q.status,createdAt:Q.createdAt}).from(Q).leftJoin(Ae,_(Q.rewardId,Ae.id)).where(_(Q.userId,r.id)),i=n.map(o=>{if(o.reason.startsWith("Refund:"))return{...o,status:"refund"};if(o.source==="redeem"){let a=s.filter(d=>d.reason===o.reason);if(a.length===0)return{...o,status:"pending"};let l=new Date(o.createdAt).getTime(),c=a.reduce((d,h)=>{let y=Math.abs(new Date(d.createdAt).getTime()-l);return Math.abs(new Date(h.createdAt).getTime()-l)<y?h:d});return{...o,status:c.status}}return o});return t.json({success:!0,data:i})}catch(r){return console.error("Activity Error:",r),t.json({success:!1,message:"Failed to fetch activity"},500)}});var Kl=lo;import{zValidator as Vl}from"@hono/zod-validator";import{z as Jt}from"zod";var Ir=new Be,Td=Jt.object({userId:Jt.string().uuid(),rewardId:Jt.number().int(),whatsappNumber:Jt.string().min(10)});Ir.get("/catalog",async t=>{try{let e=await M.select().from(Ae).where(_(Ae.isActive,!0));return t.json({success:!0,data:e})}catch{return t.json({success:!1,message:"Failed to fetch catalog"},500)}});Ir.get("/my-requests",async t=>{let e=t.req.query("userId");if(!e)return t.json({success:!1,message:"User ID required"},400);try{let r=await M.select({id:Q.id,rewardId:Q.rewardId,itemName:Ae.name,pointsUsed:Q.pointsUsed,status:Q.status,txHash:Q.txHash,createdAt:Q.createdAt,updatedAt:Q.updatedAt}).from(Q).leftJoin(Ae,_(Q.rewardId,Ae.id)).where(_(Q.userId,e)).orderBy(kt(Q.createdAt));return t.json({success:!0,data:r})}catch(r){return console.error("My Requests Error:",r),t.json({success:!1,message:"Failed to fetch requests"},500)}});Ir.post("/",Vl("json",Td),async t=>{let{userId:e,rewardId:r,whatsappNumber:n}=t.req.valid("json");try{let s=await M.transaction(async o=>{let[a]=await o.select().from(Ae).where(_(Ae.id,r)).limit(1);if(!a)throw new Error("Reward Item not found");let[l]=await o.select({balance:ee.balance,walletAddress:R.walletAddress}).from(R).leftJoin(ee,_(ee.userId,R.id)).where(_(R.id,e)).limit(1);if((l?.balance||0)<a.pointsRequired)throw new Error("Insufficient points");await o.update(ee).set({balance:m`${ee.balance} - ${a.pointsRequired}`}).where(_(ee.userId,e));let[d]=await o.insert(Y).values({userId:e,amount:-a.pointsRequired,reason:`Redeem: ${a.name}`,source:"redeem"}).returning({id:Y.id});if(!d)throw new Error("Failed to create ledger entry");let[h]=await o.insert(Q).values({userId:e,rewardId:r,pointsUsed:a.pointsRequired,whatsappNumber:n,status:"pending",metadata:{itemName:a.name,price:a.pointsRequired}}).returning({id:Q.id});if(!h)throw new Error("Failed to create redeem request");return{requestId:h.id,ledgerId:d.id,walletAddress:l?.walletAddress,pointsUsed:a.pointsRequired}}),i=null;if(s.walletAddress)try{console.log(`\u{1F4E1} Dispatching Blockchain Oracle for Request ${s.requestId}...`);let o=await ht.logRedemption(s.walletAddress,r,s.pointsUsed);o&&o.hash&&(i=o.hash,console.log(`\u2705 Audit Trail Success: ${i}`),await M.update(Q).set({status:"processing",txHash:i,updatedAt:new Date}).where(_(Q.id,s.requestId)),await M.update(Y).set({txHash:i}).where(_(Y.id,s.ledgerId)))}catch(o){console.error(`\u26A0\uFE0F Blockchain Audit Warning (Request ${s.requestId}):`,o.message)}return t.json({success:!0,message:"Redemption queued successfully",data:{requestId:s.requestId,status:i?"processing":"pending",txHash:i}},201)}catch(s){console.error("Redeem Logic Error:",s);let i=s.message==="Insufficient points"||s.message==="Reward Item not found";return t.json({success:!1,message:s.message||"Internal Server Error"},i?400:500)}});var Ad=Jt.object({userId:Jt.string().uuid()});Ir.post("/:id/cancel",Vl("json",Ad),async t=>{let e=t.req.param("id"),{userId:r}=t.req.valid("json");try{return await M.transaction(async n=>{let[s]=await n.select().from(Q).where(_(Q.id,e)).limit(1);if(!s)return t.json({success:!1,message:"Request not found"},404);if(s.userId!==r)return t.json({success:!1,message:"Unauthorized"},403);if(!["pending","processing"].includes(s.status))return t.json({success:!1,message:`Pesanan dengan status "${s.status}" tidak dapat dibatalkan.`},400);await n.update(ee).set({balance:m`${ee.balance} + ${s.pointsUsed}`}).where(_(ee.userId,r));let[o]=await n.insert(Y).values({userId:r,amount:s.pointsUsed,source:"system",reason:"Refund: Pembatalan oleh pengguna"}).returning({id:Y.id});if(!o)throw new Error("Failed to create ledger entry");await n.update(Q).set({status:"cancelled",updatedAt:new Date,metadata:{...s.metadata,cancelledBy:"user",cancelledAt:new Date().toISOString()}}).where(_(Q.id,e));let[a]=await n.select({walletAddress:R.walletAddress}).from(R).where(_(R.id,r)).limit(1);return a?.walletAddress&&ht.logPointsAdded(a.walletAddress,BigInt(s.pointsUsed),"Refund: Cancelled by user").then(async l=>{l?.hash&&(await M.update(Y).set({txHash:l.hash}).where(_(Y.id,o.id)),console.log(`\u2705 Cancel Refund logged on-chain: ${l.hash}`))}).catch(l=>{console.error(`\u26A0\uFE0F Blockchain cancel refund log failed: ${l.message}`)}),t.json({success:!0,message:"Pembatalan berhasil. Poin telah dikembalikan ke saldo Anda."})})}catch(n){return console.error("Cancel Error:",n),t.json({success:!1,message:"Gagal membatalkan pesanan"},500)}});var Hl=Ir;import{zValidator as Nd}from"@hono/zod-validator";import{z as $n}from"zod";var co=new Be,Pd=$n.object({status:$n.enum(["processing","ready","completed","rejected"]),adminWallet:$n.string(),reason:$n.string().optional()}),xd=["completed","cancelled","rejected"];async function Wl(t){if(!t)return!1;let[e]=await M.select().from(R).where(_(R.walletAddress,t)).limit(1);return e&&(e.role==="admin"||e.role==="super_admin")}co.get("/redeem/pending",async t=>{let e=t.req.query("adminWallet");if(!e||!await Wl(e))return t.json({success:!1,message:"Unauthorized"},401);try{let r=await M.select({id:Q.id,userName:R.name,itemName:Ae.name,pointsUsed:Q.pointsUsed,whatsapp:Q.whatsappNumber,status:Q.status,txHash:Q.txHash,createdAt:Q.createdAt}).from(Q).leftJoin(R,_(Q.userId,R.id)).leftJoin(Ae,_(Q.rewardId,Ae.id)).where(m`${Q.status} IN ('pending', 'processing', 'ready')`).orderBy(m`${Q.createdAt} DESC`);return t.json({success:!0,data:r})}catch(r){return console.error("Admin Fetch Error:",r),t.json({success:!1,message:"Failed to fetch requests"},500)}});co.patch("/redeem/:id",Nd("json",Pd),async t=>{let e=t.req.param("id"),{status:r,adminWallet:n,reason:s}=t.req.valid("json");if(!await Wl(n))return t.json({success:!1,message:"Unauthorized"},401);if(r==="rejected"&&!s)return t.json({success:!1,message:"Alasan penolakan wajib diisi"},400);try{return await M.transaction(async i=>{let[o]=await i.select().from(Q).where(_(Q.id,e)).limit(1);if(!o)return t.json({success:!1,message:"Request not found"},404);if(xd.includes(o.status))return t.json({success:!1,message:`Pesanan dengan status "${o.status}" tidak dapat diubah.`},400);if(r==="rejected"){console.log(`\u{1F504} Refunding ${o.pointsUsed} points to user ${o.userId} (Admin Rejection)`),await i.update(ee).set({balance:m`${ee.balance} + ${o.pointsUsed}`}).where(_(ee.userId,o.userId));let[c]=await i.insert(Y).values({userId:o.userId,amount:o.pointsUsed,source:"admin",reason:`Refund: Ditolak Admin - ${s}`,createdAt:new Date}).returning({id:Y.id});if(!c)throw new Error("Failed to create ledger entry");let[d]=await i.select({walletAddress:R.walletAddress}).from(R).where(_(R.id,o.userId)).limit(1);d?.walletAddress&&ht.logPointsAdded(d.walletAddress,BigInt(o.pointsUsed),`Refund: Rejected - ${s}`).then(async h=>{h?.hash&&(await M.update(Y).set({txHash:h.hash}).where(_(Y.id,c.id)),console.log(`\u2705 Refund logged on-chain: ${h.hash}`))}).catch(h=>{console.error(`\u26A0\uFE0F Blockchain refund log failed: ${h.message}`)})}let a={...o.metadata,...r==="rejected"?{rejectedReason:s,rejectedAt:new Date().toISOString(),rejectedBy:"admin"}:{}};await i.update(Q).set({status:r,updatedAt:new Date,metadata:a}).where(_(Q.id,e));let l=r==="rejected"?"Permintaan ditolak. Poin telah dikembalikan ke nasabah.":`Status diperbarui ke ${r}`;return t.json({success:!0,message:l})})}catch(i){return console.error("Admin Update Error:",i),t.json({success:!1,message:"Failed to process update"},500)}});var Jl=co;var uo=new Be;uo.get("/summary",async t=>{let e=t.req.query("walletAddress");if(!e)return t.json({error:"walletAddress is required"},400);try{let r=await En.calculateWealthProfileByWallet(e);return t.json(r)}catch(r){return t.json({error:r.message},500)}});uo.post("/simulate-deposit",async t=>{let{userId:e,amount:r}=await t.req.json(),n=await M.query.fiatAccounts.findFirst({where:_(vt.userId,e)});if(n){let s=parseFloat(n.balance)+r;await M.update(vt).set({balance:s.toString()}).where(_(vt.userId,e))}else await M.insert(vt).values({userId:e,balance:r.toString(),currency:"IDR"});return t.json({message:"Deposit success",amount:r})});var Gl=uo;var fo=new Be;fo.get("/estimate",async t=>{let e=t.req.query("walletAddress");return t.json({message:"Use Wealth Aggregator to estimate locally for now"})});fo.post("/reset-claim",async t=>{let{walletAddress:e}=await t.req.json();if(!e)return t.json({error:"Wallet address required"},400);let r=await M.query.users.findFirst({where:_(R.walletAddress,e)});if(!r)return t.json({error:"User not found"},404);let n=new Date().toISOString().split("T")[0]??"";return await M.delete(ft).where(dt(_(ft.userId,r.id),_(ft.date,n))),t.json({success:!0,message:`Reset yield for ${r.email}`})});var Yl=fo;var Ze=new Be;console.log(`\u{1F680} API STARTED AT: ${new Date().toISOString()}`);Ze.use("*",Wo());Ze.use("*",Jo());Ze.get("/",t=>t.text("TRISULA API Orchestrator v1.0.0 (Bun Runtime)"));Ze.route("/api/v1/auth",Ml);Ze.route("/api/v1/user",Kl);Ze.route("/api/v1/redeem",Hl);Ze.route("/api/v1/admin",Jl);Ze.route("/api/v1/wealth",Gl);Ze.route("/api/v1/rewards",Yl);Ze.onError((t,e)=>(console.error(`${t}`),e.json({success:!1,message:"Internal Server Error"},500)));var Xl=Ze;var fv=In(Xl);export{fv as default};
